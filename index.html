<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>NAS | Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© V8.2</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b1120" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { cairo: ["Cairo", "sans-serif"] }
        }
      }
    };
  </script>

  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <!-- QR Ø¯Ø§Ø®Ù„ Ø§Ù„ÙˆØµÙ„ -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

  <style>
    :root{
      --bg:#0b1120;
      --panel:rgba(30, 41, 59, 0.68);
      --border:rgba(255,255,255,0.10);
      --muted:#94a3b8;
      --text:#e2e8f0;
      --blue:#3b82f6;
      --green:#22c55e;
      --red:#ef4444;
      --orange:#f59e0b;
    }

    html, body { height: 100%; }
    body {
      font-family: 'Cairo', sans-serif;
      background: radial-gradient(1200px 600px at 70% -10%, rgba(59,130,246,.20), transparent 60%),
                  radial-gradient(900px 500px at 10% 10%, rgba(245,158,11,.12), transparent 55%),
                  var(--bg);
      color: var(--text);
      overflow-x: hidden;
    }

    /* Glass */
    .glass{
      background: var(--panel);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      border: 1px solid var(--border);
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
    }

    /* Tabs */
    .tab-btn{
      transition: .25s ease;
      border-bottom: 3px solid transparent;
      opacity: .55;
    }
    .tab-btn.active{
      opacity: 1;
      border-color: var(--blue);
      color: var(--blue);
    }

    /* Inputs */
    .input-field{
      background: rgba(30, 41, 59, 0.85);
      border: 1px solid rgba(148,163,184,0.25);
      color: white;
      border-radius: 16px;
      padding: 12px 14px;
      width: 100%;
      outline: none;
      transition: .2s ease;
    }
    .input-field:focus{
      border-color: rgba(59,130,246,.7);
      box-shadow: 0 0 0 4px rgba(59,130,246,.12);
    }

    /* Cards */
    .stat-card{
      background: rgba(15,23,42,.65);
      border: 1px solid rgba(148,163,184,0.18);
      border-radius: 22px;
      padding: 14px;
    }

    /* Chips */
    .chip{
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 10px 12px;
      border-radius: 16px;
      background: rgba(30,41,59,.8);
      border: 1px solid rgba(148,163,184,.22);
      font-weight: 800;
      font-size: 11px;
      transition: .2s ease;
      user-select: none;
      cursor: pointer;
    }
    .chip.active{
      border-color: rgba(59,130,246,.9);
      box-shadow: 0 0 0 4px rgba(59,130,246,.12);
    }

    /* Section animation */
    .section-enter{
      animation: fadeUp .22s ease-out;
    }
    @keyframes fadeUp{
      from{ transform: translateY(10px); opacity: 0; }
      to{ transform: translateY(0); opacity: 1; }
    }

    /* Scrollbar */
    ::-webkit-scrollbar{ width: 10px; }
    ::-webkit-scrollbar-thumb{ background: rgba(148,163,184,.22); border-radius: 14px; }
    ::-webkit-scrollbar-track{ background: rgba(15,23,42,.45); }

    @media (prefers-reduced-motion: reduce){
      .section-enter, .tab-btn, .chip, .input-field { animation: none !important; transition: none !important; }
    }
  </style>
</head>

<body class="pb-28 font-cairo">

  <!-- Top Nav -->
  <nav id="topNav" class="flex bg-slate-900/80 border-b border-slate-800 sticky top-0 z-50 shadow-2xl backdrop-blur-xl">
    <button data-sec="home" id="btn-home" class="tab-btn active flex-1 p-4 font-black text-xs text-center">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
    <button data-sec="add" id="btn-add" class="tab-btn flex-1 p-4 font-black text-xs text-center">â• Ø¥Ø¶Ø§ÙØ©</button>
    <button data-sec="list" id="btn-list" class="tab-btn flex-1 p-4 font-black text-xs text-center">ğŸ” Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</button>
    <button data-sec="tools" id="btn-tools" class="tab-btn flex-1 p-4 font-black text-xs text-center">ğŸ§° Ø£Ø¯ÙˆØ§Øª</button>
  </nav>

  <main class="p-4 max-w-3xl mx-auto space-y-6">

    <!-- HOME -->
    <section id="sec-home" class="space-y-6 section-enter">
      <div class="glass p-6 rounded-[2.75rem]">
        <div class="flex items-start justify-between gap-3 mb-5">
          <div>
            <h1 class="text-3xl font-black text-blue-400 leading-tight">NAS</h1>
            <p class="text-xs text-slate-400 font-bold">Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© â€¢ V8.2</p>
          </div>
          <div class="text-left">
            <p class="text-[10px] text-slate-400 font-black">Ø§Ù„ØªØ§Ø±ÙŠØ®</p>
            <p id="todayLabel" class="text-sm font-black"></p>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div class="stat-card">
            <p class="text-[10px] text-slate-400 font-black mb-2">âœ… Ù…Ø´ØªØ±ÙƒÙŠÙ† ÙØ¹Ù‘Ø§Ù„ÙŠÙ†</p>
            <p class="text-2xl font-black text-green-400" id="k-active">0</p>
            <p class="text-[10px] text-slate-500 font-bold mt-1">ØºÙŠØ± Ù…Ø¤Ø±Ø´Ù + ØºÙŠØ± Ù…Ù†ØªÙ‡ÙŠ</p>
          </div>
          <div class="stat-card">
            <p class="text-[10px] text-slate-400 font-black mb-2">â³ ÙŠÙ†ØªÙ‡ÙŠ Ø®Ù„Ø§Ù„ 7 Ø£ÙŠØ§Ù…</p>
            <p class="text-2xl font-black text-orange-400" id="k-due7">0</p>
            <p class="text-[10px] text-slate-500 font-bold mt-1">ØªÙ†Ø¨ÙŠÙ‡ Ù…Ø¨ÙƒØ± Ù„Ù„ØªØ¬Ø¯ÙŠØ¯</p>
          </div>
          <div class="stat-card">
            <p class="text-[10px] text-slate-400 font-black mb-2">âš ï¸ Ù…Ù†ØªÙ‡ÙŠØ©</p>
            <p class="text-2xl font-black text-red-400" id="k-expired">0</p>
            <p class="text-[10px] text-slate-500 font-bold mt-1">ØªØ­ØªØ§Ø¬ Ù…ØªØ§Ø¨Ø¹Ø©</p>
          </div>
          <div class="stat-card">
            <p class="text-[10px] text-slate-400 font-black mb-2">ğŸ”´ Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¯ÙŠÙˆÙ†</p>
            <p class="text-2xl font-black text-red-300" id="k-totalDebt">0</p>
            <p class="text-[10px] text-slate-500 font-bold mt-1">Ø­Ø³Ø¨ Ø¯ÙØªØ± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</p>
          </div>
        </div>
      </div>

      <div class="space-y-3">
        <h2 class="text-lg font-black text-blue-400">ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ© (Ø¯ÙØªØ± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª)</h2>

        <div class="grid grid-cols-1 gap-3">
          <div class="stat-card">
            <p class="text-[10px] text-slate-400 mb-2 font-black">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…</p>
            <div class="flex justify-between">
              <span class="text-green-400 text-xs font-black">ğŸŸ¢ ÙƒØ§Ø´: <b id="d-paid">0</b></span>
              <span class="text-red-400 text-xs font-black">ğŸ”´ Ø¯ÙŠÙˆÙ†: <b id="d-debt">0</b></span>
            </div>
          </div>

          <div class="stat-card">
            <p class="text-[10px] text-slate-400 mb-2 font-black">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</p>
            <div class="flex justify-between">
              <span class="text-green-400 text-xs font-black">ğŸŸ¢ ÙƒØ§Ø´: <b id="w-paid">0</b></span>
              <span class="text-red-400 text-xs font-black">ğŸ”´ Ø¯ÙŠÙˆÙ†: <b id="w-debt">0</b></span>
            </div>
          </div>

          <div class="stat-card border-b-2 border-blue-500">
            <p class="text-[10px] text-slate-400 mb-2 font-black">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</p>
            <div class="flex justify-between">
              <span class="text-green-400 text-sm font-black">ğŸŸ¢ ÙƒØ§Ø´: <b id="m-paid">0</b></span>
              <span class="text-red-400 text-sm font-black">ğŸ”´ Ø¯ÙŠÙˆÙ†: <b id="m-debt">0</b></span>
            </div>
          </div>
        </div>
      </div>

      <div class="glass p-5 rounded-[2.75rem] space-y-3">
        <div class="flex items-center justify-between">
          <h3 class="text-sm font-black text-orange-400">ğŸ”” Ø§Ù„ØªØ¬Ø¯ÙŠØ¯Ø§Øª Ø§Ù„Ù‚Ø±ÙŠØ¨Ø© (Ø§Ù„ÙŠÙˆÙ…/Ø¨Ø§Ú†Ø±/Ù‚Ø±ÙŠØ¨Ø§Ù‹)</h3>
          <button data-go="list" class="text-xs font-black text-blue-300 hover:text-blue-200">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† â†’</button>
        </div>
        <div id="reminder-list" class="space-y-3"></div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div class="glass p-5 rounded-[2.5rem] space-y-3">
          <div class="flex items-center justify-between">
            <h3 class="text-sm font-black text-emerald-300">ğŸ† Ø£ÙØ¶Ù„ Ø§Ù„Ø®Ø¯Ù…Ø§Øª</h3>
            <span class="text-[10px] text-slate-500 font-black">Ø­Ø³Ø¨ Ø¯ÙØªØ± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</span>
          </div>
          <div id="top-services" class="space-y-2"></div>
        </div>

        <div class="glass p-5 rounded-[2.5rem] space-y-3">
          <div class="flex items-center justify-between">
            <h3 class="text-sm font-black text-blue-300">ğŸ“ˆ Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø¢Ø®Ø± 6 Ø£Ø´Ù‡Ø±</h3>
            <span class="text-[10px] text-slate-500 font-black">ÙƒØ§Ø´ ÙÙ‚Ø·</span>
          </div>
          <div id="month-chart" class="space-y-2"></div>
        </div>
      </div>
    </section>

    <!-- ADD -->
    <section id="sec-add" class="hidden space-y-4 section-enter">
      <div class="glass p-6 rounded-[2.75rem] space-y-4">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-black text-blue-400">â• Ø¥Ø¶Ø§ÙØ© / ØªØ­Ø¯ÙŠØ« Ù…Ø´ØªØ±Ùƒ</h2>
          <button id="resetFormBtn" class="text-xs font-black text-slate-300 hover:text-white">ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
        </div>

        <input id="name" class="input-field" placeholder="Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ† Ø§Ù„ÙƒØ§Ù…Ù„ *">

        <div class="grid grid-cols-2 gap-2">
          <input id="phone" type="tel" class="input-field" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ù…Ø«Ø§Ù„: 77XXXXXXXX)">
          <input id="price" type="number" class="input-field" placeholder="Ø§Ù„Ø³Ø¹Ø± (Ø¯.Ø¹)">
        </div>

        <div class="grid grid-cols-2 gap-2">
          <select id="service-select" class="input-field">
            <option value="Canva Pro">Canva Pro</option>
            <option value="ChatGPT">ChatGPT</option>
            <option value="CapCut">CapCut</option>
            <option value="YouTube Premium">YouTube Premium</option>
            <option value="Netflix">Netflix</option>
            <option value="Spotify">Spotify</option>
            <option value="Office 365">Office 365</option>
            <option value="CUSTOM">Ø£Ø®Ø±Ù‰ +</option>
          </select>
          <input id="insta" class="input-field" placeholder="ÙŠÙˆØ²Ø± Ø§Ù†Ø³ØªØºØ±Ø§Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
        </div>

        <div id="customServiceWrap" class="hidden">
          <input id="service-custom" class="input-field" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø®Ø¯Ù…Ø© (Ù…Ø«Ø§Ù„: VPN / Adobe / ...)" />
          <p class="text-[10px] text-slate-500 font-bold mt-2">Ø±Ø§Ø­ ØªÙØ­ÙØ¸ Ø¨Ø§Ø³Ù… Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ù„ÙŠ ØªÙƒØªØ¨Ù‡Ø§ Ù‡Ù†Ø§.</p>
        </div>

        <div class="glass p-4 rounded-3xl space-y-3 border border-slate-700/50">
          <p class="text-xs font-black text-slate-200">â±ï¸ Ù…Ø¯Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ + ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ *</p>
          <div id="durBtns" class="grid grid-cols-2 gap-2">
            <button class="chip active" data-days="30" data-type="Ø´Ù‡Ø±ÙŠ">ğŸ“… Ø´Ù‡Ø±ÙŠ (30 ÙŠÙˆÙ…)</button>
            <button class="chip" data-days="365" data-type="Ø³Ù†ÙˆÙŠ">ğŸŒŸ Ø³Ù†ÙˆÙŠ (365 ÙŠÙˆÙ…)</button>
          </div>
          <input type="date" id="expDate" class="input-field">
          <p class="text-[10px] text-slate-500 font-bold">Ù†ØµÙŠØ­Ø©: Ø¥Ø°Ø§ ØªØ±ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ù…Ø®ØµØµØŒ ØºÙŠÙ‘Ø±Ù‡ ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ù…Ù† Ø­Ù‚Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ®.</p>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <button id="p-true" class="chip active border-green-500/60">âœ… Ù…Ø¯ÙÙˆØ¹</button>
          <button id="p-false" class="chip border-red-500/60">âŒ Ø¯ÙŠÙ†</button>
        </div>

        <textarea id="notes" class="input-field" rows="3" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¯Ø§Ø®Ù„ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ): Ù…Ø«Ø§Ù„: Ø²Ø¨ÙˆÙ† Ø¯Ø§Ø¦Ù… / Ø®ØµÙ… / ..."></textarea>

        <div class="grid grid-cols-2 gap-2">
          <button id="mainBtn" class="w-full bg-blue-600 hover:bg-blue-500 p-4 rounded-2xl font-black shadow-lg">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
          <button id="saveAndReceiptBtn" class="w-full bg-white text-slate-900 hover:bg-slate-100 p-4 rounded-2xl font-black shadow-lg">ğŸ“„ Ø­ÙØ¸ + ÙˆØµÙ„</button>
        </div>

        <p class="text-[10px] text-slate-500 font-bold">
          âœ… Ù…Ù„Ø§Ø­Ø¸Ø© Ù…Ù‡Ù…Ø©: Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† Ø§Ù„Ù‚Ø¯Ø§Ù…Ù‰ Ù…Ø­ÙÙˆØ¸Ø© Ù„Ø£Ù†Ù†Ø§ Ù„Ù… Ù†ØºÙŠÙ‘Ø± Ù…ÙØªØ§Ø­ Ø§Ù„ØªØ®Ø²ÙŠÙ† (DB Key).
        </p>
      </div>
    </section>

    <!-- LIST -->
    <section id="sec-list" class="hidden space-y-4 section-enter">
      <div class="glass p-5 rounded-[2.75rem] space-y-4">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-black text-blue-400">ğŸ” Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</h2>
          <p class="text-[10px] text-slate-500 font-black">Ù†ØªØ§Ø¦Ø¬: <span id="listCount">0</span></p>
        </div>

        <input id="search" class="input-field" placeholder="ğŸ” Ø¨Ø­Ø«: Ø§Ù„Ø§Ø³Ù… / Ø§Ù„Ø±Ù‚Ù… / Ø§Ù„Ø®Ø¯Ù…Ø© / Ø§Ù„Ø§Ù†Ø³ØªØ§ ...">

        <div class="space-y-2">
          <p class="text-[10px] text-slate-400 font-black">ÙÙ„ØªØ±Ø© Ø§Ù„Ù†ÙˆØ¹</p>
          <div id="typeFilters" class="flex flex-wrap gap-2">
            <button class="chip active" data-typefilter="Ø´Ù‡Ø±ÙŠ">ğŸ“… Ø´Ù‡Ø±ÙŠ</button>
            <button class="chip" data-typefilter="Ø³Ù†ÙˆÙŠ">ğŸŒŸ Ø³Ù†ÙˆÙŠ</button>
            <button class="chip" data-typefilter="Ø§Ù„ÙƒÙ„">âœ¨ Ø§Ù„ÙƒÙ„</button>
          </div>
        </div>

        <div class="space-y-2">
          <p class="text-[10px] text-slate-400 font-black">ÙÙ„ØªØ±Ø© Ø§Ù„Ø­Ø§Ù„Ø©</p>
          <div id="statusFilters" class="flex flex-wrap gap-2">
            <button class="chip active" data-status="all">Ø§Ù„ÙƒÙ„</button>
            <button class="chip" data-status="paid">âœ… Ù…Ø¯ÙÙˆØ¹</button>
            <button class="chip" data-status="debt">âŒ Ø¯ÙŠÙ†</button>
            <button class="chip" data-status="due7">â³ ÙŠÙ†ØªÙ‡ÙŠ Ù‚Ø±ÙŠØ¨Ù‹Ø§</button>
            <button class="chip" data-status="expired">âš ï¸ Ù…Ù†ØªÙ‡ÙŠ</button>
            <button class="chip" data-status="archived">ğŸ—ƒï¸ Ù…Ø¤Ø±Ø´Ù</button>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <select id="sortMode" class="input-field">
            <option value="endAsc">Ø§Ù„Ø£Ù‚Ø±Ø¨ Ø§Ù†ØªÙ‡Ø§Ø¡Ù‹</option>
            <option value="endDesc">Ø§Ù„Ø£Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡Ù‹</option>
            <option value="recent">Ø§Ù„Ø£Ø­Ø¯Ø« Ø¥Ø¶Ø§ÙØ©/ØªØ¬Ø¯ÙŠØ¯</option>
            <option value="name">Ø§Ù„Ø§Ø³Ù… (Ø£Ø¨Ø¬Ø¯ÙŠ)</option>
          </select>
          <button id="quickHomeBtn" class="chip">ğŸ  Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        </div>
      </div>

      <div id="main-list" class="space-y-3"></div>
    </section>

    <!-- TOOLS -->
    <section id="sec-tools" class="hidden space-y-4 section-enter">
      <div class="glass p-6 rounded-[2.75rem] space-y-4">
        <h2 class="text-lg font-black text-blue-400">ğŸ§° Ø£Ø¯ÙˆØ§Øª Ù‚ÙˆÙŠØ© (Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ + Ø§Ø³ØªÙŠØ±Ø§Ø¯ + Ø£Ø±Ø´ÙŠÙ)</h2>

        <div class="grid grid-cols-2 gap-2">
          <button id="exportBtn" class="chip">â¬‡ï¸ ØªØµØ¯ÙŠØ± Ù†Ø³Ø®Ø© JSON</button>
          <button id="exportCsvBtn" class="chip">ğŸ“„ ØªØµØ¯ÙŠØ± CSV (Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª)</button>
        </div>

        <div class="glass p-4 rounded-3xl border border-slate-700/50 space-y-3">
          <p class="text-xs font-black text-slate-200">â¬†ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù†Ø³Ø®Ø© JSON (Ø¯Ù…Ø¬ Ø¨Ø¯ÙˆÙ† Ø­Ø°Ù)</p>
          <input id="importFile" type="file" accept=".json,application/json" class="input-field">
          <p class="text-[10px] text-slate-500 font-bold">
            Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù‡Ù†Ø§ â€œÙŠØ¶ÙŠÙâ€ Ø¨Ø¯ÙˆÙ† Ù…Ø§ ÙŠÙ…Ø³Ø­. Ø¥Ø°Ø§ Ù†ÙØ³ Ø§Ù„Ù€ id Ù…ÙˆØ¬ÙˆØ¯ Ø±Ø§Ø­ ÙŠØªØ¬Ø§ÙˆØ² Ø­ØªÙ‰ Ù…Ø§ ÙŠÙƒØ±Ø±.
          </p>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <button id="resetContactBtn" class="chip">ğŸ”” ØªØµÙÙŠØ± Ø³Ø¬Ù„ Ø§Ù„ØªØ°ÙƒÙŠØ± (Ø§Ù„ÙŠÙˆÙ…)</button>
          <button id="runRepairBtn" class="chip">ğŸ› ï¸ Ø¥ØµÙ„Ø§Ø­/ØªØ±Ø­ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        </div>

        <div class="glass p-5 rounded-[2.5rem] space-y-3 border border-slate-700/50">
          <div class="flex items-center justify-between">
            <p class="text-sm font-black text-slate-200">ğŸ—ƒï¸ Ø§Ù„Ø£Ø±Ø´ÙŠÙ</p>
            <p class="text-[10px] text-slate-500 font-black">Ø¹Ø¯Ø¯: <span id="archivedCount">0</span></p>
          </div>
          <div id="archive-list" class="space-y-3"></div>
        </div>

        <p class="text-[10px] text-slate-500 font-bold">
          âœ… Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ù†Ø³Ø®Ø©: Ù…Ø§ÙƒÙˆ â€œØ­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠâ€ Ø¨Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØ©. ÙƒÙ„ Ø´ÙŠØ¡ ÙŠØ±ÙˆØ­ Ø£Ø±Ø´ÙŠÙ.
        </p>
      </div>
    </section>

  </main>

  <!-- Floating Add Button -->
  <button id="fabAdd"
          class="fixed bottom-6 right-6 w-14 h-14 rounded-2xl bg-blue-600 shadow-2xl font-black text-2xl z-50 hover:bg-blue-500 active:scale-95 transition"
          title="Ø¥Ø¶Ø§ÙØ©">
    +
  </button>

  <!-- Receipt Modal -->
  <div id="receiptModal" class="fixed inset-0 bg-black/95 hidden z-[60] flex items-center justify-center p-4">
    <div class="w-full max-w-sm">
      <div id="printableReceipt" class="bg-white p-6 rounded-[2.5rem] text-slate-900 shadow-2xl text-right relative overflow-hidden">
        <div class="absolute top-0 right-0 w-24 h-24 bg-blue-50 rounded-full -mr-12 -mt-12"></div>
        <h3 class="text-4xl font-black text-blue-600 italic text-center mb-2">NAS</h3>
        <p class="text-center text-[10px] font-black opacity-50 mb-4">ÙˆØµÙ„ Ø§Ø´ØªØ±Ø§Ùƒ / Subscription Receipt</p>

        <div class="space-y-3 border-y border-slate-100 py-5 font-bold text-sm">
          <div class="flex justify-between"><span>Ø§Ù„Ø²Ø¨ÙˆÙ†:</span> <span id="rName"></span></div>
          <div class="flex justify-between"><span>Ø§Ù„Ø®Ø¯Ù…Ø©:</span> <span id="rService"></span></div>
          <div class="flex justify-between"><span>Ø§Ù„Ø³Ø¹Ø±:</span> <span id="rPrice"></span></div>
          <div class="flex justify-between"><span>Ø§Ù„Ø­Ø§Ù„Ø©:</span> <span id="rPaid"></span></div>
          <div class="flex justify-between"><span>ÙŠÙ†ØªÙ‡ÙŠ ÙÙŠ:</span> <span id="rEnd" class="text-red-500"></span></div>
          <div class="flex justify-between"><span>Ø§Ù„ØªØ§Ø±ÙŠØ®:</span> <span id="rAt" class="text-slate-700"></span></div>
        </div>

        <div class="mt-4 flex items-center justify-between gap-3">
          <div>
            <p class="text-[10px] font-black opacity-60">QR Ù„Ù„ØªØ­Ù‚Ù‚</p>
            <div id="qrBox" class="mt-2"></div>
          </div>
          <div class="text-left">
            <p class="text-[10px] font-black opacity-40">L11NL</p>
            <p class="text-[10px] font-black opacity-40">NAS â€¢ V8.2</p>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 gap-2 mt-4">
        <button id="shareReceiptBtn" class="bg-blue-600 text-white p-3 rounded-xl font-black">ğŸ“¤ Ù…Ø´Ø§Ø±ÙƒØ© ÙƒØµÙˆØ±Ø©</button>
        <button id="closeReceiptBtn" class="text-slate-400 text-xs py-2 font-black">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
  </div>

  <!-- Renew Modal -->
  <div id="renewModal" class="fixed inset-0 bg-black/95 hidden z-[70] flex items-center justify-center p-4">
    <div class="w-full max-w-md glass p-6 rounded-[2.75rem] space-y-4">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-black text-orange-300">âš¡ ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</h3>
        <button id="closeRenewBtn" class="text-slate-300 font-black text-sm">âœ•</button>
      </div>

      <div class="stat-card">
        <p class="text-[10px] text-slate-400 font-black mb-2">Ø§Ù„Ù…Ø´ØªØ±Ùƒ</p>
        <p class="text-sm font-black" id="renewName">-</p>
        <p class="text-[10px] text-blue-300 font-black mt-1" id="renewService">-</p>
      </div>

      <div class="grid grid-cols-2 gap-2">
        <button id="renewMon" class="chip active" data-rdays="30">ğŸ“… ØªØ¬Ø¯ÙŠØ¯ Ø´Ù‡Ø±ÙŠ</button>
        <button id="renewYear" class="chip" data-rdays="365">ğŸŒŸ ØªØ¬Ø¯ÙŠØ¯ Ø³Ù†ÙˆÙŠ</button>
      </div>

      <div class="grid grid-cols-2 gap-2">
        <input id="renewPrice" type="number" class="input-field" placeholder="Ø§Ù„Ø³Ø¹Ø± (Ø¯.Ø¹)">
        <input id="renewEnd" type="date" class="input-field">
      </div>

      <div class="grid grid-cols-2 gap-2">
        <button id="renewPaidBtn" class="chip active border-green-500/60">âœ… Ù…Ø¯ÙÙˆØ¹</button>
        <button id="renewDebtBtn" class="chip border-red-500/60">âŒ Ø¯ÙŠÙ†</button>
      </div>

      <button id="confirmRenewBtn" class="w-full bg-orange-600 hover:bg-orange-500 p-4 rounded-2xl font-black shadow-lg">
        âœ… ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ¬Ø¯ÙŠØ¯
      </button>

      <p class="text-[10px] text-slate-500 font-bold">
        Ø§Ù„ØªØ¬Ø¯ÙŠØ¯ Ù‡Ù†Ø§ ÙŠØ³Ø¬Ù‘Ù„ Ø¹Ù…Ù„ÙŠØ© Ø¯Ø§Ø®Ù„ Ø¯ÙØªØ± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø­ØªÙ‰ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ØªØµÙŠØ± Ø¯Ù‚ÙŠÙ‚Ø© Ø¬Ø¯Ù‹Ø§.
      </p>
    </div>
  </div>

  <!-- Toast Host -->
  <div id="toastHost" class="fixed bottom-6 left-1/2 -translate-x-1/2 z-[80] space-y-2 w-[92%] max-w-md"></div>

<script>
/* =========================
   NAS V8.2 (No Deletion Upgrade)
   ========================= */

  // âœ… Ù„Ø§ ØªØºÙŠÙ‘Ø± Ù‡Ø°Ø§ Ø§Ù„Ù…ÙØªØ§Ø­ Ø­ØªÙ‰ Ù„Ø§ ØªØ¶ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯Ø§Ù…Ù‰
  const DB = "NAS_STABLE_V5_DATA";
  const LEDGER_KEY = "NAS_LEDGER_V1";
  const META_KEY = "NAS_META_V82";
  const CONTACT_KEY = "NAS_CONTACTED"; // Ø£Ø¨Ù‚ÙŠÙ†Ø§Ù‡ Ø­ØªÙ‰ Ù„Ø§ Ù†Ø®Ø±Ø¨ Ø§Ù„Ù‚Ø¯ÙŠÙ…

  const $ = (id) => document.getElementById(id);

  const state = {
    clients: [],
    ledger: [],
    meta: { version: "8.2", migratedAt: null, backupKey: null },

    // UI state
    sec: "home",
    typeFilter: "Ø´Ù‡Ø±ÙŠ",
    statusFilter: "all",
    sortMode: "endAsc",
    q: "",

    // Add form
    editId: null,
    currentPaid: true,
    currentType: "Ø´Ù‡Ø±ÙŠ",

    // Renew
    renewId: null,
    renewPaid: true,
    renewDays: 30,

    // Contact store
    contacted: { date: "", keys: [] },
  };

  /* -------- Helpers -------- */

  function uid(){
    try{
      if (crypto && crypto.randomUUID) return crypto.randomUUID();
    }catch(e){}
    return "id-" + Date.now().toString(36) + "-" + Math.random().toString(36).slice(2,9);
  }

  function loadJSON(key, fallback){
    try{
      const raw = localStorage.getItem(key);
      if (!raw) return fallback;
      return JSON.parse(raw);
    }catch(e){
      return fallback;
    }
  }

  function saveJSON(key, value){
    localStorage.setItem(key, JSON.stringify(value));
  }

  // âœ… ØªØ§Ø±ÙŠØ® Ù…Ø­Ù„ÙŠ (Ø¨Ø¯ÙˆÙ† Ù…Ø´ÙƒÙ„Ø© UTC)
  function isoDateLocal(d = new Date()){
    const x = new Date(d.getTime() - d.getTimezoneOffset() * 60000);
    return x.toISOString().split("T")[0];
  }

  function parseISODate(iso){
    if (!iso || typeof iso !== "string") return null;
    const parts = iso.split("-").map(Number);
    if (parts.length !== 3) return null;
    const [y,m,dd] = parts;
    if (!y || !m || !dd) return null;
    return new Date(y, m-1, dd);
  }

  function startOfDay(d){
    return new Date(d.getFullYear(), d.getMonth(), d.getDate());
  }

  function daysLeft(endIso){
    const end = parseISODate(endIso);
    if (!end) return null;
    const t = startOfDay(new Date());
    const e = startOfDay(end);
    return Math.round((e - t) / (1000*60*60*24));
  }

  function addDaysToISO(baseIso, days){
    const base = parseISODate(baseIso) || new Date();
    base.setDate(base.getDate() + Number(days || 0));
    return isoDateLocal(base);
  }

  function formatMoney(n){
    return (Number(n || 0)).toLocaleString("en-US");
  }

  function esc(s){
    return (s ?? "").toString().replace(/[&<>"']/g, (c) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  function normalizePhone(phone){
    let p = (phone || "").toString().trim();
    p = p.replace(/[^\d]/g, "");
    if (p.startsWith("964")) p = p.slice(3);
    p = p.replace(/^0+/, "");
    return p;
  }

  function normalizeInsta(u){
    let s = (u || "").toString().trim();
    s = s.replace(/^https?:\/\/(www\.)?instagram\.com\//, "");
    s = s.replace(/^@/, "");
    s = s.split(/[/?#]/)[0];
    return s;
  }

  function waUrl(phone, text){
    const p = normalizePhone(phone);
    if (!p) return "#";
    const base = `https://wa.me/964${p}`;
    if (!text) return base;
    return `${base}?text=${encodeURIComponent(text)}`;
  }

  function instaUrl(user){
    const u = normalizeInsta(user);
    if (!u) return "#";
    return `https://instagram.com/${encodeURIComponent(u)}`;
  }

  function vibrate(ms=15){
    try{ if (navigator.vibrate) navigator.vibrate(ms); }catch(e){}
  }

  function toast(message, kind="info"){
    const host = $("toastHost");
    const id = uid();
    const bg =
      kind === "ok" ? "bg-emerald-600" :
      kind === "warn" ? "bg-orange-600" :
      kind === "err" ? "bg-red-600" :
      "bg-slate-800";

    const el = document.createElement("div");
    el.id = id;
    el.className = `${bg} text-white p-4 rounded-2xl shadow-2xl border border-white/10`;
    el.innerHTML = `
      <div class="flex items-start justify-between gap-3">
        <p class="text-sm font-black leading-relaxed">${esc(message)}</p>
        <button class="text-white/80 font-black" data-close-toast="${id}">âœ•</button>
      </div>
    `;
    host.appendChild(el);

    setTimeout(() => {
      const node = $(id);
      if (node) node.remove();
    }, 3200);
  }

  /* -------- Data Migration (No deletion) -------- */

  function makeBackupIfNeeded(rawString){
    if (!rawString) return;
    state.meta = loadJSON(META_KEY, state.meta);

    if (state.meta.backupKey) return; // Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
    try{
      const key = "NAS_BACKUP_" + new Date().toISOString().replaceAll(":","-");
      // Ø§Ù†ØªØ¨Ù‡ Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ† - Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¯Ø§ØªØ§ Ø¶Ø®Ù…Ø© Ø¬Ø¯Ù‹Ø§ Ù„Ø§ Ù†Ø®Ø²Ù†Ù‡Ø§ Ù…Ø±ØªÙŠÙ†
      if (rawString.length < 2_000_000){
        localStorage.setItem(key, rawString);
        state.meta.backupKey = key;
        saveJSON(META_KEY, state.meta);
      }
    }catch(e){}
  }

  function migrateClients(){
    const raw = localStorage.getItem(DB);
    makeBackupIfNeeded(raw);

    let clients = [];
    try{
      clients = JSON.parse(raw) || [];
    }catch(e){
      clients = [];
    }
    if (!Array.isArray(clients)) clients = [];

    const nowISO = new Date().toISOString();

    clients = clients.map((c) => {
      const obj = (c && typeof c === "object") ? c : {};

      const id = obj.id || obj.uuid || obj._id || uid();
      const name = (obj.name || "").toString();
      const phone = (obj.phone || "").toString();
      const insta = (obj.insta || "").toString();

      const service = (obj.service || "Canva Pro").toString();
      const price = Number(obj.price) || 0;

      const type = (obj.type || "Ø´Ù‡Ø±ÙŠ").toString();
      const paid = (typeof obj.paid === "boolean") ? obj.paid : true;

      const end = (obj.end || "").toString();
      const created = (obj.created || obj.createdAt || nowISO).toString();

      const archived = Boolean(obj.archived);
      const archivedAt = obj.archivedAt ? obj.archivedAt : (archived ? nowISO : null);

      return {
        ...obj,
        id, name, phone, insta,
        service, price,
        type, paid,
        end, created,
        updatedAt: obj.updatedAt || null,
        lastPaymentAt: obj.lastPaymentAt || null,
        notes: obj.notes || "",
        archived,
        archivedAt
      };
    });

    // Ø­ÙØ¸ Ø§Ù„ØªØ±Ø­ÙŠÙ„ (Ø¨Ø¯ÙˆÙ† Ø­Ø°Ù Ø£ÙŠ Ø£Ø­Ø¯)
    saveJSON(DB, clients);

    state.clients = clients;
    state.meta = loadJSON(META_KEY, state.meta);
    state.meta.migratedAt = state.meta.migratedAt || new Date().toISOString();
    saveJSON(META_KEY, state.meta);
  }

  function migrateLedger(){
    let ledger = loadJSON(LEDGER_KEY, []);
    if (!Array.isArray(ledger)) ledger = [];

    // Ø¥Ø°Ø§ Ù…Ø§ÙƒÙˆ Ø¯ÙØªØ± Ø¹Ù…Ù„ÙŠØ§Øª -> Ù†Ø³ÙˆÙŠÙ‡ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯Ø§Ù…Ù‰ (Ø­ØªÙ‰ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ØªØ´ØªØºÙ„)
    if (ledger.length === 0 && state.clients.length){
      ledger = state.clients.map((c) => ({
        id: uid(),
        clientId: c.id,
        name: c.name,
        service: c.service,
        type: c.type || "Ø´Ù‡Ø±ÙŠ",
        price: Number(c.price) || 0,
        paid: !!c.paid,
        end: c.end || "",
        at: c.created || new Date().toISOString()
      }));
      saveJSON(LEDGER_KEY, ledger);
    }

    state.ledger = ledger;
  }

  function loadContactStore(){
    const today = isoDateLocal(new Date());
    const raw = loadJSON(CONTACT_KEY, null);

    // Ù‚Ø¯ÙŠÙ…: ÙƒØ§Ù† array ÙÙ‚Ø·
    if (Array.isArray(raw)){
      return { date: today, keys: raw };
    }

    if (raw && typeof raw === "object"){
      const date = raw.date || today;
      const keys = Array.isArray(raw.keys) ? raw.keys : [];
      if (date !== today) return { date: today, keys: [] };
      return { date, keys };
    }

    return { date: today, keys: [] };
  }

  function saveContactStore(){
    saveJSON(CONTACT_KEY, state.contacted);
  }

  /* -------- UI Navigation -------- */

  function showSection(sec){
    const secs = ["home","add","list","tools"];
    secs.forEach(s => {
      const box = $("sec-"+s);
      const btn = $("btn-"+s);
      box.classList.add("hidden");
      btn.classList.remove("active");
    });

    $("sec-"+sec).classList.remove("hidden");
    $("btn-"+sec).classList.add("active");

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø­Ø±ÙƒØ© Ø¨Ø³ÙŠØ·Ø©
    $("sec-"+sec).classList.remove("section-enter");
    void $("sec-"+sec).offsetWidth;
    $("sec-"+sec).classList.add("section-enter");

    state.sec = sec;

    if (sec === "home") updateHome();
    if (sec === "list") renderList();
    if (sec === "tools") renderTools();
  }

  /* -------- Home Computations -------- */

  function computeLedgerStats(){
    const now = new Date();
    const today = isoDateLocal(now);
    const startWeek = new Date(now.getTime() - 7*24*60*60*1000);
    const month = now.getMonth();
    const year = now.getFullYear();

    let dP=0, dD=0, wP=0, wD=0, mP=0, mD=0, totalDebt=0;

    state.ledger.forEach(tx => {
      const at = new Date(tx.at || Date.now());
      const txDay = isoDateLocal(at);

      if (tx.paid) {
        if (txDay === today) dP += Number(tx.price) || 0;
        if (at >= startWeek) wP += Number(tx.price) || 0;
        if (at.getMonth() === month && at.getFullYear() === year) mP += Number(tx.price) || 0;
      } else {
        totalDebt += Number(tx.price) || 0;
        if (txDay === today) dD += Number(tx.price) || 0;
        if (at >= startWeek) wD += Number(tx.price) || 0;
        if (at.getMonth() === month && at.getFullYear() === year) mD += Number(tx.price) || 0;
      }
    });

    return { dP,dD,wP,wD,mP,mD,totalDebt };
  }

  function computeClientKpis(){
    const today = isoDateLocal(new Date());

    let active=0, due7=0, expired=0;

    state.clients.forEach(c => {
      if (c.archived) return;
      const dl = daysLeft(c.end);
      if (dl === null) return;
      if (dl >= 0) active++;
      if (dl >= 0 && dl <= 7) due7++;
      if (dl < 0) expired++;
    });

    return { active, due7, expired, today };
  }

  function renderTopServices(){
    // top by count (ledger)
    const map = new Map();
    state.ledger.forEach(tx => {
      const s = (tx.service || "Ø®Ø¯Ù…Ø©").toString();
      const prev = map.get(s) || { count: 0, cash: 0 };
      prev.count += 1;
      if (tx.paid) prev.cash += Number(tx.price) || 0;
      map.set(s, prev);
    });

    const arr = [...map.entries()]
      .map(([service, v]) => ({ service, ...v }))
      .sort((a,b) => (b.count - a.count) || (b.cash - a.cash))
      .slice(0, 5);

    const box = $("top-services");
    if (!arr.length){
      box.innerHTML = `<p class="text-xs text-slate-500 font-black text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ©.</p>`;
      return;
    }

    box.innerHTML = arr.map((x, idx) => `
      <div class="flex items-center justify-between bg-slate-900/40 border border-slate-700/40 rounded-2xl p-3">
        <div class="flex items-center gap-2">
          <span class="w-7 h-7 rounded-xl bg-slate-800 flex items-center justify-center text-xs font-black">${idx+1}</span>
          <div>
            <p class="text-xs font-black">${esc(x.service)}</p>
            <p class="text-[10px] text-slate-400 font-bold">Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª: ${x.count}</p>
          </div>
        </div>
        <div class="text-left">
          <p class="text-[10px] text-emerald-300 font-black">ÙƒØ§Ø´: ${formatMoney(x.cash)}</p>
        </div>
      </div>
    `).join("");
  }

  function renderLast6MonthsChart(){
    // Cash only, last 6 months
    const now = new Date();
    const buckets = [];

    for (let i=5; i>=0; i--){
      const d = new Date(now.getFullYear(), now.getMonth()-i, 1);
      buckets.push({
        key: `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`,
        label: d.toLocaleDateString("ar-IQ", { month: "short", year: "numeric" }),
        value: 0
      });
    }

    const map = new Map(buckets.map(b => [b.key, b]));
    state.ledger.forEach(tx => {
      if (!tx.paid) return;
      const at = new Date(tx.at || Date.now());
      const key = `${at.getFullYear()}-${String(at.getMonth()+1).padStart(2,"0")}`;
      if (map.has(key)){
        map.get(key).value += Number(tx.price) || 0;
      }
    });

    const max = Math.max(...buckets.map(b => b.value), 1);
    const box = $("month-chart");

    box.innerHTML = buckets.map(b => {
      const w = Math.round((b.value / max) * 100);
      return `
        <div class="space-y-1">
          <div class="flex items-center justify-between">
            <p class="text-[10px] text-slate-300 font-black">${esc(b.label)}</p>
            <p class="text-[10px] text-slate-400 font-black">${formatMoney(b.value)}</p>
          </div>
          <div class="w-full h-3 rounded-full bg-slate-900/60 border border-slate-700/40 overflow-hidden">
            <div class="h-full rounded-full bg-blue-500" style="width:${w}%; opacity:.9"></div>
          </div>
        </div>
      `;
    }).join("");
  }

  function updateHome(){
    $("todayLabel").innerText = new Date().toLocaleDateString("ar-IQ", { weekday:"long", year:"numeric", month:"long", day:"numeric" });

    const k = computeClientKpis();
    const s = computeLedgerStats();

    $("k-active").innerText = k.active.toLocaleString("en-US");
    $("k-due7").innerText = k.due7.toLocaleString("en-US");
    $("k-expired").innerText = k.expired.toLocaleString("en-US");
    $("k-totalDebt").innerText = formatMoney(s.totalDebt);

    $("d-paid").innerText = formatMoney(s.dP);
    $("d-debt").innerText = formatMoney(s.dD);
    $("w-paid").innerText = formatMoney(s.wP);
    $("w-debt").innerText = formatMoney(s.wD);
    $("m-paid").innerText = formatMoney(s.mP);
    $("m-debt").innerText = formatMoney(s.mD);

    renderReminders();
    renderTopServices();
    renderLast6MonthsChart();
  }

  function reminderCard(c, tagText, tagClass){
    const dl = daysLeft(c.end);
    const phoneOK = normalizePhone(c.phone);
    const msg = `Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ğŸ˜Š\nØ§Ø´ØªØ±Ø§ÙƒÙƒ ${c.type || "Ø´Ù‡Ø±ÙŠ"} (${c.service}) ÙŠÙ†ØªÙ‡ÙŠ ${tagText}.\nØªØ­Ø¨ Ù†Ø¬Ø¯Ø¯ Ù„ÙƒØŸ`;

    return `
      <div class="bg-slate-900/40 border border-slate-700/40 rounded-3xl p-4 flex items-center justify-between gap-3 border-r-4 ${tagClass}">
        <div class="min-w-0">
          <p class="text-xs font-black truncate">${esc(c.name)}</p>
          <p class="text-[10px] text-slate-400 font-bold truncate">${esc(c.service)} â€¢ ${formatMoney(c.price)} Ø¯.Ø¹</p>
          <p class="text-[10px] text-slate-500 font-black mt-1">ÙŠÙ†ØªÙ‡ÙŠ: ${esc(c.end)} â€¢ ${dl === null ? "-" : (dl >=0 ? `Ø¨Ø¹Ø¯ ${dl} ÙŠÙˆÙ…` : `Ù…ØªØ£Ø®Ø± ${Math.abs(dl)} ÙŠÙˆÙ…`)}</p>
        </div>
        <div class="flex flex-col gap-2">
          <button class="chip !text-[10px] !px-3 !py-2 border-orange-500/60"
                  data-action="remind" data-id="${esc(c.id)}" ${phoneOK ? "" : "disabled"}
                  title="${phoneOK ? "" : "Ø£Ø¶Ù Ø±Ù‚Ù… ØµØ­ÙŠØ­ Ø£ÙˆÙ„Ø§Ù‹"}">
            ğŸ”” ØªØ°ÙƒÙŠØ±
          </button>
          <button class="chip !text-[10px] !px-3 !py-2 border-blue-500/60"
                  data-action="renew" data-id="${esc(c.id)}">
            âš¡ ØªØ¬Ø¯ÙŠØ¯
          </button>
        </div>
      </div>
    `;
  }

  function renderReminders(){
    const today = isoDateLocal(new Date());
    const tomorrow = addDaysToISO(today, 1);

    const cstore = state.contacted;

    // keys: Ù†Ø¯Ø¹Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ + Ø§Ù„Ù‚Ø¯ÙŠÙ… (name+end)
    function isContacted(c){
      const keyNew = `${c.id}|${c.end}`;
      const keyOld = `${c.name}${c.end}`;
      return cstore.keys.includes(keyNew) || cstore.keys.includes(keyOld);
    }

    const actives = state.clients.filter(c => !c.archived && c.end);
    const todayEnds = actives.filter(c => c.end === today && !isContacted(c));
    const tomorrowEnds = actives.filter(c => c.end === tomorrow && !isContacted(c));
    const due7 = actives.filter(c => {
      const dl = daysLeft(c.end);
      return dl !== null && dl >= 2 && dl <= 7 && !isContacted(c);
    }).sort((a,b) => (daysLeft(a.end) - daysLeft(b.end)));

    const expired = actives.filter(c => {
      const dl = daysLeft(c.end);
      return dl !== null && dl < 0 && !isContacted(c);
    }).slice(0, 4);

    const box = $("reminder-list");

    const parts = [];
    if (todayEnds.length){
      parts.push(`<p class="text-[11px] font-black text-red-300">ğŸ”¥ ÙŠÙ†ØªÙ‡ÙŠ Ø§Ù„ÙŠÙˆÙ…</p>`);
      parts.push(todayEnds.map(c => reminderCard(c, "Ø§Ù„ÙŠÙˆÙ…", "border-red-500")).join(""));
    }
    if (tomorrowEnds.length){
      parts.push(`<p class="text-[11px] font-black text-orange-300 mt-3">â³ Ø¨Ø§Ú†Ø± ÙŠÙ†ØªÙ‡ÙŠ</p>`);
      parts.push(tomorrowEnds.map(c => reminderCard(c, "Ø¨Ø§Ú†Ø±", "border-orange-500")).join(""));
    }
    if (due7.length){
      parts.push(`<p class="text-[11px] font-black text-blue-300 mt-3">ğŸ§  Ù‚Ø±ÙŠØ¨Ø§Ù‹ (7 Ø£ÙŠØ§Ù…)</p>`);
      parts.push(due7.map(c => reminderCard(c, "Ù‚Ø±ÙŠØ¨Ø§Ù‹", "border-blue-500")).join(""));
    }
    if (!todayEnds.length && !tomorrowEnds.length && !due7.length){
      parts.push(`<p class="text-center text-xs text-slate-500 font-black">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ°ÙƒÙŠØ±Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹ ğŸ‰</p>`);
    }
    if (expired.length){
      parts.push(`<p class="text-[11px] font-black text-slate-300 mt-3">âš ï¸ Ù…Ù†ØªÙ‡ÙŠØ© (Ù…Ø®ØªØµØ±)</p>`);
      parts.push(expired.map(c => reminderCard(c, "Ù…Ù†ØªÙ‡ÙŠ", "border-slate-500")).join(""));
    }

    box.innerHTML = parts.join("");
  }

  function markContacted(client){
    const keyNew = `${client.id}|${client.end}`;
    if (!state.contacted.keys.includes(keyNew)){
      state.contacted.keys.push(keyNew);
      saveContactStore();
    }
  }

  /* -------- Add / Edit -------- */

  function setPaidState(paid){
    state.currentPaid = !!paid;
    $("p-true").classList.toggle("active", state.currentPaid);
    $("p-false").classList.toggle("active", !state.currentPaid);
    $("p-true").classList.toggle("border-green-500/60", true);
    $("p-false").classList.toggle("border-red-500/60", true);
  }

  function setTypeByDuration(days, type){
    state.currentType = type;
    // UI chips
    [...$("durBtns").querySelectorAll(".chip")].forEach(b => {
      b.classList.toggle("active", b.dataset.type === type);
    });

    const today = isoDateLocal(new Date());
    const base = $("expDate").value || today;
    // Ø¥Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø¯Ø¯ ØªØ§Ø±ÙŠØ® Ø³Ø§Ø¨Ù‚ØŒ Ø®Ù„Ù‘ÙŠÙ‡ Ù…Ù† Ø§Ù„ÙŠÙˆÙ…
    const basePick = (parseISODate(base) ? base : today);
    $("expDate").value = addDaysToISO(basePick, Number(days));
  }

  function getServiceValue(){
    const sel = $("service-select").value;
    if (sel === "CUSTOM"){
      const v = $("service-custom").value.trim();
      return v || "Ø®Ø¯Ù…Ø© Ø£Ø®Ø±Ù‰";
    }
    return sel;
  }

  function syncCustomServiceUI(){
    const sel = $("service-select").value;
    $("customServiceWrap").classList.toggle("hidden", sel !== "CUSTOM");
  }

  function clearForm(){
    state.editId = null;
    $("name").value = "";
    $("phone").value = "";
    $("price").value = "";
    $("insta").value = "";
    $("notes").value = "";
    $("service-select").value = "Canva Pro";
    $("service-custom").value = "";
    syncCustomServiceUI();

    setPaidState(true);
    // Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø´Ù‡Ø±ÙŠ
    [...$("durBtns").querySelectorAll(".chip")].forEach(b => b.classList.toggle("active", b.dataset.type === "Ø´Ù‡Ø±ÙŠ"));
    state.currentType = "Ø´Ù‡Ø±ÙŠ";
    $("expDate").value = addDaysToISO(isoDateLocal(new Date()), 30);

    $("mainBtn").innerText = "ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª";
  }

  function addLedgerEntry({client, price, paid, end, at, service, type}){
    state.ledger.unshift({
      id: uid(),
      clientId: client.id,
      name: client.name,
      service: service || client.service,
      type: type || client.type,
      price: Number(price) || 0,
      paid: !!paid,
      end: end || client.end,
      at: at || new Date().toISOString()
    });
    saveJSON(LEDGER_KEY, state.ledger);
  }

  function saveData({openReceipt=false} = {}){
    const name = $("name").value.trim();
    const phone = normalizePhone($("phone").value);
    const insta = normalizeInsta($("insta").value);
    const price = Number($("price").value) || 0;
    const service = getServiceValue();
    const end = $("expDate").value;
    const notes = $("notes").value.trim();

    if (!name || !end){
      toast("ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ *", "warn");
      vibrate(30);
      return;
    }

    // ØªØ¬Ù‡ÙŠØ² Ø¨ÙŠØ§Ù†Ø§Øª
    const payload = {
      name,
      phone,
      insta,
      price,
      service,
      end,
      paid: state.currentPaid,
      type: state.currentType,
      notes,
      updatedAt: new Date().toISOString()
    };

    if (state.editId){
      const idx = state.clients.findIndex(c => c.id === state.editId);
      if (idx === -1){
        toast("ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø´ØªØ±Ùƒ Ù„Ù„ØªØ­Ø¯ÙŠØ«.", "err");
        return;
      }

      // ØªØ­Ø¯ÙŠØ« Ø¨Ø¯ÙˆÙ† ØªØ®Ø±ÙŠØ¨ created (Ø­ØªÙ‰ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ØªØ¨Ù‚Ù‰ ØµØ­ÙŠØ­Ø©)
      state.clients[idx] = {
        ...state.clients[idx],
        ...payload
      };
      saveJSON(DB, state.clients);
      toast("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´ØªØ±Ùƒ âœ…", "ok");
      vibrate(18);

      if (openReceipt) openReceiptById(state.clients[idx].id);

      showSection("list");
      renderList();
      updateHome();
      return;
    }

    // Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯Ø©
    const client = {
      id: uid(),
      created: new Date().toISOString(),
      archived: false,
      archivedAt: null,
      lastPaymentAt: new Date().toISOString(),
      ...payload
    };

    state.clients.unshift(client);
    saveJSON(DB, state.clients);

    // ØªØ³Ø¬ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© ÙÙŠ Ø§Ù„Ø¯ÙØªØ±
    addLedgerEntry({
      client,
      price: client.price,
      paid: client.paid,
      end: client.end,
      service: client.service,
      type: client.type,
      at: client.created
    });

    toast("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø´ØªØ±Ùƒ + ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© âœ…", "ok");
    vibrate(18);

    if (openReceipt) openReceiptById(client.id);

    clearForm();
    updateHome();
    showSection("home");
  }

  function editUserById(id){
    const c = state.clients.find(x => x.id === id);
    if (!c) return toast("Ø§Ù„Ù…Ø´ØªØ±Ùƒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.", "err");

    state.editId = c.id;

    $("name").value = c.name || "";
    $("phone").value = c.phone || "";
    $("price").value = c.price || "";
    $("insta").value = c.insta || "";
    $("notes").value = c.notes || "";
    $("expDate").value = c.end || isoDateLocal(new Date());

    // Service handling
    const options = [...$("service-select").options].map(o => o.value);
    if (options.includes(c.service)){
      $("service-select").value = c.service;
      $("service-custom").value = "";
    } else {
      $("service-select").value = "CUSTOM";
      $("service-custom").value = c.service || "";
    }
    syncCustomServiceUI();

    // Type chips
    state.currentType = c.type || "Ø´Ù‡Ø±ÙŠ";
    [...$("durBtns").querySelectorAll(".chip")].forEach(b => {
      b.classList.toggle("active", b.dataset.type === state.currentType);
    });

    setPaidState(!!c.paid);

    $("mainBtn").innerText = "ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª";
    showSection("add");
    toast("Ø£Ù†Øª Ø§Ù„Ø¢Ù† Ø¨ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ âœï¸", "info");
  }

  function archiveById(id){
    const idx = state.clients.findIndex(c => c.id === id);
    if (idx === -1) return;

    state.clients[idx].archived = true;
    state.clients[idx].archivedAt = new Date().toISOString();
    saveJSON(DB, state.clients);

    toast("ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ù…Ø´ØªØ±Ùƒ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø±Ø´ÙŠÙ ğŸ—ƒï¸ (Ø¨Ø¯ÙˆÙ† Ø­Ø°Ù)", "ok");
    vibrate(15);

    renderList();
    updateHome();
    renderTools();
  }

  function restoreById(id){
    const idx = state.clients.findIndex(c => c.id === id);
    if (idx === -1) return;

    state.clients[idx].archived = false;
    state.clients[idx].archivedAt = null;
    saveJSON(DB, state.clients);

    toast("ØªÙ…Øª Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø´ØªØ±Ùƒ Ù…Ù† Ø§Ù„Ø£Ø±Ø´ÙŠÙ âœ…", "ok");
    vibrate(15);

    renderTools();
    renderList();
    updateHome();
  }

  function toggleTypeById(id){
    const idx = state.clients.findIndex(c => c.id === id);
    if (idx === -1) return;
    const cur = state.clients[idx].type || "Ø´Ù‡Ø±ÙŠ";
    state.clients[idx].type = (cur === "Ø³Ù†ÙˆÙŠ") ? "Ø´Ù‡Ø±ÙŠ" : "Ø³Ù†ÙˆÙŠ";
    saveJSON(DB, state.clients);
    toast(`ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø¥Ù„Ù‰: ${state.clients[idx].type}`, "ok");
    renderList();
    updateHome();
  }

  /* -------- List Rendering -------- */

  function statusBadge(c){
    const dl = daysLeft(c.end);
    if (dl === null) return `<span class="text-[10px] font-black text-slate-400">Ø¨Ø¯ÙˆÙ† ØªØ§Ø±ÙŠØ®</span>`;

    if (dl < 0) return `<span class="text-[10px] font-black text-red-300">âš ï¸ Ù…Ù†ØªÙ‡ÙŠ</span>`;
    if (dl <= 7) return `<span class="text-[10px] font-black text-orange-300">â³ Ù‚Ø±ÙŠØ¨</span>`;
    return `<span class="text-[10px] font-black text-green-300">âœ… ÙØ¹Ù‘Ø§Ù„</span>`;
  }

  function paidBadge(c){
    return c.paid
      ? `<span class="text-[10px] font-black text-emerald-300">ğŸŸ¢ Ù…Ø¯ÙÙˆØ¹</span>`
      : `<span class="text-[10px] font-black text-red-300">ğŸ”´ Ø¯ÙŠÙ†</span>`;
  }

  function renderList(){
    const q = ($("search").value || "").toLowerCase().trim();
    state.q = q;

    const today = isoDateLocal(new Date());

    let arr = state.clients.slice();

    // status filter (archived)
    if (state.statusFilter === "archived"){
      arr = arr.filter(c => !!c.archived);
    } else {
      arr = arr.filter(c => !c.archived);
    }

    // type filter
    if (state.typeFilter !== "Ø§Ù„ÙƒÙ„"){
      arr = arr.filter(c => (c.type || "Ø´Ù‡Ø±ÙŠ") === state.typeFilter);
    }

    // status filter (non-archived modes)
    if (state.statusFilter !== "all" && state.statusFilter !== "archived"){
      arr = arr.filter(c => {
        const dl = daysLeft(c.end);
        if (dl === null) return false;

        if (state.statusFilter === "paid") return !!c.paid;
        if (state.statusFilter === "debt") return !c.paid;
        if (state.statusFilter === "due7") return dl >= 0 && dl <= 7;
        if (state.statusFilter === "expired") return dl < 0;
        return true;
      });
    }

    // search (name/phone/service/insta)
    if (q){
      arr = arr.filter(c => {
        const hay = `${c.name||""} ${c.phone||""} ${c.service||""} ${c.insta||""}`.toLowerCase();
        return hay.includes(q);
      });
    }

    // sort
    const sortMode = $("sortMode").value || "endAsc";
    state.sortMode = sortMode;

    function endValue(c){
      // Ø¥Ø°Ø§ Ù…Ø§ÙƒÙˆ ØªØ§Ø±ÙŠØ® Ù†Ø®Ù„ÙŠÙ‡ Ø¨Ø¹ÙŠØ¯
      return c.end ? c.end : "9999-12-31";
    }

    if (sortMode === "endAsc"){
      arr.sort((a,b) => endValue(a).localeCompare(endValue(b)));
    } else if (sortMode === "endDesc"){
      arr.sort((a,b) => endValue(b).localeCompare(endValue(a)));
    } else if (sortMode === "name"){
      arr.sort((a,b) => (a.name||"").localeCompare((b.name||""), "ar"));
    } else if (sortMode === "recent"){
      arr.sort((a,b) => {
        const da = new Date(a.lastPaymentAt || a.updatedAt || a.created || 0).getTime();
        const db = new Date(b.lastPaymentAt || b.updatedAt || b.created || 0).getTime();
        return db - da;
      });
    }

    $("listCount").innerText = arr.length.toLocaleString("en-US");

    const list = $("main-list");
    if (!arr.length){
      list.innerHTML = `
        <div class="glass p-6 rounded-[2.5rem] text-center">
          <p class="text-sm font-black text-slate-200">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</p>
          <p class="text-xs text-slate-500 font-bold mt-2">Ø¬Ø±Ù‘Ø¨ ØªØºÙŠÙ‘Ø± Ø§Ù„ÙÙ„Ø§ØªØ± Ø£Ùˆ Ø§ÙƒØªØ¨ ÙƒÙ„Ù…Ø© Ø¨Ø­Ø« Ø«Ø§Ù†ÙŠØ©.</p>
        </div>
      `;
      return;
    }

    list.innerHTML = arr.map((c) => {
      const dl = daysLeft(c.end);
      const border =
        dl === null ? "border-slate-600" :
        dl < 0 ? "border-red-600" :
        (!c.paid ? "border-red-400" : (dl<=7 ? "border-orange-500" : "border-green-500"));

      const phone = normalizePhone(c.phone);
      const insta = normalizeInsta(c.insta);

      return `
        <div class="glass p-4 rounded-[2.5rem] border-r-4 ${border}">
          <div class="flex justify-between gap-3 mb-3">
            <div class="min-w-0">
              <h4 class="font-black text-sm truncate">${esc(c.name)}</h4>
              <p class="text-[10px] text-blue-300 font-black truncate">${esc(c.service)} â€¢ ${formatMoney(c.price)} Ø¯.Ø¹</p>
              <div class="flex gap-2 mt-2 flex-wrap">
                ${paidBadge(c)}
                <span class="text-[10px] font-black text-slate-300">ğŸ—“ï¸ ${esc(c.type || "Ø´Ù‡Ø±ÙŠ")}</span>
                ${statusBadge(c)}
              </div>
            </div>

            <div class="text-left">
              <p class="text-[9px] text-slate-400 font-black">ÙŠÙ†ØªÙ‡ÙŠ: ${esc(c.end || "-")}</p>
              <p class="text-[9px] text-slate-500 font-black mt-1">
                ${dl === null ? "-" : (dl >= 0 ? `Ø¨Ø¹Ø¯ ${dl} ÙŠÙˆÙ…` : `Ù…ØªØ£Ø®Ø± ${Math.abs(dl)} ÙŠÙˆÙ…`)}
              </p>

              <button class="text-[8px] bg-slate-800 px-2 py-1 rounded-lg mt-2 border border-slate-700"
                      data-action="toggleType" data-id="${esc(c.id)}">
                ğŸ”„ Ù†Ù‚Ù„ Ø¥Ù„Ù‰ ${ (c.type === "Ø³Ù†ÙˆÙŠ") ? "Ø´Ù‡Ø±ÙŠ" : "Ø³Ù†ÙˆÙŠ" }
              </button>
            </div>
          </div>

          <div class="flex flex-wrap gap-2 items-center">
            <button class="chip !text-[10px] !px-3 !py-2 border-white/30"
                    data-action="receipt" data-id="${esc(c.id)}">ÙˆØµÙ„ ğŸ“„</button>

            <button class="chip !text-[10px] !px-3 !py-2 border-orange-500/50"
                    data-action="renew" data-id="${esc(c.id)}">ØªØ¬Ø¯ÙŠØ¯ âš¡</button>

            <button class="chip !text-[10px] !px-3 !py-2 border-slate-500/50"
                    data-action="edit" data-id="${esc(c.id)}">ØªØ¹Ø¯ÙŠÙ„ âœï¸</button>

            <a class="chip !text-[10px] !px-3 !py-2 border-green-500/50"
               href="${phone ? waUrl(phone) : "#"}" target="_blank" rel="noopener"
               ${phone ? "" : 'onclick="return false;" style="opacity:.45; cursor:not-allowed;"'}>
              ÙˆØ§ØªØ³Ø§Ø¨ ğŸŸ¢
            </a>

            <a class="chip !text-[10px] !px-3 !py-2 border-pink-500/50"
               href="${insta ? instaUrl(insta) : "#"}" target="_blank" rel="noopener"
               ${insta ? "" : 'onclick="return false;" style="opacity:.45; cursor:not-allowed;"'}>
              Ø§Ù†Ø³ØªØºØ±Ø§Ù… ğŸŸ£
            </a>

            ${
              state.statusFilter === "archived"
              ? `<button class="chip !text-[10px] !px-3 !py-2 border-blue-500/50 mr-auto"
                         data-action="restore" data-id="${esc(c.id)}">Ø§Ø³ØªØ¹Ø§Ø¯Ø© âœ…</button>`
              : `<button class="text-red-300 font-black mr-auto"
                         data-action="archive" data-id="${esc(c.id)}" title="Ø£Ø±Ø´ÙØ© Ø¨Ø¯ÙˆÙ† Ø­Ø°Ù">ğŸ—ƒï¸</button>`
            }
          </div>
        </div>
      `;
    }).join("");
  }

  /* -------- Receipt -------- */

  function openReceiptById(id){
    const c = state.clients.find(x => x.id === id);
    if (!c) return toast("Ø§Ù„Ù…Ø´ØªØ±Ùƒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.", "err");

    $("rName").innerText = c.name || "-";
    $("rService").innerText = c.service || "-";
    $("rPrice").innerText = formatMoney(c.price) + " Ø¯.Ø¹";
    $("rPaid").innerText = c.paid ? "Ù…Ø¯ÙÙˆØ¹ âœ…" : "Ø¯ÙŠÙ† âŒ";
    $("rEnd").innerText = c.end || "-";
    $("rAt").innerText = new Date().toLocaleString("ar-IQ");

    // QR
    $("qrBox").innerHTML = "";
    const qrText = `NAS|${c.name}|${c.service}|${c.price}|${c.end}|${c.paid ? "PAID" : "DEBT"}`;
    try{
      new QRCode($("qrBox"), {
        text: qrText,
        width: 86,
        height: 86,
        correctLevel: QRCode.CorrectLevel.M
      });
    }catch(e){
      // Ù„Ùˆ ÙØ´Ù„ØŒ Ù„Ø§ Ù…Ø´ÙƒÙ„Ø©
    }

    $("receiptModal").classList.remove("hidden");
  }

  async function shareReceipt(){
    try{
      const canvas = await html2canvas($("printableReceipt"), { scale: 3, backgroundColor: "#ffffff" });
      canvas.toBlob(blob => {
        const file = new File([blob], 'NAS_Receipt.png', {type:'image/png'});
        if (navigator.canShare && navigator.canShare({files:[file]})){
          navigator.share({files:[file], title:"NAS Receipt"});
        } else {
          const a = document.createElement('a');
          a.download = 'NAS_Receipt.png';
          a.href = canvas.toDataURL('image/png');
          a.click();
        }
      });
    }catch(e){
      toast("ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ ØµÙˆØ±Ø© Ø§Ù„ÙˆØµÙ„.", "err");
    }
  }

  /* -------- Renew -------- */

  function openRenewModal(id){
    const c = state.clients.find(x => x.id === id);
    if (!c) return toast("Ø§Ù„Ù…Ø´ØªØ±Ùƒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.", "err");

    state.renewId = id;

    $("renewName").innerText = c.name || "-";
    $("renewService").innerText = `${c.service || "-"} â€¢ Ù†ÙˆØ¹: ${c.type || "Ø´Ù‡Ø±ÙŠ"}`;

    // default days based on type
    state.renewDays = (c.type === "Ø³Ù†ÙˆÙŠ") ? 365 : 30;

    $("renewMon").classList.toggle("active", state.renewDays === 30);
    $("renewYear").classList.toggle("active", state.renewDays === 365);

    // default paid = true
    state.renewPaid = true;
    $("renewPaidBtn").classList.add("active");
    $("renewDebtBtn").classList.remove("active");

    $("renewPrice").value = Number(c.price) || 0;

    // base date = max(today, current end)
    const today = isoDateLocal(new Date());
    const base = (c.end && c.end >= today) ? c.end : today;
    $("renewEnd").value = addDaysToISO(base, state.renewDays);

    $("renewModal").classList.remove("hidden");
    vibrate(10);
  }

  function setRenewPaid(paid){
    state.renewPaid = !!paid;
    $("renewPaidBtn").classList.toggle("active", state.renewPaid);
    $("renewDebtBtn").classList.toggle("active", !state.renewPaid);
  }

  function setRenewDays(days){
    state.renewDays = Number(days);

    $("renewMon").classList.toggle("active", state.renewDays === 30);
    $("renewYear").classList.toggle("active", state.renewDays === 365);

    const c = state.clients.find(x => x.id === state.renewId);
    if (!c) return;

    const today = isoDateLocal(new Date());
    const base = (c.end && c.end >= today) ? c.end : today;
    $("renewEnd").value = addDaysToISO(base, state.renewDays);
  }

  function confirmRenew(){
    const c = state.clients.find(x => x.id === state.renewId);
    if (!c) return toast("Ø§Ù„Ù…Ø´ØªØ±Ùƒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.", "err");

    const newEnd = $("renewEnd").value;
    const price = Number($("renewPrice").value) || 0;

    if (!newEnd){
      toast("Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ ØµØ­ÙŠØ­.", "warn");
      return;
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù…ÙŠÙ„
    c.end = newEnd;
    c.price = price;
    c.paid = state.renewPaid;
    c.updatedAt = new Date().toISOString();
    c.lastPaymentAt = new Date().toISOString();

    saveJSON(DB, state.clients);

    // ØªØ³Ø¬ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ©
    addLedgerEntry({
      client: c,
      price,
      paid: c.paid,
      end: c.end,
      service: c.service,
      type: c.type,
      at: new Date().toISOString()
    });

    toast("ØªÙ… Ø§Ù„ØªØ¬Ø¯ÙŠØ¯ + ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© âœ…", "ok");
    vibrate(18);

    $("renewModal").classList.add("hidden");
    updateHome();
    renderList();
  }

  /* -------- Tools -------- */

  function exportJSONFile(){
    const payload = {
      app: "NAS",
      version: state.meta.version,
      exportedAt: new Date().toISOString(),
      clients: state.clients,
      ledger: state.ledger
    };

    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `NAS_Backup_${isoDateLocal(new Date())}.json`;
    a.click();
    URL.revokeObjectURL(a.href);

    toast("ØªÙ… ØªØµØ¯ÙŠØ± Ù†Ø³Ø®Ø© JSON âœ…", "ok");
  }

  function exportLedgerCSV(){
    const rows = [
      ["id","clientId","name","service","type","price","paid","end","at"]
    ];

    state.ledger.forEach(tx => {
      rows.push([
        tx.id, tx.clientId,
        (tx.name||"").replaceAll('"','""'),
        (tx.service||"").replaceAll('"','""'),
        (tx.type||""),
        Number(tx.price)||0,
        tx.paid ? "PAID" : "DEBT",
        tx.end || "",
        tx.at || ""
      ]);
    });

    const csv = rows.map(r => r.map(v => `"${String(v ?? "").replaceAll('"','""')}"`).join(",")).join("\n");
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `NAS_Ledger_${isoDateLocal(new Date())}.csv`;
    a.click();
    URL.revokeObjectURL(a.href);

    toast("ØªÙ… ØªØµØ¯ÙŠØ± CSV Ù„Ù„Ø¹Ù…Ù„ÙŠØ§Øª âœ…", "ok");
  }

  async function importJSONFile(file){
    try{
      const text = await file.text();
      const data = JSON.parse(text);

      const incomingClients = Array.isArray(data.clients) ? data.clients : [];
      const incomingLedger  = Array.isArray(data.ledger) ? data.ledger : [];

      const existingIds = new Set(state.clients.map(c => c.id));
      let addedClients = 0;

      incomingClients.forEach(c => {
        if (!c || typeof c !== "object") return;
        const id = c.id || uid();
        if (existingIds.has(id)) return;
        existingIds.add(id);
        state.clients.push({
          ...c,
          id,
          name: (c.name || "").toString(),
          phone: (c.phone || "").toString(),
          insta: (c.insta || "").toString(),
          service: (c.service || "Canva Pro").toString(),
          price: Number(c.price) || 0,
          type: (c.type || "Ø´Ù‡Ø±ÙŠ").toString(),
          paid: (typeof c.paid === "boolean") ? c.paid : true,
          end: (c.end || "").toString(),
          created: (c.created || new Date().toISOString()).toString(),
          archived: !!c.archived,
          archivedAt: c.archivedAt || null
        });
        addedClients++;
      });

      const existingTx = new Set(state.ledger.map(tx => tx.id));
      let addedTx = 0;
      incomingLedger.forEach(tx => {
        if (!tx || typeof tx !== "object") return;
        const id = tx.id || uid();
        if (existingTx.has(id)) return;
        existingTx.add(id);
        state.ledger.push({ ...tx, id });
        addedTx++;
      });

      // Ø­ÙØ¸
      saveJSON(DB, state.clients);
      saveJSON(LEDGER_KEY, state.ledger);

      toast(`ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ âœ… (Ù…Ø´ØªØ±ÙƒÙŠÙ†: +${addedClients} / Ø¹Ù…Ù„ÙŠØ§Øª: +${addedTx})`, "ok");
      updateHome();
      renderList();
      renderTools();
    }catch(e){
      toast("ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯: Ø§Ù„Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­.", "err");
    }
  }

  function resetContactToday(){
    state.contacted = { date: isoDateLocal(new Date()), keys: [] };
    saveContactStore();
    toast("ØªÙ… ØªØµÙÙŠØ± Ø³Ø¬Ù„ Ø§Ù„ØªØ°ÙƒÙŠØ± Ù„Ù„ÙŠÙˆÙ… âœ…", "ok");
    updateHome();
  }

  function runRepair(){
    migrateClients();
    migrateLedger();
    state.contacted = loadContactStore();
    toast("ØªÙ… Ø¥ØµÙ„Ø§Ø­/ØªØ±Ø­ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª âœ…", "ok");
    updateHome();
    renderList();
    renderTools();
  }

  function renderTools(){
    const archived = state.clients.filter(c => !!c.archived);
    $("archivedCount").innerText = archived.length.toLocaleString("en-US");

    const box = $("archive-list");
    if (!archived.length){
      box.innerHTML = `<p class="text-xs text-slate-500 font-black text-center">Ø§Ù„Ø£Ø±Ø´ÙŠÙ ÙØ§Ø±Øº.</p>`;
      return;
    }

    // Ø¹Ø±Ø¶ Ø¢Ø®Ø± 12 ÙÙ‚Ø·
    const show = archived.slice(0, 12);

    box.innerHTML = show.map(c => `
      <div class="bg-slate-900/40 border border-slate-700/40 rounded-3xl p-4 flex items-center justify-between gap-3">
        <div class="min-w-0">
          <p class="text-xs font-black truncate">${esc(c.name)}</p>
          <p class="text-[10px] text-slate-400 font-bold truncate">${esc(c.service)} â€¢ ${formatMoney(c.price)} Ø¯.Ø¹</p>
          <p class="text-[10px] text-slate-500 font-black mt-1">Ù…Ø¤Ø±Ø´Ù: ${c.archivedAt ? new Date(c.archivedAt).toLocaleString("ar-IQ") : "-"}</p>
        </div>
        <button class="chip !text-[10px] !px-3 !py-2 border-blue-500/60"
                data-action="restore" data-id="${esc(c.id)}">Ø§Ø³ØªØ¹Ø§Ø¯Ø© âœ…</button>
      </div>
    `).join("");
  }

  /* -------- Global Event Wiring -------- */

  function bindEvents(){
    // Nav
    $("topNav").addEventListener("click", (e) => {
      const btn = e.target.closest("[data-sec]");
      if (!btn) return;
      showSection(btn.dataset.sec);
      vibrate(8);
    });

    // home "go list"
    document.addEventListener("click", (e) => {
      const go = e.target.closest("[data-go]");
      if (!go) return;
      const to = go.dataset.go;
      if (to === "list") showSection("list");
    });

    // FAB
    $("fabAdd").addEventListener("click", () => {
      showSection("add");
      vibrate(10);
    });

    // Service custom
    $("service-select").addEventListener("change", () => {
      syncCustomServiceUI();
      vibrate(8);
    });

    // Dur buttons
    $("durBtns").addEventListener("click", (e) => {
      const b = e.target.closest("[data-days]");
      if (!b) return;
      setTypeByDuration(b.dataset.days, b.dataset.type);
      vibrate(8);
    });

    // Paid toggle (Add)
    $("p-true").addEventListener("click", () => { setPaidState(true); vibrate(8); });
    $("p-false").addEventListener("click", () => { setPaidState(false); vibrate(8); });

    // Save buttons
    $("mainBtn").addEventListener("click", () => saveData({openReceipt:false}));
    $("saveAndReceiptBtn").addEventListener("click", () => saveData({openReceipt:true}));

    // Reset form
    $("resetFormBtn").addEventListener("click", () => {
      clearForm();
      toast("ØªÙ… ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„ âœ…", "ok");
    });

    // Search
    $("search").addEventListener("input", () => renderList());

    // Filters
    $("typeFilters").addEventListener("click", (e) => {
      const b = e.target.closest("[data-typefilter]");
      if (!b) return;
      state.typeFilter = b.dataset.typefilter;
      [...$("typeFilters").querySelectorAll(".chip")].forEach(x => x.classList.toggle("active", x === b));
      renderList();
      vibrate(8);
    });

    $("statusFilters").addEventListener("click", (e) => {
      const b = e.target.closest("[data-status]");
      if (!b) return;
      state.statusFilter = b.dataset.status;
      [...$("statusFilters").querySelectorAll(".chip")].forEach(x => x.classList.toggle("active", x === b));
      renderList();
      vibrate(8);
    });

    $("sortMode").addEventListener("change", () => renderList());
    $("quickHomeBtn").addEventListener("click", () => showSection("home"));

    // Main list actions (Event delegation)
    $("main-list").addEventListener("click", (e) => {
      const btn = e.target.closest("[data-action]");
      if (!btn) return;

      const id = btn.dataset.id;
      const action = btn.dataset.action;

      if (action === "receipt") return openReceiptById(id);
      if (action === "renew") return openRenewModal(id);
      if (action === "edit") return editUserById(id);
      if (action === "archive") return archiveById(id);
      if (action === "restore") return restoreById(id);
      if (action === "toggleType") return toggleTypeById(id);
      if (action === "remind"){
        const c = state.clients.find(x => x.id === id);
        if (!c) return;
        const msg = `Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ÙˆØ±Ø­Ù…Ø© Ø§Ù„Ù„Ù‡ ğŸ˜Š\nØ¨Ø§Ú†Ø±/Ù‚Ø±ÙŠØ¨Ø§Ù‹ ÙŠØ®Ù„Øµ Ø§Ø´ØªØ±Ø§ÙƒÙƒ ${c.type || ""} (${c.service}).\nØªØ­Ø¨ Ù†Ø¬Ø¯Ø¯ Ù„ÙƒØŸ`;
        const link = waUrl(c.phone, msg);
        if (link === "#"){
          toast("Ø£Ø¶Ù Ø±Ù‚Ù… Ù‡Ø§ØªÙ ØµØ­ÙŠØ­ Ø£ÙˆÙ„Ø§Ù‹.", "warn");
          return;
        }
        window.open(link, "_blank");
        markContacted(c);
        toast("ØªÙ… ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ + ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØ°ÙƒÙŠØ± âœ…", "ok");
        updateHome();
      }
    });

    // Reminder list actions (same container as main-list? Ù‡Ù†Ø§ Ø¯Ø§Ø®Ù„ home)
    $("reminder-list").addEventListener("click", (e) => {
      const btn = e.target.closest("[data-action]");
      if (!btn) return;
      const id = btn.dataset.id;
      const action = btn.dataset.action;

      if (action === "renew") return openRenewModal(id);
      if (action === "remind"){
        const c = state.clients.find(x => x.id === id);
        if (!c) return;
        const msg = `Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ğŸ˜Š\nØ§Ø´ØªØ±Ø§ÙƒÙƒ ${c.type || ""} (${c.service}) ÙŠØ®Ù„Øµ Ù‚Ø±ÙŠØ¨Ø§Ù‹.\nØªØ­Ø¨ Ù†Ø¬Ø¯Ø¯ Ù„ÙƒØŸ`;
        const link = waUrl(c.phone, msg);
        if (link === "#"){
          toast("Ø£Ø¶Ù Ø±Ù‚Ù… Ù‡Ø§ØªÙ ØµØ­ÙŠØ­ Ø£ÙˆÙ„Ø§Ù‹.", "warn");
          return;
        }
        window.open(link, "_blank");
        markContacted(c);
        toast("ØªÙ… ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ + ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØ°ÙƒÙŠØ± âœ…", "ok");
        updateHome();
      }
    });

    // Receipt modal
    $("closeReceiptBtn").addEventListener("click", () => $("receiptModal").classList.add("hidden"));
    $("shareReceiptBtn").addEventListener("click", shareReceipt);

    $("receiptModal").addEventListener("click", (e) => {
      if (e.target === $("receiptModal")) $("receiptModal").classList.add("hidden");
    });

    // Renew modal
    $("closeRenewBtn").addEventListener("click", () => $("renewModal").classList.add("hidden"));
    $("renewModal").addEventListener("click", (e) => {
      if (e.target === $("renewModal")) $("renewModal").classList.add("hidden");
    });

    $("renewMon").addEventListener("click", () => setRenewDays(30));
    $("renewYear").addEventListener("click", () => setRenewDays(365));
    $("renewPaidBtn").addEventListener("click", () => setRenewPaid(true));
    $("renewDebtBtn").addEventListener("click", () => setRenewPaid(false));
    $("confirmRenewBtn").addEventListener("click", confirmRenew);

    // Tools
    $("exportBtn").addEventListener("click", exportJSONFile);
    $("exportCsvBtn").addEventListener("click", exportLedgerCSV);

    $("importFile").addEventListener("change", (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      importJSONFile(file);
      e.target.value = "";
    });

    $("resetContactBtn").addEventListener("click", resetContactToday);
    $("runRepairBtn").addEventListener("click", runRepair);

    // Tools archive list restore
    $("archive-list").addEventListener("click", (e) => {
      const btn = e.target.closest("[data-action='restore']");
      if (!btn) return;
      restoreById(btn.dataset.id);
    });

    // Toast close
    $("toastHost").addEventListener("click", (e) => {
      const b = e.target.closest("[data-close-toast]");
      if (!b) return;
      const id = b.dataset.closeToast;
      const node = $(id);
      if (node) node.remove();
    });

    // ESC closes modals
    document.addEventListener("keydown", (e) => {
      if (e.key !== "Escape") return;
      $("receiptModal").classList.add("hidden");
      $("renewModal").classList.add("hidden");
    });
  }

  /* -------- Init -------- */

  function init(){
    migrateClients();
    migrateLedger();

    state.contacted = loadContactStore();
    // Ø¥Ø°Ø§ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ùˆ Ø§Ù„ÙŠÙˆÙ…ØŒ Ø±Ø§Ø­ ÙŠØªØµÙÙ‘Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¯Ø§Ø®Ù„ loadContactStore

    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ø­Ù‚Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
    $("expDate").value = addDaysToISO(isoDateLocal(new Date()), 30);

    syncCustomServiceUI();
    setPaidState(true);

    bindEvents();
    updateHome();
    renderTools();
    showSection("home");
  }

  init();
</script>

</body>
</html>
