<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>NAS | Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨Ø³Ø·Ø© V8.3</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b1120" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { cairo: ["Cairo", "sans-serif"] }
        }
      }
    };
  </script>

  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

  <style>
    :root{
      --bg:#0b1120;
      --panel:rgba(30, 41, 59, 0.68);
      --border:rgba(255,255,255,0.10);
      --text:#e2e8f0;
      --muted:#94a3b8;
      --blue:#3b82f6;
      --green:#22c55e;
      --red:#ef4444;
      --orange:#f59e0b;

      /* Ù„ÙˆÙ† â€œØ£Ø¨ÙŠØ¶ Ù„ÙƒÙ† Ù…Ùˆ Ø³Ø§Ø·Ø¹â€ Ù„Ù„ÙˆØµÙ„ */
      --receipt:#f6f7fb;
    }

    body{
      font-family: 'Cairo', sans-serif;
      background: radial-gradient(1200px 600px at 70% -10%, rgba(59,130,246,.18), transparent 60%),
                  radial-gradient(900px 500px at 10% 10%, rgba(245,158,11,.10), transparent 55%),
                  var(--bg);
      color: var(--text);
    }

    .glass{
      background: var(--panel);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      border: 1px solid var(--border);
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
    }

    .tab-btn{
      transition: .25s ease;
      border-bottom: 3px solid transparent;
      opacity: .55;
    }
    .tab-btn.active{
      opacity: 1;
      border-color: var(--blue);
      color: var(--blue);
    }

    .input-field{
      background: rgba(30, 41, 59, 0.85);
      border: 1px solid rgba(148,163,184,0.25);
      color: white;
      border-radius: 16px;
      padding: 12px 14px;
      width: 100%;
      outline: none;
      transition: .2s ease;
    }
    .input-field:focus{
      border-color: rgba(59,130,246,.7);
      box-shadow: 0 0 0 4px rgba(59,130,246,.12);
    }

    .mini{
      background: rgba(15,23,42,.55);
      border: 1px solid rgba(148,163,184,.18);
      border-radius: 18px;
      padding: 12px;
    }

    .chip{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      padding:10px 12px;
      border-radius:16px;
      background: rgba(30,41,59,.80);
      border: 1px solid rgba(148,163,184,.22);
      font-weight: 900;
      font-size: 11px;
      user-select:none;
      cursor:pointer;
      transition:.2s ease;
    }
    .chip.active{
      border-color: rgba(59,130,246,.85);
      box-shadow: 0 0 0 4px rgba(59,130,246,.12);
    }

    .section-enter{ animation: fadeUp .22s ease-out; }
    @keyframes fadeUp{ from{transform:translateY(10px);opacity:0} to{transform:translateY(0);opacity:1} }

    @media (prefers-reduced-motion: reduce){
      .section-enter,.tab-btn,.chip,.input-field{animation:none!important;transition:none!important}
    }
  </style>
</head>

<body class="pb-24 font-cairo">

  <!-- Nav (3 ÙÙ‚Ø·) -->
  <nav id="topNav" class="flex bg-slate-900/80 border-b border-slate-800 sticky top-0 z-50 shadow-2xl backdrop-blur-xl">
    <button data-sec="home" id="btn-home" class="tab-btn active flex-1 p-4 font-black text-xs text-center">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
    <button data-sec="add"  id="btn-add"  class="tab-btn flex-1 p-4 font-black text-xs text-center">â• Ø¥Ø¶Ø§ÙØ©</button>
    <button data-sec="list" id="btn-list" class="tab-btn flex-1 p-4 font-black text-xs text-center">ğŸ” Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</button>
  </nav>

  <main class="p-4 max-w-3xl mx-auto space-y-6">

    <!-- HOME -->
    <section id="sec-home" class="space-y-4 section-enter">
      <div class="glass p-6 rounded-[2.75rem]">
        <div class="flex items-start justify-between gap-3">
          <div>
            <h1 class="text-3xl font-black text-blue-400 leading-tight">NAS</h1>
            <p class="text-xs text-slate-400 font-bold">Ù„ÙˆØ­Ø© Ù…Ø¨Ø³Ø·Ø© â€¢ V8.3</p>
          </div>
          <div class="text-left">
            <p class="text-[10px] text-slate-400 font-black">Ø§Ù„ÙŠÙˆÙ…</p>
            <p id="todayLabel" class="text-sm font-black"></p>
          </div>
        </div>

        <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª â€œØµØºÙŠØ±Ø© Ù…Ø«Ù„ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øªâ€ -->
        <div class="mt-5 grid grid-cols-2 md:grid-cols-4 gap-2">
          <div class="mini">
            <p class="text-[10px] text-slate-400 font-black">ÙƒØ§Ø´ Ø§Ù„ÙŠÙˆÙ…</p>
            <p id="d-paid" class="text-lg font-black text-green-300">0</p>
          </div>
          <div class="mini">
            <p class="text-[10px] text-slate-400 font-black">Ø¯ÙŠÙˆÙ† Ø§Ù„ÙŠÙˆÙ…</p>
            <p id="d-debt" class="text-lg font-black text-red-300">0</p>
          </div>
          <div class="mini">
            <p class="text-[10px] text-slate-400 font-black">ÙƒØ§Ø´ Ø§Ù„Ø´Ù‡Ø±</p>
            <p id="m-paid" class="text-lg font-black text-green-300">0</p>
          </div>
          <div class="mini">
            <p class="text-[10px] text-slate-400 font-black">Ø¯ÙŠÙˆÙ† Ø§Ù„Ø´Ù‡Ø±</p>
            <p id="m-debt" class="text-lg font-black text-red-300">0</p>
          </div>
        </div>

        <div class="mt-3 grid grid-cols-2 md:grid-cols-4 gap-2">
          <div class="mini">
            <p class="text-[10px] text-slate-400 font-black">ÙØ¹Ù‘Ø§Ù„ÙŠÙ†</p>
            <p id="k-active" class="text-lg font-black text-emerald-200">0</p>
          </div>
          <div class="mini">
            <p class="text-[10px] text-slate-400 font-black">Ù‚Ø±ÙŠØ¨ (7 Ø£ÙŠØ§Ù…)</p>
            <p id="k-due7" class="text-lg font-black text-orange-200">0</p>
          </div>
          <div class="mini">
            <p class="text-[10px] text-slate-400 font-black">Ù…Ù†ØªÙ‡ÙŠØ©</p>
            <p id="k-expired" class="text-lg font-black text-red-200">0</p>
          </div>
          <div class="mini">
            <p class="text-[10px] text-slate-400 font-black">Ø¯ÙŠÙˆÙ† Ø­Ø§Ù„ÙŠØ©</p>
            <p id="k-totalDebt" class="text-lg font-black text-red-200">0</p>
          </div>
        </div>
      </div>

      <!-- ØªØ°ÙƒÙŠØ±Ø§Øª Ø¨Ø³ÙŠØ·Ø© -->
      <div class="glass p-5 rounded-[2.75rem] space-y-3">
        <div class="flex items-center justify-between">
          <h3 class="text-sm font-black text-orange-300">ğŸ”” ØªØ°ÙƒÙŠØ±Ø§Øª (Ø§Ù„ÙŠÙˆÙ…/Ø¨Ø§Ú†Ø±)</h3>
          <button id="goListFromHome" class="text-xs font-black text-blue-300 hover:text-blue-200">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„ â†’</button>
        </div>
        <div id="reminder-list" class="space-y-3"></div>
      </div>
    </section>

    <!-- ADD -->
    <section id="sec-add" class="hidden space-y-4 section-enter">
      <div class="glass p-6 rounded-[2.75rem] space-y-4">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-black text-blue-400">â• Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„</h2>
          <button id="resetFormBtn" class="text-xs font-black text-slate-300 hover:text-white">ØªÙØ±ÙŠØº</button>
        </div>

        <input id="name" class="input-field" placeholder="Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ† Ø§Ù„ÙƒØ§Ù…Ù„ *">

        <div class="grid grid-cols-2 gap-2">
          <input id="phone" type="tel" class="input-field" placeholder="77XXXXXXXX">
          <input id="price" type="number" class="input-field" placeholder="Ø§Ù„Ø³Ø¹Ø± (Ø¯.Ø¹)">
        </div>

        <div class="grid grid-cols-2 gap-2">
          <select id="service-select" class="input-field">
            <option value="Canva Pro">Canva Pro</option>
            <option value="ChatGPT">ChatGPT</option>
            <option value="CapCut">CapCut</option>
            <option value="YouTube Premium">YouTube Premium</option>
            <option value="Netflix">Netflix</option>
            <option value="Spotify">Spotify</option>
            <option value="Office 365">Office 365</option>
            <option value="CUSTOM">Ø£Ø®Ø±Ù‰ +</option>
          </select>
          <input id="insta" class="input-field" placeholder="ÙŠÙˆØ²Ø± Ø§Ù†Ø³ØªØºØ±Ø§Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
        </div>

        <div id="customServiceWrap" class="hidden">
          <input id="service-custom" class="input-field" placeholder="Ø§Ø³Ù… Ø§Ù„Ø®Ø¯Ù…Ø© (Ù…Ø«Ø§Ù„: VPN / Adobe ...)" />
        </div>

        <div class="glass p-4 rounded-3xl border border-slate-700/50 space-y-3">
          <p class="text-xs font-black text-slate-200">â±ï¸ Ù…Ø¯Ø© + ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ *</p>
          <div class="grid grid-cols-2 gap-2">
            <button id="durMon" class="chip active">ğŸ“… Ø´Ù‡Ø±ÙŠ</button>
            <button id="durYear" class="chip">ğŸŒŸ Ø³Ù†ÙˆÙŠ</button>
          </div>
          <input type="date" id="expDate" class="input-field">
        </div>

        <div class="grid grid-cols-2 gap-2">
          <button id="p-true" class="chip active border-green-500/60">âœ… Ù…Ø¯ÙÙˆØ¹</button>
          <button id="p-false" class="chip border-red-500/60">âŒ Ø¯ÙŠÙ†</button>
        </div>

        <div class="flex items-center justify-between mini">
          <p class="text-xs font-black text-slate-200">ÙØªØ­ Ø§Ù„ÙˆØµÙ„ Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸</p>
          <label class="flex items-center gap-2 cursor-pointer">
            <input id="openReceiptAfterSave" type="checkbox" class="accent-blue-500" checked>
            <span class="text-xs font-black text-slate-300">Ù†Ø¹Ù…</span>
          </label>
        </div>

        <button id="mainBtn" class="w-full bg-blue-600 hover:bg-blue-500 p-4 rounded-2xl font-black shadow-lg">
          ğŸ’¾ Ø­ÙØ¸
        </button>

        <p class="text-[10px] text-slate-500 font-bold">
          âœ… Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† Ø§Ù„Ù‚Ø¯Ø§Ù…Ù‰ Ù…Ø­ÙÙˆØ¸ÙŠÙ† (Ù†ÙØ³ DB Key).
        </p>
      </div>
    </section>

    <!-- LIST -->
    <section id="sec-list" class="hidden space-y-4 section-enter">
      <div class="glass p-5 rounded-[2.75rem] space-y-4">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-black text-blue-400">ğŸ” Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</h2>
          <p class="text-[10px] text-slate-500 font-black">Ù†ØªØ§Ø¦Ø¬: <span id="listCount">0</span></p>
        </div>

        <input id="search" class="input-field" placeholder="Ø¨Ø­Ø«: Ø§Ù„Ø§Ø³Ù… / Ø§Ù„Ø±Ù‚Ù… / Ø§Ù„Ø®Ø¯Ù…Ø© / Ø§Ù„Ø§Ù†Ø³ØªØ§ ...">

        <!-- Ø¨Ø¯Ù„ ÙƒØ«Ø±Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø±: Ø³Ù„ÙƒØªØ§Øª Ø¨Ø³ÙŠØ·Ø© -->
        <div class="grid grid-cols-2 gap-2">
          <select id="typeFilter" class="input-field">
            <option value="Ø§Ù„ÙƒÙ„">Ø§Ù„Ù†ÙˆØ¹: Ø§Ù„ÙƒÙ„</option>
            <option value="Ø´Ù‡Ø±ÙŠ">Ø§Ù„Ù†ÙˆØ¹: Ø´Ù‡Ø±ÙŠ</option>
            <option value="Ø³Ù†ÙˆÙŠ">Ø§Ù„Ù†ÙˆØ¹: Ø³Ù†ÙˆÙŠ</option>
          </select>

          <select id="statusFilter" class="input-field">
            <option value="all">Ø§Ù„Ø­Ø§Ù„Ø©: Ø§Ù„ÙƒÙ„</option>
            <option value="paid">Ø§Ù„Ø­Ø§Ù„Ø©: Ù…Ø¯ÙÙˆØ¹</option>
            <option value="debt">Ø§Ù„Ø­Ø§Ù„Ø©: Ø¯ÙŠÙ†</option>
            <option value="due7">Ø§Ù„Ø­Ø§Ù„Ø©: Ù‚Ø±ÙŠØ¨</option>
            <option value="expired">Ø§Ù„Ø­Ø§Ù„Ø©: Ù…Ù†ØªÙ‡ÙŠ</option>
            <option value="trash">ğŸ—‘ï¸ Ø³Ù„Ø© Ø§Ù„Ù…Ù‡Ù…Ù„Ø§Øª</option>
          </select>
        </div>

        <select id="sortMode" class="input-field">
          <option value="endAsc">ØªØ±ØªÙŠØ¨: Ø§Ù„Ø£Ù‚Ø±Ø¨ Ø§Ù†ØªÙ‡Ø§Ø¡Ù‹</option>
          <option value="endDesc">ØªØ±ØªÙŠØ¨: Ø§Ù„Ø£Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡Ù‹</option>
          <option value="name">ØªØ±ØªÙŠØ¨: Ø§Ù„Ø§Ø³Ù…</option>
        </select>
      </div>

      <div id="main-list" class="space-y-3"></div>
    </section>

  </main>

  <!-- Receipt Modal -->
  <div id="receiptModal" class="fixed inset-0 bg-black/90 hidden z-[60] flex items-center justify-center p-4">
    <div class="w-full max-w-sm">
      <div id="printableReceipt" class="p-6 rounded-[2.5rem] text-slate-900 shadow-2xl text-right relative overflow-hidden"
           style="background: var(--receipt);">
        <div class="absolute top-0 right-0 w-24 h-24 bg-blue-50 rounded-full -mr-12 -mt-12 opacity-70"></div>

        <h3 class="text-4xl font-black text-blue-600 italic text-center mb-1">NAS</h3>
        <p class="text-center text-[10px] font-black opacity-60 mb-4">ÙˆØµÙ„ Ø§Ø´ØªØ±Ø§Ùƒ</p>

        <div class="space-y-3 border-y border-slate-200/70 py-5 font-bold text-sm">
          <div class="flex justify-between"><span>Ø§Ù„Ø²Ø¨ÙˆÙ†:</span> <span id="rName"></span></div>
          <div class="flex justify-between"><span>Ø§Ù„Ø®Ø¯Ù…Ø©:</span> <span id="rService"></span></div>
          <div class="flex justify-between"><span>Ø§Ù„Ø³Ø¹Ø±:</span> <span id="rPrice"></span></div>
          <div class="flex justify-between"><span>Ø§Ù„Ø­Ø§Ù„Ø©:</span> <span id="rPaid"></span></div>
          <div class="flex justify-between"><span>ÙŠÙ†ØªÙ‡ÙŠ ÙÙŠ:</span> <span id="rEnd" class="text-red-600"></span></div>
        </div>

        <div class="mt-4 flex items-center justify-between gap-3">
          <div class="min-w-0">
            <p class="text-[10px] font-black opacity-60">QR</p>
            <div id="qrBox" class="mt-2" style="width:92px;height:92px;border-radius:16px;overflow:hidden;"></div>
            <p id="qrFallback" class="text-[9px] font-black text-slate-600 mt-2 hidden">QR ØºÙŠØ± Ù…ØªØ§Ø­</p>
          </div>

          <!-- Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù†Ø³ØªØºØ±Ø§Ù… Ø«Ù… L11NL -->
          <div class="flex items-center justify-center gap-2 opacity-70">
            <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
              <path fill="#111827" d="M7 2h10a5 5 0 0 1 5 5v10a5 5 0 0 1-5 5H7a5 5 0 0 1-5-5V7a5 5 0 0 1 5-5zm10 2H7a3 3 0 0 0-3 3v10a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3V7a3 3 0 0 0-3-3zm-5 4a5 5 0 1 1 0 10a5 5 0 0 1 0-10zm0 2a3 3 0 1 0 0 6a3 3 0 0 0 0-6zm5.25-2.1a1.1 1.1 0 1 1 0 2.2a1.1 1.1 0 0 1 0-2.2z"/>
            </svg>
            <span class="text-[11px] font-black tracking-wide">L11NL</span>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 gap-2 mt-4">
        <button id="shareReceiptBtn" class="bg-blue-600 text-white p-3 rounded-xl font-black">ğŸ“¤ Ù…Ø´Ø§Ø±ÙƒØ© ÙƒØµÙˆØ±Ø©</button>
        <button id="closeReceiptBtn" class="text-slate-300 text-xs py-2 font-black">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
  </div>

  <!-- Renew Modal (Ø¨Ø³ÙŠØ·) -->
  <div id="renewModal" class="fixed inset-0 bg-black/90 hidden z-[70] flex items-center justify-center p-4">
    <div class="w-full max-w-md glass p-6 rounded-[2.75rem] space-y-4">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-black text-orange-300">âš¡ ØªØ¬Ø¯ÙŠØ¯</h3>
        <button id="closeRenewBtn" class="text-slate-300 font-black text-sm">âœ•</button>
      </div>

      <div class="mini">
        <p class="text-[10px] text-slate-400 font-black">Ø§Ù„Ù…Ø´ØªØ±Ùƒ</p>
        <p class="text-sm font-black" id="renewName">-</p>
        <p class="text-[10px] text-blue-300 font-black mt-1" id="renewService">-</p>
      </div>

      <div class="grid grid-cols-2 gap-2">
        <button id="renewMon" class="chip active">ğŸ“… 30 ÙŠÙˆÙ…</button>
        <button id="renewYear" class="chip">ğŸŒŸ 365 ÙŠÙˆÙ…</button>
      </div>

      <div class="grid grid-cols-2 gap-2">
        <input id="renewPrice" type="number" class="input-field" placeholder="Ø§Ù„Ø³Ø¹Ø± (Ø¯.Ø¹)">
        <input id="renewEnd" type="date" class="input-field">
      </div>

      <div class="grid grid-cols-2 gap-2">
        <button id="renewPaidBtn" class="chip active border-green-500/60">âœ… Ù…Ø¯ÙÙˆØ¹</button>
        <button id="renewDebtBtn" class="chip border-red-500/60">âŒ Ø¯ÙŠÙ†</button>
      </div>

      <button id="confirmRenewBtn" class="w-full bg-orange-600 hover:bg-orange-500 p-4 rounded-2xl font-black shadow-lg">
        âœ… ØªØ«Ø¨ÙŠØª
      </button>
    </div>
  </div>

  <!-- Bottom Sheet (Ø¨Ø¯Ù„ ÙƒØ«Ø±Ø© Ø£Ø²Ø±Ø§Ø± Ø¯Ø§Ø®Ù„ ÙƒÙ„ Ø¨Ø·Ø§Ù‚Ø©) -->
  <div id="sheet" class="fixed inset-0 hidden z-[80]">
    <div id="sheetBackdrop" class="absolute inset-0 bg-black/70"></div>
    <div class="absolute bottom-0 left-0 right-0 p-4">
      <div class="glass rounded-[2.75rem] p-5 space-y-3 max-w-3xl mx-auto">
        <div class="flex items-center justify-between">
          <div class="min-w-0">
            <p id="sheetTitle" class="text-sm font-black truncate">-</p>
            <p id="sheetSub" class="text-[10px] text-slate-400 font-bold truncate">-</p>
          </div>
          <button id="closeSheetBtn" class="text-slate-300 font-black">âœ•</button>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <button id="sheetEdit" class="chip">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
          <button id="sheetRenew" class="chip">âš¡ ØªØ¬Ø¯ÙŠØ¯</button>
          <button id="sheetToggleType" class="chip">ğŸ”„ Ù†Ù‚Ù„ Ù†ÙˆØ¹</button>
          <button id="sheetTrashOrRestore" class="chip border-red-500/40">ğŸ—‘ï¸ Ø­Ø°Ù</button>
        </div>

        <button id="sheetDeleteForever" class="hidden w-full bg-red-600/90 hover:bg-red-600 text-white p-3 rounded-2xl font-black">
          Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ
        </button>

        <p class="text-[10px] text-slate-500 font-bold">
          Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ø­Ø°Ù ÙŠØ±ÙˆØ­ Ø³Ù„Ø© Ø§Ù„Ù…Ù‡Ù…Ù„Ø§Øª Ø£ÙˆÙ„Ø§Ù‹. Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ ÙÙ‚Ø· Ù…Ù† Ø§Ù„Ø³Ù„Ø©.
        </p>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toastHost" class="fixed bottom-6 left-1/2 -translate-x-1/2 z-[90] space-y-2 w-[92%] max-w-md"></div>

<script>
/* =========================
   NAS V8.3 Lite
   - Ø£Ù‚Ù„ Ø£Ø²Ø±Ø§Ø±
   - Ø³Ù„Ø© Ù…Ù‡Ù…Ù„Ø§Øª + Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ
   - ÙˆØµÙ„: IG + L11NL
   - QR Ø«Ø§Ø¨Øª + Ø®Ù„ÙÙŠØ© Ø£ÙˆÙ-ÙˆØ§ÙŠØª
   ========================= */

  // Ù„Ø§ ØªØºÙŠÙ‘Ø± Ù‡Ø°Ø§ Ø§Ù„Ù…ÙØªØ§Ø­ Ø­ØªÙ‰ Ù„Ø§ ØªØ¶ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯Ø§Ù…Ù‰
  const DB = "NAS_STABLE_V5_DATA";
  const LEDGER_KEY = "NAS_LEDGER_V1";   // Ù…ÙˆØ¬ÙˆØ¯ Ù„ÙƒÙ† Ø¨Ø¯ÙˆÙ† ØªØ¹Ù‚ÙŠØ¯ Ø¨Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
  const CONTACT_KEY = "NAS_CONTACTED";

  const $ = (id) => document.getElementById(id);

  const state = {
    clients: [],
    ledger: [],
    contacted: { date: "", keys: [] },

    // UI
    sec: "home",
    editId: null,
    currentPaid: true,
    currentType: "Ø´Ù‡Ø±ÙŠ",
    openReceiptAfterSave: true,

    // List filters
    typeFilter: "Ø§Ù„ÙƒÙ„",
    statusFilter: "all",
    sortMode: "endAsc",
    q: "",

    // Renew
    renewId: null,
    renewDays: 30,
    renewPaid: true,

    // Sheet
    sheetId: null,
  };

  /* Helpers */
  function uid(){
    try{ if (crypto && crypto.randomUUID) return crypto.randomUUID(); }catch(e){}
    return "id-" + Date.now().toString(36) + "-" + Math.random().toString(36).slice(2,9);
  }

  function loadJSON(key, fallback){
    try{
      const raw = localStorage.getItem(key);
      if (!raw) return fallback;
      return JSON.parse(raw);
    }catch(e){ return fallback; }
  }

  function saveJSON(key, value){
    localStorage.setItem(key, JSON.stringify(value));
  }

  function isoDateLocal(d = new Date()){
    const x = new Date(d.getTime() - d.getTimezoneOffset() * 60000);
    return x.toISOString().split("T")[0];
  }

  function parseISODate(iso){
    if (!iso || typeof iso !== "string") return null;
    const [y,m,dd] = iso.split("-").map(Number);
    if (!y || !m || !dd) return null;
    return new Date(y, m-1, dd);
  }

  function startOfDay(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }

  function daysLeft(endIso){
    const end = parseISODate(endIso);
    if (!end) return null;
    const t = startOfDay(new Date());
    const e = startOfDay(end);
    return Math.round((e - t) / (1000*60*60*24));
  }

  function addDaysToISO(baseIso, days){
    const base = parseISODate(baseIso) || new Date();
    base.setDate(base.getDate() + Number(days||0));
    return isoDateLocal(base);
  }

  function formatMoney(n){ return (Number(n||0)).toLocaleString("en-US"); }

  function esc(s){
    return (s ?? "").toString().replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  function normalizePhone(phone){
    let p = (phone||"").toString().trim().replace(/[^\d]/g,"");
    if (p.startsWith("964")) p = p.slice(3);
    p = p.replace(/^0+/, "");
    return p;
  }

  function normalizeInsta(u){
    let s = (u||"").toString().trim();
    s = s.replace(/^https?:\/\/(www\.)?instagram\.com\//,"");
    s = s.replace(/^@/,"");
    s = s.split(/[/?#]/)[0];
    return s;
  }

  function waUrl(phone, text){
    const p = normalizePhone(phone);
    if (!p) return "#";
    const base = `https://wa.me/964${p}`;
    return text ? `${base}?text=${encodeURIComponent(text)}` : base;
  }

  function toast(msg, kind="info"){
    const host = $("toastHost");
    const id = uid();
    const bg = kind==="ok" ? "bg-emerald-600"
             : kind==="warn" ? "bg-orange-600"
             : kind==="err" ? "bg-red-600"
             : "bg-slate-800";

    const el = document.createElement("div");
    el.id = id;
    el.className = `${bg} text-white p-4 rounded-2xl shadow-2xl border border-white/10`;
    el.innerHTML = `
      <div class="flex items-start justify-between gap-3">
        <p class="text-sm font-black leading-relaxed">${esc(msg)}</p>
        <button class="text-white/80 font-black" data-close-toast="${id}">âœ•</button>
      </div>
    `;
    host.appendChild(el);
    setTimeout(()=>{ const n=$(id); if(n) n.remove(); }, 2800);
  }

  function loadContactStore(){
    const today = isoDateLocal(new Date());
    const raw = loadJSON(CONTACT_KEY, null);

    if (Array.isArray(raw)){
      return { date: today, keys: raw };
    }
    if (raw && typeof raw === "object"){
      const date = raw.date || today;
      const keys = Array.isArray(raw.keys) ? raw.keys : [];
      if (date !== today) return { date: today, keys: [] };
      return { date, keys };
    }
    return { date: today, keys: [] };
  }

  function saveContactStore(){ saveJSON(CONTACT_KEY, state.contacted); }

  /* Data migration (ÙŠØ­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø¯Ø§Ù…Ù‰) */
  function migrateClients(){
    let clients = loadJSON(DB, []);
    if (!Array.isArray(clients)) clients = [];

    const nowISO = new Date().toISOString();

    state.clients = clients.map((c) => {
      const obj = (c && typeof c==="object") ? c : {};

      // âœ… Ù„Ùˆ ÙƒØ§Ù† Ø¹Ù†Ø¯Ùƒ Ø£Ø±Ø´ÙŠÙ Ù…Ù† Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©ØŒ Ù†Ø®Ù„ÙŠÙ‡ â€œØ³Ù„Ø©â€ Ø­ØªÙ‰ Ù…Ø§ ÙŠØ¶ÙŠØ¹
      const deleted = (typeof obj.deleted === "boolean") ? obj.deleted : !!obj.archived;

      return {
        ...obj,
        id: obj.id || obj.uuid || obj._id || uid(),
        name: (obj.name||"").toString(),
        phone: (obj.phone||"").toString(),
        insta: (obj.insta||"").toString(),
        service: (obj.service||"Canva Pro").toString(),
        price: Number(obj.price)||0,
        end: (obj.end||"").toString(),
        paid: (typeof obj.paid==="boolean") ? obj.paid : true,
        type: (obj.type||"Ø´Ù‡Ø±ÙŠ").toString(),
        created: (obj.created||obj.createdAt||nowISO).toString(),
        deleted,
        deletedAt: obj.deletedAt || obj.archivedAt || (deleted ? nowISO : null),
      };
    });

    saveJSON(DB, state.clients);
  }

  function migrateLedger(){
    let ledger = loadJSON(LEDGER_KEY, []);
    if (!Array.isArray(ledger)) ledger = [];

    // Ø¥Ø°Ø§ Ù…Ø§ÙƒÙˆ Ø¯ÙØªØ± Ø¹Ù…Ù„ÙŠØ§Øª: Ù†Ù†Ø´Ø¦Ù‡ Ù…Ù† Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† (Ø­ØªÙ‰ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ØªØ´ØªØºÙ„)
    if (ledger.length === 0 && state.clients.length){
      ledger = state.clients
        .filter(c => !c.deleted)
        .map(c => ({
          id: uid(),
          clientId: c.id,
          price: Number(c.price)||0,
          paid: !!c.paid,
          at: c.created || new Date().toISOString()
        }));
      saveJSON(LEDGER_KEY, ledger);
    }

    state.ledger = ledger;
  }

  /* Navigation */
  function showSection(sec){
    ["home","add","list"].forEach(s=>{
      $("sec-"+s).classList.add("hidden");
      $("btn-"+s).classList.remove("active");
    });
    $("sec-"+sec).classList.remove("hidden");
    $("btn-"+sec).classList.add("active");

    const box = $("sec-"+sec);
    box.classList.remove("section-enter"); void box.offsetWidth; box.classList.add("section-enter");

    state.sec = sec;

    if (sec==="home") updateHome();
    if (sec==="list") renderList();
  }

  /* Home stats */
  function computeStats(){
    const now = new Date();
    const today = isoDateLocal(now);
    const month = now.getMonth();
    const year = now.getFullYear();

    let dP=0,dD=0,mP=0,mD=0;

    state.ledger.forEach(tx=>{
      const at = new Date(tx.at || Date.now());
      const day = isoDateLocal(at);
      if (day === today){
        if (tx.paid) dP += Number(tx.price)||0;
        else dD += Number(tx.price)||0;
      }
      if (at.getMonth()===month && at.getFullYear()===year){
        if (tx.paid) mP += Number(tx.price)||0;
        else mD += Number(tx.price)||0;
      }
    });

    // Ø¯ÙŠÙˆÙ† Ø­Ø§Ù„ÙŠØ© (Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ©)
    const totalDebt = state.clients
      .filter(c => !c.deleted)
      .filter(c => !c.paid)
      .reduce((a,c)=>a+(Number(c.price)||0),0);

    let active=0, due7=0, expired=0;
    state.clients.filter(c=>!c.deleted).forEach(c=>{
      const dl = daysLeft(c.end);
      if (dl===null) return;
      if (dl>=0) active++;
      if (dl>=0 && dl<=7) due7++;
      if (dl<0) expired++;
    });

    return { dP,dD,mP,mD,totalDebt,active,due7,expired };
  }

  function updateHome(){
    $("todayLabel").innerText = new Date().toLocaleDateString("ar-IQ", { weekday:"long", year:"numeric", month:"long", day:"numeric" });

    const s = computeStats();
    $("d-paid").innerText = formatMoney(s.dP);
    $("d-debt").innerText = formatMoney(s.dD);
    $("m-paid").innerText = formatMoney(s.mP);
    $("m-debt").innerText = formatMoney(s.mD);

    $("k-active").innerText = s.active.toLocaleString("en-US");
    $("k-due7").innerText = s.due7.toLocaleString("en-US");
    $("k-expired").innerText = s.expired.toLocaleString("en-US");
    $("k-totalDebt").innerText = formatMoney(s.totalDebt);

    renderReminders();
  }

  function renderReminders(){
    const today = isoDateLocal(new Date());
    const tomorrow = addDaysToISO(today, 1);

    function isContacted(c){
      const keyNew = `${c.id}|${c.end}`;
      const keyOld = `${c.name}${c.end}`;
      return state.contacted.keys.includes(keyNew) || state.contacted.keys.includes(keyOld);
    }

    const list = state.clients
      .filter(c => !c.deleted)
      .filter(c => (c.end === today || c.end === tomorrow))
      .filter(c => !isContacted(c));

    const box = $("reminder-list");
    if (!list.length){
      box.innerHTML = `<p class="text-center text-xs text-slate-500 font-black">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ°ÙƒÙŠØ±Ø§Øª ğŸ‰</p>`;
      return;
    }

    box.innerHTML = list.map(c=>{
      const msg = `Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ğŸ˜Š\nØ§Ø´ØªØ±Ø§ÙƒÙƒ ${c.type} (${c.service}) ${c.end===today ? "ÙŠÙ†ØªÙ‡ÙŠ Ø§Ù„ÙŠÙˆÙ…" : "Ø¨Ø§Ú†Ø± ÙŠÙ†ØªÙ‡ÙŠ"}.\nØªØ­Ø¨ Ù†Ø¬Ø¯Ø¯ Ù„ÙƒØŸ`;
      return `
        <div class="mini flex items-center justify-between gap-3 border-r-4 ${c.end===today ? "border-red-500" : "border-orange-500"}">
          <div class="min-w-0">
            <p class="text-xs font-black truncate">${esc(c.name)}</p>
            <p class="text-[10px] text-slate-400 font-bold truncate">${esc(c.service)} â€¢ ÙŠÙ†ØªÙ‡ÙŠ: ${esc(c.end)}</p>
          </div>
          <button class="chip" data-action="remind" data-id="${esc(c.id)}">ÙˆØ§ØªØ³Ø§Ø¨ ğŸ””</button>
        </div>
      `;
    }).join("");
  }

  function markContacted(c){
    const keyNew = `${c.id}|${c.end}`;
    if (!state.contacted.keys.includes(keyNew)){
      state.contacted.keys.push(keyNew);
      saveContactStore();
    }
  }

  /* Add / Edit */
  function syncCustomServiceUI(){
    $("customServiceWrap").classList.toggle("hidden", $("service-select").value !== "CUSTOM");
  }

  function getServiceValue(){
    const sel = $("service-select").value;
    if (sel === "CUSTOM"){
      const v = $("service-custom").value.trim();
      return v || "Ø®Ø¯Ù…Ø© Ø£Ø®Ø±Ù‰";
    }
    return sel;
  }

  function setPaidState(paid){
    state.currentPaid = !!paid;
    $("p-true").classList.toggle("active", state.currentPaid);
    $("p-false").classList.toggle("active", !state.currentPaid);
  }

  function setDuration(days, type){
    state.currentType = type;
    $("durMon").classList.toggle("active", type==="Ø´Ù‡Ø±ÙŠ");
    $("durYear").classList.toggle("active", type==="Ø³Ù†ÙˆÙŠ");

    const base = $("expDate").value || isoDateLocal(new Date());
    $("expDate").value = addDaysToISO(base, days);
  }

  function clearForm(){
    state.editId = null;
    $("name").value = "";
    $("phone").value = "";
    $("price").value = "";
    $("insta").value = "";
    $("service-select").value = "Canva Pro";
    $("service-custom").value = "";
    syncCustomServiceUI();
    setPaidState(true);
    setDuration(30,"Ø´Ù‡Ø±ÙŠ");
    $("mainBtn").innerText = "ğŸ’¾ Ø­ÙØ¸";
  }

  function addLedgerEntry(price, paid){
    state.ledger.unshift({
      id: uid(),
      clientId: state.editId || null,
      price: Number(price)||0,
      paid: !!paid,
      at: new Date().toISOString()
    });
    saveJSON(LEDGER_KEY, state.ledger);
  }

  function saveData(){
    const name = $("name").value.trim();
    const phone = normalizePhone($("phone").value);
    const insta = normalizeInsta($("insta").value);
    const price = Number($("price").value)||0;
    const service = getServiceValue();
    const end = $("expDate").value;

    if (!name || !end){
      toast("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù… ÙˆØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ *", "warn");
      return;
    }

    if (state.editId){
      const idx = state.clients.findIndex(c => c.id === state.editId);
      if (idx === -1) return toast("ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø´ØªØ±Ùƒ.", "err");

      state.clients[idx] = {
        ...state.clients[idx],
        name, phone, insta, price, service, end,
        paid: state.currentPaid,
        type: state.currentType
      };

      saveJSON(DB, state.clients);
      toast("ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ âœ…", "ok");

      if ($("openReceiptAfterSave").checked) openReceiptById(state.clients[idx].id);

      showSection("list");
      renderList();
      updateHome();
      return;
    }

    const client = {
      id: uid(),
      name, phone, insta, price, service, end,
      paid: state.currentPaid,
      type: state.currentType,
      created: new Date().toISOString(),
      deleted: false,
      deletedAt: null
    };

    state.clients.unshift(client);
    saveJSON(DB, state.clients);

    // Ø¹Ù…Ù„ÙŠØ© Ø¨Ø³ÙŠØ·Ø© Ù„Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
    addLedgerEntry(client.price, client.paid);

    toast("ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…", "ok");

    if ($("openReceiptAfterSave").checked) openReceiptById(client.id);

    clearForm();
    updateHome();
    showSection("home");
  }

  function editUser(id){
    const c = state.clients.find(x=>x.id===id);
    if (!c) return toast("Ø§Ù„Ù…Ø´ØªØ±Ùƒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.", "err");

    state.editId = c.id;
    $("name").value = c.name || "";
    $("phone").value = c.phone || "";
    $("price").value = c.price || "";
    $("insta").value = c.insta || "";
    $("expDate").value = c.end || isoDateLocal(new Date());

    const opts = [...$("service-select").options].map(o=>o.value);
    if (opts.includes(c.service)){
      $("service-select").value = c.service;
      $("service-custom").value = "";
    } else {
      $("service-select").value = "CUSTOM";
      $("service-custom").value = c.service || "";
    }
    syncCustomServiceUI();

    state.currentType = c.type || "Ø´Ù‡Ø±ÙŠ";
    $("durMon").classList.toggle("active", state.currentType==="Ø´Ù‡Ø±ÙŠ");
    $("durYear").classList.toggle("active", state.currentType==="Ø³Ù†ÙˆÙŠ");

    setPaidState(!!c.paid);

    $("mainBtn").innerText = "ğŸ”„ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„";
    showSection("add");
  }

  /* List */
  function endValue(c){ return c.end ? c.end : "9999-12-31"; }

  function renderList(){
    const q = ($("search").value||"").toLowerCase().trim();
    const typeFilter = $("typeFilter").value;
    const statusFilter = $("statusFilter").value;
    const sortMode = $("sortMode").value;

    let arr = state.clients.slice();

    // Trash filter
    if (statusFilter === "trash") arr = arr.filter(c=>!!c.deleted);
    else arr = arr.filter(c=>!c.deleted);

    // type filter
    if (typeFilter !== "Ø§Ù„ÙƒÙ„") arr = arr.filter(c => (c.type||"Ø´Ù‡Ø±ÙŠ") === typeFilter);

    // status filter
    if (statusFilter !== "all" && statusFilter !== "trash"){
      arr = arr.filter(c=>{
        const dl = daysLeft(c.end);
        if (dl === null) return false;
        if (statusFilter==="paid") return !!c.paid;
        if (statusFilter==="debt") return !c.paid;
        if (statusFilter==="due7") return dl>=0 && dl<=7;
        if (statusFilter==="expired") return dl<0;
        return true;
      });
    }

    // search
    if (q){
      arr = arr.filter(c=>{
        const hay = `${c.name||""} ${c.phone||""} ${c.service||""} ${c.insta||""}`.toLowerCase();
        return hay.includes(q);
      });
    }

    // sort
    if (sortMode==="endAsc") arr.sort((a,b)=>endValue(a).localeCompare(endValue(b)));
    if (sortMode==="endDesc") arr.sort((a,b)=>endValue(b).localeCompare(endValue(a)));
    if (sortMode==="name") arr.sort((a,b)=>(a.name||"").localeCompare((b.name||""),"ar"));

    $("listCount").innerText = arr.length.toLocaleString("en-US");

    const box = $("main-list");
    if (!arr.length){
      box.innerHTML = `<div class="glass p-6 rounded-[2.5rem] text-center">
        <p class="text-sm font-black text-slate-200">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</p>
      </div>`;
      return;
    }

    box.innerHTML = arr.map(c=>{
      const dl = daysLeft(c.end);
      const border = dl===null ? "border-slate-600"
                  : dl<0 ? "border-red-600"
                  : (!c.paid ? "border-red-400" : (dl<=7 ? "border-orange-500" : "border-green-500"));

      const badge = c.deleted ? "ğŸ—‘ï¸ Ø³Ù„Ø©" : (dl<0 ? "Ù…Ù†ØªÙ‡ÙŠ" : (dl<=7 ? "Ù‚Ø±ÙŠØ¨" : "ÙØ¹Ù‘Ø§Ù„"));

      return `
        <div class="glass p-4 rounded-[2.5rem] border-r-4 ${border}">
          <div class="flex items-start justify-between gap-3">
            <div class="min-w-0">
              <p class="text-sm font-black truncate">${esc(c.name)}</p>
              <p class="text-[10px] text-blue-300 font-black truncate">${esc(c.service)} â€¢ ${formatMoney(c.price)} Ø¯.Ø¹</p>
              <p class="text-[10px] text-slate-400 font-bold mt-1">ÙŠÙ†ØªÙ‡ÙŠ: ${esc(c.end||"-")} â€¢ ${esc(c.type||"Ø´Ù‡Ø±ÙŠ")}</p>
              <p class="text-[10px] font-black mt-1 ${c.deleted ? "text-red-300" : "text-slate-300"}">${esc(badge)}</p>
            </div>

            <!-- Ø£Ø²Ø±Ø§Ø± Ù‚Ù„ÙŠÙ„Ø©: ÙˆØ§ØªØ³Ø§Ø¨ + ÙˆØµÙ„ + Ø§Ù„Ù…Ø²ÙŠØ¯ -->
            <div class="flex flex-col gap-2 items-end">
              <a class="chip !px-3 !py-2" href="${normalizePhone(c.phone) ? waUrl(c.phone) : "#"}" target="_blank" rel="noopener"
                 ${normalizePhone(c.phone) ? "" : 'onclick="return false;" style="opacity:.45; cursor:not-allowed;"'}>
                ÙˆØ§ØªØ³Ø§Ø¨
              </a>
              <button class="chip !px-3 !py-2" data-action="receipt" data-id="${esc(c.id)}">ÙˆØµÙ„</button>
              <button class="chip !px-3 !py-2" data-action="more" data-id="${esc(c.id)}">â‹¯</button>
            </div>
          </div>
        </div>
      `;
    }).join("");
  }

  /* Trash + delete forever */
  function moveToTrash(id){
    const idx = state.clients.findIndex(c=>c.id===id);
    if (idx===-1) return;
    state.clients[idx].deleted = true;
    state.clients[idx].deletedAt = new Date().toISOString();
    saveJSON(DB, state.clients);
    toast("ØªÙ… Ø§Ù„Ù†Ù‚Ù„ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ù‡Ù…Ù„Ø§Øª âœ…", "ok");
    renderList(); updateHome();
  }

  function restoreFromTrash(id){
    const idx = state.clients.findIndex(c=>c.id===id);
    if (idx===-1) return;
    state.clients[idx].deleted = false;
    state.clients[idx].deletedAt = null;
    saveJSON(DB, state.clients);
    toast("ØªÙ…Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© âœ…", "ok");
    renderList(); updateHome();
  }

  function deleteForever(id){
    const idx = state.clients.findIndex(c=>c.id===id);
    if (idx===-1) return;

    const c = state.clients[idx];
    if (!c.deleted){
      toast("Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ ÙÙ‚Ø· Ù…Ù† Ø§Ù„Ø³Ù„Ø©.", "warn");
      return;
    }

    if (!confirm("âš ï¸ Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹.")) return;

    state.clients.splice(idx,1);
    saveJSON(DB, state.clients);
    toast("ØªÙ… Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ âœ…", "ok");
    renderList(); updateHome();
  }

  /* Sheet */
  function openSheet(id){
    state.sheetId = id;
    const c = state.clients.find(x=>x.id===id);
    if (!c) return;

    $("sheetTitle").innerText = c.name || "-";
    $("sheetSub").innerText = `${c.service||"-"} â€¢ ${formatMoney(c.price)} Ø¯.Ø¹ â€¢ ÙŠÙ†ØªÙ‡ÙŠ: ${c.end||"-"}`;

    $("sheetTrashOrRestore").innerText = c.deleted ? "Ø§Ø³ØªØ¹Ø§Ø¯Ø© âœ…" : "ğŸ—‘ï¸ Ø­Ø°Ù";
    $("sheetTrashOrRestore").classList.toggle("border-red-500/40", !c.deleted);
    $("sheetTrashOrRestore").classList.toggle("border-blue-500/40", !!c.deleted);

    $("sheetDeleteForever").classList.toggle("hidden", !c.deleted);

    $("sheet").classList.remove("hidden");
  }

  function closeSheet(){
    $("sheet").classList.add("hidden");
    state.sheetId = null;
  }

  function toggleType(id){
    const idx = state.clients.findIndex(c=>c.id===id);
    if (idx===-1) return;
    const cur = state.clients[idx].type || "Ø´Ù‡Ø±ÙŠ";
    state.clients[idx].type = (cur==="Ø³Ù†ÙˆÙŠ") ? "Ø´Ù‡Ø±ÙŠ" : "Ø³Ù†ÙˆÙŠ";
    saveJSON(DB, state.clients);
    toast(`ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ù†ÙˆØ¹ Ø¥Ù„Ù‰: ${state.clients[idx].type}`, "ok");
    renderList(); updateHome();
  }

  /* Receipt + QR (Ø«Ø§Ø¨Øª) */
  function toBase64Unicode(str){
    // ÙŠØ­ÙˆÙ‘Ù„ Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ø¥Ù„Ù‰ Base64 Ø¨Ø´ÙƒÙ„ Ø¢Ù…Ù† Ø­ØªÙ‰ Ù„Ø§ ÙŠØ®ØªÙÙŠ QR
    return btoa(unescape(encodeURIComponent(str)));
  }

  function renderQRForClient(c){
    const qrBox = $("qrBox");
    const fallback = $("qrFallback");
    qrBox.innerHTML = "";
    fallback.classList.add("hidden");

    const payload = {
      name: c.name || "",
      service: c.service || "",
      price: Number(c.price)||0,
      end: c.end || "",
      paid: c.paid ? 1 : 0
    };

    const safeText = "NAS:" + toBase64Unicode(JSON.stringify(payload));

    // Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø¨Ø³ÙŠØ·Ø© Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¸Ù‡ÙˆØ±
    let tries = 0;
    function tryMake(){
      tries++;
      qrBox.innerHTML = "";
      try{
        if (typeof QRCode === "undefined") throw new Error("QRCode lib not loaded");
        new QRCode(qrBox, { text: safeText, width: 92, height: 92, correctLevel: QRCode.CorrectLevel.M });
        fallback.classList.add("hidden");
      }catch(e){
        if (tries < 3){
          setTimeout(tryMake, 60);
        }else{
          fallback.classList.remove("hidden");
        }
      }
    }
    tryMake();
  }

  function openReceiptById(id){
    const c = state.clients.find(x=>x.id===id);
    if (!c) return toast("Ø§Ù„Ù…Ø´ØªØ±Ùƒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.", "err");

    $("rName").innerText = c.name || "-";
    $("rService").innerText = c.service || "-";
    $("rPrice").innerText = formatMoney(c.price) + " Ø¯.Ø¹";
    $("rPaid").innerText = c.paid ? "Ù…Ø¯ÙÙˆØ¹ âœ…" : "Ø¯ÙŠÙ† âŒ";
    $("rEnd").innerText = c.end || "-";

    $("receiptModal").classList.remove("hidden");

    // Ø¨Ø¹Ø¯ ÙØªØ­ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ù†Ø±Ø³Ù… QR (Ø£Ø¶Ù…Ù†)
    requestAnimationFrame(()=> renderQRForClient(c));
  }

  async function shareReceipt(){
    try{
      const canvas = await html2canvas($("printableReceipt"), {
        scale: 3,
        backgroundColor: getComputedStyle(document.documentElement).getPropertyValue("--receipt").trim() || "#f6f7fb"
      });
      canvas.toBlob(blob=>{
        const file = new File([blob], "NAS_Receipt.png", {type:"image/png"});
        if (navigator.canShare && navigator.canShare({files:[file]})){
          navigator.share({files:[file], title:"NAS Receipt"});
        }else{
          const a=document.createElement("a");
          a.download="NAS_Receipt.png";
          a.href=canvas.toDataURL("image/png");
          a.click();
        }
      });
    }catch(e){
      toast("ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ ØµÙˆØ±Ø© Ø§Ù„ÙˆØµÙ„.", "err");
    }
  }

  /* Renew */
  function openRenewModal(id){
    const c = state.clients.find(x=>x.id===id);
    if (!c) return;

    state.renewId = id;
    $("renewName").innerText = c.name || "-";
    $("renewService").innerText = `${c.service||"-"} â€¢ (${c.type||"Ø´Ù‡Ø±ÙŠ"})`;

    // Ø§ÙØªØ±Ø§Ø¶ÙŠ
    state.renewDays = (c.type==="Ø³Ù†ÙˆÙŠ") ? 365 : 30;
    $("renewMon").classList.toggle("active", state.renewDays===30);
    $("renewYear").classList.toggle("active", state.renewDays===365);

    state.renewPaid = true;
    $("renewPaidBtn").classList.add("active");
    $("renewDebtBtn").classList.remove("active");

    $("renewPrice").value = Number(c.price)||0;

    const today = isoDateLocal(new Date());
    const base = (c.end && c.end >= today) ? c.end : today;
    $("renewEnd").value = addDaysToISO(base, state.renewDays);

    $("renewModal").classList.remove("hidden");
  }

  function confirmRenew(){
    const c = state.clients.find(x=>x.id===state.renewId);
    if (!c) return;

    const newEnd = $("renewEnd").value;
    const price = Number($("renewPrice").value)||0;
    if (!newEnd) return toast("Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ® ØµØ­ÙŠØ­.", "warn");

    c.end = newEnd;
    c.price = price;
    c.paid = state.renewPaid;

    saveJSON(DB, state.clients);

    // Ø³Ø¬Ù„ Ø¹Ù…Ù„ÙŠØ© (Ø­ØªÙ‰ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ØªØªØ­Ø³Ù†)
    addLedgerEntry(price, c.paid);

    toast("ØªÙ… Ø§Ù„ØªØ¬Ø¯ÙŠØ¯ âœ…", "ok");
    $("renewModal").classList.add("hidden");
    renderList(); updateHome();
  }

  /* Events */
  function bindEvents(){
    $("topNav").addEventListener("click", (e)=>{
      const b = e.target.closest("[data-sec]");
      if (!b) return;
      showSection(b.dataset.sec);
    });

    $("goListFromHome").addEventListener("click", ()=> showSection("list"));

    $("service-select").addEventListener("change", syncCustomServiceUI);

    $("durMon").addEventListener("click", ()=> setDuration(30,"Ø´Ù‡Ø±ÙŠ"));
    $("durYear").addEventListener("click", ()=> setDuration(365,"Ø³Ù†ÙˆÙŠ"));

    $("p-true").addEventListener("click", ()=> setPaidState(true));
    $("p-false").addEventListener("click", ()=> setPaidState(false));

    $("resetFormBtn").addEventListener("click", ()=> { clearForm(); toast("ØªÙ… Ø§Ù„ØªÙØ±ÙŠØº âœ…","ok"); });
    $("mainBtn").addEventListener("click", saveData);

    $("search").addEventListener("input", renderList);
    $("typeFilter").addEventListener("change", renderList);
    $("statusFilter").addEventListener("change", renderList);
    $("sortMode").addEventListener("change", renderList);

    // Reminders whatsapp
    $("reminder-list").addEventListener("click", (e)=>{
      const b = e.target.closest("[data-action='remind']");
      if (!b) return;
      const c = state.clients.find(x=>x.id===b.dataset.id);
      if (!c) return;
      const msg = `Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ğŸ˜Š\nØ§Ø´ØªØ±Ø§ÙƒÙƒ ${c.type} (${c.service}) ${c.end===isoDateLocal(new Date())?"ÙŠÙ†ØªÙ‡ÙŠ Ø§Ù„ÙŠÙˆÙ…":"Ø¨Ø§Ú†Ø± ÙŠÙ†ØªÙ‡ÙŠ"}.\nØªØ­Ø¨ Ù†Ø¬Ø¯Ø¯ Ù„ÙƒØŸ`;
      const link = waUrl(c.phone, msg);
      if (link==="#") return toast("Ø£Ø¶Ù Ø±Ù‚Ù… ØµØ­ÙŠØ­ Ø£ÙˆÙ„Ø§Ù‹.", "warn");
      window.open(link, "_blank");
      markContacted(c);
      toast("ØªÙ… ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ âœ…", "ok");
      renderReminders();
    });

    // List actions
    $("main-list").addEventListener("click", (e)=>{
      const a = e.target.closest("[data-action]");
      if (!a) return;
      const id = a.dataset.id;

      if (a.dataset.action === "receipt") return openReceiptById(id);
      if (a.dataset.action === "more") return openSheet(id);
    });

    // Receipt modal
    $("closeReceiptBtn").addEventListener("click", ()=> $("receiptModal").classList.add("hidden"));
    $("shareReceiptBtn").addEventListener("click", shareReceipt);
    $("receiptModal").addEventListener("click", (e)=> { if (e.target === $("receiptModal")) $("receiptModal").classList.add("hidden"); });

    // Renew modal
    $("closeRenewBtn").addEventListener("click", ()=> $("renewModal").classList.add("hidden"));
    $("renewModal").addEventListener("click", (e)=> { if (e.target === $("renewModal")) $("renewModal").classList.add("hidden"); });

    $("renewMon").addEventListener("click", ()=>{
      state.renewDays = 30;
      $("renewMon").classList.add("active");
      $("renewYear").classList.remove("active");
      const c = state.clients.find(x=>x.id===state.renewId);
      if (!c) return;
      const today = isoDateLocal(new Date());
      const base = (c.end && c.end >= today) ? c.end : today;
      $("renewEnd").value = addDaysToISO(base, 30);
    });

    $("renewYear").addEventListener("click", ()=>{
      state.renewDays = 365;
      $("renewYear").classList.add("active");
      $("renewMon").classList.remove("active");
      const c = state.clients.find(x=>x.id===state.renewId);
      if (!c) return;
      const today = isoDateLocal(new Date());
      const base = (c.end && c.end >= today) ? c.end : today;
      $("renewEnd").value = addDaysToISO(base, 365);
    });

    $("renewPaidBtn").addEventListener("click", ()=>{
      state.renewPaid = true;
      $("renewPaidBtn").classList.add("active");
      $("renewDebtBtn").classList.remove("active");
    });
    $("renewDebtBtn").addEventListener("click", ()=>{
      state.renewPaid = false;
      $("renewDebtBtn").classList.add("active");
      $("renewPaidBtn").classList.remove("active");
    });

    $("confirmRenewBtn").addEventListener("click", confirmRenew);

    // Sheet
    $("sheetBackdrop").addEventListener("click", closeSheet);
    $("closeSheetBtn").addEventListener("click", closeSheet);

    $("sheetEdit").addEventListener("click", ()=>{
      const id = state.sheetId; closeSheet(); editUser(id);
    });

    $("sheetRenew").addEventListener("click", ()=>{
      const id = state.sheetId; closeSheet(); openRenewModal(id);
    });

    $("sheetToggleType").addEventListener("click", ()=>{
      const id = state.sheetId; closeSheet(); toggleType(id);
    });

    $("sheetTrashOrRestore").addEventListener("click", ()=>{
      const id = state.sheetId;
      const c = state.clients.find(x=>x.id===id);
      if (!c) return;
      closeSheet();
      if (c.deleted) restoreFromTrash(id);
      else moveToTrash(id);
    });

    $("sheetDeleteForever").addEventListener("click", ()=>{
      const id = state.sheetId;
      closeSheet();
      deleteForever(id);
    });

    // Toast close
    $("toastHost").addEventListener("click", (e)=>{
      const b = e.target.closest("[data-close-toast]");
      if (!b) return;
      const node = $(b.dataset.closeToast);
      if (node) node.remove();
    });

    // ESC closes modals
    document.addEventListener("keydown", (e)=>{
      if (e.key !== "Escape") return;
      $("receiptModal").classList.add("hidden");
      $("renewModal").classList.add("hidden");
      closeSheet();
    });
  }

  function init(){
    migrateClients();
    migrateLedger();
    state.contacted = loadContactStore();

    $("expDate").value = addDaysToISO(isoDateLocal(new Date()), 30);
    syncCustomServiceUI();
    setPaidState(true);
    setDuration(30,"Ø´Ù‡Ø±ÙŠ");

    bindEvents();
    updateHome();
    showSection("home");
  }

  init();
</script>

</body>
</html>
