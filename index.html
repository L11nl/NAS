<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>NAS | Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨Ø³Ø·Ø© V8.6</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b1120" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: { extend: { fontFamily: { cairo: ["Cairo","sans-serif"] } } }
    };
  </script>

  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

  <style>
    :root{
      --bg:#0b1120;
      --panel:rgba(30, 41, 59, 0.68);
      --border:rgba(255,255,255,0.10);
      --text:#e2e8f0;
      --muted:#94a3b8;
      --blue:#3b82f6;
      --green:#22c55e;
      --red:#ef4444;
      --orange:#f59e0b;

      --receipt:#f6f7fb;
    }

    body{
      font-family:'Cairo',sans-serif;
      background:
        radial-gradient(1200px 600px at 70% -10%, rgba(59,130,246,.18), transparent 60%),
        radial-gradient(900px 500px at 10% 10%, rgba(245,158,11,.10), transparent 55%),
        var(--bg);
      color:var(--text);
    }

    .glass{
      background:var(--panel);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      border:1px solid var(--border);
      box-shadow:0 18px 40px rgba(0,0,0,.35);
    }

    .tab-btn{
      transition:.25s ease;
      border-bottom:3px solid transparent;
      opacity:.55;
    }
    .tab-btn.active{
      opacity:1;
      border-color:var(--blue);
      color:var(--blue);
    }

    .input-field{
      background: rgba(30, 41, 59, 0.85);
      border: 1px solid rgba(148,163,184,0.25);
      color: white;
      border-radius: 16px;
      padding: 12px 14px;
      width: 100%;
      outline: none;
      transition:.2s ease;
    }
    .input-field:focus{
      border-color: rgba(59,130,246,.7);
      box-shadow: 0 0 0 4px rgba(59,130,246,.12);
    }

    .mini{
      background: rgba(15,23,42,.55);
      border: 1px solid rgba(148,163,184,.18);
      border-radius: 18px;
      padding: 12px;
    }

    .chip{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      padding:10px 12px;
      border-radius:16px;
      background: rgba(30,41,59,.80);
      border: 1px solid rgba(148,163,184,.22);
      font-weight: 900;
      font-size: 11px;
      user-select:none;
      cursor:pointer;
      transition:.2s ease;
    }
    .chip.active{
      border-color: rgba(59,130,246,.85);
      box-shadow: 0 0 0 4px rgba(59,130,246,.12);
    }

    .icon-btn{
      width:40px;height:40px;
      border-radius:14px;
      display:flex;align-items:center;justify-content:center;
      box-shadow:0 10px 20px rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.12);
      transition:.15s ease;
    }
    .icon-btn:active{ transform: scale(.96); }

    .badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 10px;
      font-weight: 900;
      border: 1px solid rgba(148,163,184,.22);
      background: rgba(15,23,42,.40);
      line-height: 1;
      user-select:none;
    }

    .section-enter{ animation: fadeUp .22s ease-out; }
    @keyframes fadeUp{ from{transform:translateY(10px);opacity:0} to{transform:translateY(0);opacity:1} }

    .btn-primary{
      background: var(--blue);
      color: #fff;
    }
    .btn-primary:hover{ filter: brightness(1.07); }

    .btn-warn{
      background: var(--orange);
      color: #fff;
    }
    .btn-warn:hover{ filter: brightness(1.07); }

    .btn-danger{
      background: var(--red);
      color: #fff;
    }
    .btn-danger:hover{ filter: brightness(1.07); }

    @media (prefers-reduced-motion: reduce){
      .section-enter,.tab-btn,.chip,.input-field,.icon-btn{animation:none!important;transition:none!important}
    }
  </style>

  <!-- âœ… CSS Ù…Ø®ØµØµ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
  <style id="customStyle"></style>
</head>

<body class="pb-24 font-cairo">

  <!-- Nav -->
  <nav id="topNav" class="flex bg-slate-900/80 border-b border-slate-800 sticky top-0 z-50 shadow-2xl backdrop-blur-xl">
    <button data-sec="home" id="btn-home" class="tab-btn active flex-1 p-4 font-black text-xs text-center">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
    <button data-sec="add"  id="btn-add"  class="tab-btn flex-1 p-4 font-black text-xs text-center">â• Ø¥Ø¶Ø§ÙØ©</button>
    <button data-sec="list" id="btn-list" class="tab-btn flex-1 p-4 font-black text-xs text-center">ğŸ” Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</button>
    <button data-sec="settings" id="btn-settings" class="tab-btn flex-1 p-4 font-black text-xs text-center">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
  </nav>

  <main class="p-4 max-w-3xl mx-auto space-y-6">

    <!-- HOME -->
    <section id="sec-home" class="space-y-4 section-enter">
      <div class="glass p-6 rounded-[2.75rem]">
        <div class="flex items-start justify-between gap-3">
          <div>
            <h1 id="appTitle" class="text-3xl font-black leading-tight" style="color: var(--blue)">NAS</h1>
            <p id="appVersion" class="text-xs text-slate-400 font-bold">V8.6 â€¢ Ù…Ø¨Ø³Ø·</p>
          </div>
          <div class="text-left">
            <p class="text-[10px] text-slate-400 font-black">Ø§Ù„ÙŠÙˆÙ…</p>
            <p id="todayLabel" class="text-sm font-black"></p>
          </div>
        </div>

        <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ØµØºÙŠØ±Ø© -->
        <div class="mt-5 grid grid-cols-2 md:grid-cols-4 gap-2">
          <div class="mini">
            <p class="text-[10px] text-slate-400 font-black">ÙƒØ§Ø´ Ø§Ù„ÙŠÙˆÙ…</p>
            <p id="d-paid" class="text-lg font-black text-green-300">0</p>
          </div>
          <div class="mini">
            <p class="text-[10px] text-slate-400 font-black">Ø¯ÙŠÙˆÙ† Ø§Ù„ÙŠÙˆÙ…</p>
            <p id="d-debt" class="text-lg font-black text-red-300">0</p>
          </div>
          <div class="mini">
            <p class="text-[10px] text-slate-400 font-black">ÙƒØ§Ø´ Ø§Ù„Ø´Ù‡Ø±</p>
            <p id="m-paid" class="text-lg font-black text-green-300">0</p>
          </div>
          <div class="mini">
            <p class="text-[10px] text-slate-400 font-black">Ø¯ÙŠÙˆÙ† Ø§Ù„Ø´Ù‡Ø±</p>
            <p id="m-debt" class="text-lg font-black text-red-300">0</p>
          </div>
        </div>

        <div class="mt-3 grid grid-cols-2 md:grid-cols-4 gap-2">
          <div class="mini">
            <p class="text-[10px] text-slate-400 font-black">ÙØ¹Ù‘Ø§Ù„ÙŠÙ†</p>
            <p id="k-active" class="text-lg font-black text-emerald-200">0</p>
          </div>
          <div class="mini">
            <p class="text-[10px] text-slate-400 font-black">Ù‚Ø±ÙŠØ¨ (7 Ø£ÙŠØ§Ù…)</p>
            <p id="k-due7" class="text-lg font-black text-orange-200">0</p>
          </div>
          <div class="mini">
            <p class="text-[10px] text-slate-400 font-black">Ù…Ù†ØªÙ‡ÙŠØ©</p>
            <p id="k-expired" class="text-lg font-black text-red-200">0</p>
          </div>
          <div class="mini">
            <p class="text-[10px] text-slate-400 font-black">Ø¯ÙŠÙˆÙ† Ø­Ø§Ù„ÙŠØ©</p>
            <p id="k-totalDebt" class="text-lg font-black text-red-200">0</p>
          </div>
        </div>
      </div>

      <!-- ØªØ°ÙƒÙŠØ±Ø§Øª -->
      <div class="glass p-5 rounded-[2.75rem] space-y-3">
        <div class="flex items-center justify-between">
          <h3 class="text-sm font-black" style="color: var(--orange)">ğŸ”” ØªØ°ÙƒÙŠØ±Ø§Øª (Ø§Ù„ÙŠÙˆÙ…/Ø¨Ø§Ú†Ø±)</h3>
          <button id="goListFromHome" class="text-xs font-black text-blue-300 hover:text-blue-200" data-haptic>Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„ â†’</button>
        </div>
        <div id="reminder-list" class="space-y-3"></div>
      </div>
    </section>

    <!-- ADD -->
    <section id="sec-add" class="hidden space-y-4 section-enter">
      <div class="glass p-6 rounded-[2.75rem] space-y-4">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-black" style="color: var(--blue)">â• Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„</h2>
          <button id="resetFormBtn" class="text-xs font-black text-slate-300 hover:text-white" data-haptic>ØªÙØ±ÙŠØº</button>
        </div>

        <input id="name" class="input-field" placeholder="Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ† Ø§Ù„ÙƒØ§Ù…Ù„ *">

        <div class="grid grid-cols-2 gap-2">
          <input id="phone" type="tel" class="input-field" placeholder="77XXXXXXXX">
          <input id="price" type="number" class="input-field" placeholder="Ø§Ù„Ø³Ø¹Ø± (Ø¯.Ø¹)">
        </div>

        <div class="grid grid-cols-2 gap-2">
          <select id="service-select" class="input-field">
            <option value="Canva Pro">Canva Pro</option>
            <option value="ChatGPT">ChatGPT</option>
            <option value="CapCut">CapCut</option>
            <option value="YouTube Premium">YouTube Premium</option>
            <option value="Netflix">Netflix</option>
            <option value="Spotify">Spotify</option>
            <option value="Office 365">Office 365</option>
            <option value="CUSTOM">Ø£Ø®Ø±Ù‰ +</option>
          </select>
          <input id="insta" class="input-field" placeholder="ÙŠÙˆØ²Ø± Ø§Ù†Ø³ØªØºØ±Ø§Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
        </div>

        <div id="customServiceWrap" class="hidden">
          <input id="service-custom" class="input-field" placeholder="Ø§Ø³Ù… Ø§Ù„Ø®Ø¯Ù…Ø© (Ù…Ø«Ø§Ù„: VPN / Adobe ...)" />
        </div>

        <div class="glass p-4 rounded-3xl border border-slate-700/50 space-y-3">
          <p class="text-xs font-black text-slate-200">â±ï¸ Ù…Ø¯Ø© + ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ *</p>
          <div class="grid grid-cols-2 gap-2">
            <button id="durMon" class="chip active" data-haptic>ğŸ“… Ø´Ù‡Ø±ÙŠ</button>
            <button id="durYear" class="chip" data-haptic>ğŸŒŸ Ø³Ù†ÙˆÙŠ</button>
          </div>
          <input type="date" id="expDate" class="input-field">
          <p class="text-[10px] text-slate-400 font-bold">
            âœ… ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© "Ø´Ù‡Ø±ÙŠ" (Ù„Ù… ÙŠØ¹Ø¯ ÙŠØ¶ÙŠÙ Ø´Ù‡Ø± ÙÙˆÙ‚ Ø´Ù‡Ø± + ÙŠØ¹ØªÙ…Ø¯ Ø´Ù‡Ø± ØªÙ‚ÙˆÙŠÙ… Ø­ØªÙ‰ Ù„Ø§ ÙŠÙ‚ÙØ² Ø¥Ù„Ù‰ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø«Ø§Ù„Ø«).
          </p>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <button id="p-true" class="chip active border-green-500/60" data-haptic>âœ… Ù…Ø¯ÙÙˆØ¹</button>
          <button id="p-false" class="chip border-red-500/60" data-haptic>âŒ ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹</button>
        </div>

        <div class="flex items-center justify-between mini">
          <p class="text-xs font-black text-slate-200">ÙØªØ­ Ø§Ù„ÙˆØµÙ„ Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸</p>
          <label class="flex items-center gap-2 cursor-pointer">
            <input id="openReceiptAfterSave" type="checkbox" class="accent-blue-500" checked>
            <span class="text-xs font-black text-slate-300">Ù†Ø¹Ù…</span>
          </label>
        </div>

        <button id="mainBtn" class="btn-primary w-full p-4 rounded-2xl font-black shadow-lg" data-haptic>
          ğŸ’¾ Ø­ÙØ¸
        </button>
      </div>
    </section>

    <!-- LIST -->
    <section id="sec-list" class="hidden space-y-4 section-enter">
      <div class="glass p-5 rounded-[2.75rem] space-y-4">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-black" style="color: var(--blue)">ğŸ” Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</h2>
          <p class="text-[10px] text-slate-500 font-black">Ù†ØªØ§Ø¦Ø¬: <span id="listCount">0</span></p>
        </div>

        <input id="search" class="input-field" placeholder="Ø¨Ø­Ø«: Ø§Ù„Ø§Ø³Ù… / Ø§Ù„Ø±Ù‚Ù… / Ø§Ù„Ø®Ø¯Ù…Ø© / Ø§Ù„Ø§Ù†Ø³ØªØ§ ...">

        <!-- âœ… ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø³Ø±ÙŠØ¹Ø© -->
        <div id="typeTabs" class="grid grid-cols-3 gap-2">
          <button id="tabAll"  class="chip active" data-type-tab="Ø§Ù„ÙƒÙ„" data-haptic>âœ¨ Ø§Ù„ÙƒÙ„</button>
          <button id="tabMon"  class="chip" data-type-tab="Ø´Ù‡Ø±ÙŠ" data-haptic>ğŸ“… Ø´Ù‡Ø±ÙŠ</button>
          <button id="tabYear" class="chip" data-type-tab="Ø³Ù†ÙˆÙŠ" data-haptic>ğŸŒŸ Ø³Ù†ÙˆÙŠ</button>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <select id="typeFilter" class="input-field">
            <option value="Ø§Ù„ÙƒÙ„">Ø§Ù„Ù†ÙˆØ¹: Ø§Ù„ÙƒÙ„</option>
            <option value="Ø´Ù‡Ø±ÙŠ">Ø§Ù„Ù†ÙˆØ¹: Ø´Ù‡Ø±ÙŠ</option>
            <option value="Ø³Ù†ÙˆÙŠ">Ø§Ù„Ù†ÙˆØ¹: Ø³Ù†ÙˆÙŠ</option>
          </select>

          <select id="statusFilter" class="input-field">
            <option value="all">Ø§Ù„Ø­Ø§Ù„Ø©: Ø§Ù„ÙƒÙ„</option>
            <option value="paid">Ø§Ù„Ø­Ø§Ù„Ø©: Ù…Ø¯ÙÙˆØ¹</option>
            <option value="debt">Ø§Ù„Ø­Ø§Ù„Ø©: ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹</option>
            <option value="due7">Ø§Ù„Ø­Ø§Ù„Ø©: Ù‚Ø±ÙŠØ¨</option>
            <option value="expired">Ø§Ù„Ø­Ø§Ù„Ø©: Ù…Ù†ØªÙ‡ÙŠ</option>
            <option value="trash">ğŸ—‘ï¸ Ø³Ù„Ø© Ø§Ù„Ù…Ù‡Ù…Ù„Ø§Øª</option>
          </select>
        </div>

        <select id="sortMode" class="input-field">
          <option value="endAsc">ØªØ±ØªÙŠØ¨: Ø§Ù„Ø£Ù‚Ø±Ø¨ Ø§Ù†ØªÙ‡Ø§Ø¡Ù‹</option>
          <option value="endDesc">ØªØ±ØªÙŠØ¨: Ø§Ù„Ø£Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡Ù‹</option>
          <option value="name">ØªØ±ØªÙŠØ¨: Ø§Ù„Ø§Ø³Ù…</option>
        </select>
      </div>

      <div id="main-list" class="space-y-3"></div>
    </section>

    <!-- SETTINGS -->
    <section id="sec-settings" class="hidden space-y-4 section-enter">
      <div class="glass p-6 rounded-[2.75rem] space-y-5">

        <div class="flex items-center justify-between">
          <h2 class="text-lg font-black" style="color: var(--blue)">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹</h2>
          <button id="resetSettingsBtn" class="text-xs font-black text-slate-300 hover:text-white" data-haptic>Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ</button>
        </div>

        <!-- Theme -->
        <div class="mini space-y-3">
          <p class="text-xs font-black text-slate-200">ğŸ¨ Ø§Ù„Ø³Ù…Ø© (Ø§Ù„Ø£Ù„ÙˆØ§Ù†)</p>

          <div class="grid grid-cols-2 gap-2">
            <div>
              <p class="text-[10px] text-slate-400 font-black mb-1">Ø§Ù„Ø®Ù„ÙÙŠØ©</p>
              <input id="set-bg" type="color" class="input-field !p-2 !h-12">
            </div>
            <div>
              <p class="text-[10px] text-slate-400 font-black mb-1">Ø§Ù„Ù†Øµ</p>
              <input id="set-text" type="color" class="input-field !p-2 !h-12">
            </div>

            <div>
              <p class="text-[10px] text-slate-400 font-black mb-1">Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</p>
              <input id="set-blue" type="color" class="input-field !p-2 !h-12">
            </div>
            <div>
              <p class="text-[10px] text-slate-400 font-black mb-1">Ù„ÙˆÙ† Ø§Ù„ØªØ­Ø°ÙŠØ±</p>
              <input id="set-orange" type="color" class="input-field !p-2 !h-12">
            </div>

            <div>
              <p class="text-[10px] text-slate-400 font-black mb-1">Ù„ÙˆÙ† Ø§Ù„Ù†Ø¬Ø§Ø­</p>
              <input id="set-green" type="color" class="input-field !p-2 !h-12">
            </div>
            <div>
              <p class="text-[10px] text-slate-400 font-black mb-1">Ù„ÙˆÙ† Ø§Ù„Ø®Ø·Ø±</p>
              <input id="set-red" type="color" class="input-field !p-2 !h-12">
            </div>
          </div>

          <div class="grid grid-cols-1 gap-2">
            <div>
              <p class="text-[10px] text-slate-400 font-black mb-1">Ù„ÙˆÙ† Ø§Ù„Ù„ÙˆØ­Ø§Øª (panel) - ÙŠØ¯Ø¹Ù… rgba</p>
              <input id="set-panel" class="input-field" placeholder="Ù…Ø«Ø§Ù„: rgba(30, 41, 59, 0.68)">
            </div>
            <div>
              <p class="text-[10px] text-slate-400 font-black mb-1">Ù„ÙˆÙ† Ø§Ù„Ø­Ø¯ÙˆØ¯ (border) - ÙŠØ¯Ø¹Ù… rgba</p>
              <input id="set-border" class="input-field" placeholder="Ù…Ø«Ø§Ù„: rgba(255,255,255,0.10)">
            </div>
            <div>
              <p class="text-[10px] text-slate-400 font-black mb-1">Ù„ÙˆÙ† Ø§Ù„Ù†Øµ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ (muted)</p>
              <input id="set-muted" type="color" class="input-field !p-2 !h-12">
            </div>
            <div>
              <p class="text-[10px] text-slate-400 font-black mb-1">Ø®Ù„ÙÙŠØ© Ø§Ù„ÙˆØµÙ„ (receipt)</p>
              <input id="set-receipt" type="color" class="input-field !p-2 !h-12">
            </div>
          </div>
        </div>

        <!-- Branding -->
        <div class="mini space-y-3">
          <p class="text-xs font-black text-slate-200">ğŸ·ï¸ Ù‡ÙˆÙŠØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹</p>
          <div class="grid grid-cols-2 gap-2">
            <input id="set-appName" class="input-field" placeholder="Ø§Ø³Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚">
            <input id="set-versionLabel" class="input-field" placeholder="Ø³Ø·Ø± Ø§Ù„Ø¥ØµØ¯Ø§Ø± (Ù…Ø«Ø§Ù„: V8.6 â€¢ Ù…Ø¨Ø³Ø·)">
          </div>

          <div class="grid grid-cols-2 gap-2">
            <input id="set-igHandle" class="input-field" placeholder="ÙŠÙˆØ²Ø± Ø§Ù„Ø§Ù†Ø³ØªØºØ±Ø§Ù… (Ø¨Ø¯ÙˆÙ† @)">
            <input id="set-igUrl" class="input-field" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ø§Ù†Ø³ØªØºØ±Ø§Ù… Ù„Ù„Ù€ QR">
          </div>

          <p class="text-[10px] text-slate-400 font-bold">
            Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„ÙŠÙˆØ²Ø± ÙŠÙØ³ØªØ®Ø¯Ù… Ù„Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·ØŒ ÙˆØ§Ù„Ø±Ø§Ø¨Ø· ÙŠÙØ³ØªØ®Ø¯Ù… Ù„Ù„Ù€ QR.
          </p>
        </div>

        <!-- Defaults -->
        <div class="mini space-y-3">
          <p class="text-xs font-black text-slate-200">âš™ï¸ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</p>

          <div class="grid grid-cols-2 gap-2">
            <select id="set-durationDefault" class="input-field">
              <option value="Ø´Ù‡Ø±ÙŠ">Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø§Ù„Ù…Ø¯Ø©: Ø´Ù‡Ø±ÙŠ</option>
              <option value="Ø³Ù†ÙˆÙŠ">Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø§Ù„Ù…Ø¯Ø©: Ø³Ù†ÙˆÙŠ</option>
            </select>

            <div class="mini flex items-center justify-between gap-3">
              <span class="text-xs font-black text-slate-200">ÙØªØ­ Ø§Ù„ÙˆØµÙ„ Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸</span>
              <input id="set-openReceiptDefault" type="checkbox" class="accent-blue-500">
            </div>
          </div>

          <div class="grid grid-cols-2 gap-2">
            <select id="set-monthlyMode" class="input-field">
              <option value="month">Ø§Ù„Ø´Ù‡Ø± = Ø´Ù‡Ø± ØªÙ‚ÙˆÙŠÙ… (Ù…ÙØ¶Ù„)</option>
              <option value="30days">Ø§Ù„Ø´Ù‡Ø± = 30 ÙŠÙˆÙ…</option>
            </select>

            <select id="set-yearlyMode" class="input-field">
              <option value="year">Ø§Ù„Ø³Ù†Ø© = Ø³Ù†Ø© ØªÙ‚ÙˆÙŠÙ… (Ù…ÙØ¶Ù„)</option>
              <option value="365days">Ø§Ù„Ø³Ù†Ø© = 365 ÙŠÙˆÙ…</option>
            </select>
          </div>

          <p class="text-[10px] text-slate-400 font-bold">
            âœ… "Ø´Ù‡Ø± ØªÙ‚ÙˆÙŠÙ…" ÙŠØ­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ù‚ÙØ² Ø¥Ù„Ù‰ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø«Ø§Ù„Ø« Ø¹Ù†Ø¯ Ù†Ù‡Ø§ÙŠØ§Øª Ø§Ù„Ø£Ø´Ù‡Ø±.
          </p>
        </div>

        <!-- Custom CSS -->
        <div class="mini space-y-3">
          <p class="text-xs font-black text-slate-200">ğŸ§© CSS Ù…Ø®ØµØµ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</p>
          <textarea id="set-customCSS" class="input-field" rows="6" placeholder="Ø§ÙƒØªØ¨ CSS Ù‡Ù†Ø§ Ù„ØªØ¹Ø¯ÙŠÙ„ Ø£ÙŠ Ø´ÙŠØ¡ Ø¨Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©..."></textarea>
          <p class="text-[10px] text-slate-400 font-bold">ÙŠÙØ·Ø¨Ù‚ Ø¨Ø¹Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ (ØªØ·Ø¨ÙŠÙ‚) Ø£Ùˆ (Ø­ÙØ¸).</p>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <button id="saveSettingsBtn" class="btn-primary w-full p-4 rounded-2xl font-black shadow-lg" data-haptic>ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
          <button id="applySettingsBtn" class="chip w-full !py-4" data-haptic>ğŸ‘ï¸ ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø¯ÙˆÙ† Ø­ÙØ¸</button>
        </div>

        <!-- Backup -->
        <div class="mini space-y-3">
          <p class="text-xs font-black text-slate-200">ğŸ’¾ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</p>
          <textarea id="backupBox" class="input-field" rows="6" placeholder="Ø§Ø¶ØºØ· (ØªØµØ¯ÙŠØ±) Ø£Ùˆ Ø§Ù„ØµÙ‚ Ø§Ù„Ù†Ø³Ø®Ø© Ù‡Ù†Ø§ Ù„Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯"></textarea>
          <div class="grid grid-cols-3 gap-2">
            <button id="exportBackupBtn" class="chip !py-3" data-haptic>ØªØµØ¯ÙŠØ±</button>
            <button id="importBackupBtn" class="chip !py-3" data-haptic>Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
            <button id="clearAllBtn" class="chip !py-3 border-red-500/40" data-haptic>Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
          </div>
          <p class="text-[10px] text-slate-500 font-bold">
            Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„ ÙŠØ­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø² ÙÙ‚Ø· (localStorage).
          </p>
        </div>

      </div>
    </section>

  </main>

  <!-- Receipt Modal -->
  <div id="receiptModal" class="fixed inset-0 bg-black/90 hidden z-[60] flex items-center justify-center p-4">
    <div class="w-full max-w-sm">
      <div id="printableReceipt" class="p-6 rounded-[2.5rem] text-slate-900 shadow-2xl text-right relative overflow-hidden"
           style="background: var(--receipt);">
        <div class="absolute top-0 right-0 w-24 h-24 bg-blue-50 rounded-full -mr-12 -mt-12 opacity-70"></div>

        <h3 id="receiptBrand" class="text-4xl font-black text-blue-600 italic text-center mb-1">NAS</h3>
        <p class="text-center text-[10px] font-black opacity-60 mb-4">ÙˆØµÙ„ Ø§Ø´ØªØ±Ø§Ùƒ</p>

        <div class="space-y-3 border-y border-slate-200/70 py-5 font-bold text-sm">
          <div class="flex justify-between"><span>Ø§Ù„Ø²Ø¨ÙˆÙ†:</span> <span id="rName"></span></div>
          <div class="flex justify-between"><span>Ø§Ù„Ø®Ø¯Ù…Ø©:</span> <span id="rService"></span></div>
          <div class="flex justify-between"><span>Ø§Ù„Ø³Ø¹Ø±:</span> <span id="rPrice"></span></div>
          <div class="flex justify-between"><span>Ø§Ù„Ø­Ø§Ù„Ø©:</span> <span id="rPaid"></span></div>
          <div class="flex justify-between"><span>ÙŠÙ†ØªÙ‡ÙŠ ÙÙŠ:</span> <span id="rEnd" class="text-red-600"></span></div>
        </div>

        <div class="mt-4 flex items-center justify-between gap-3">
          <div class="min-w-0 text-center">
            <p class="text-[10px] font-black text-slate-700">Ø­Ø³Ø§Ø¨Ù†Ø§ Ø¹Ù„Ù‰ Ø§Ù†Ø³ØªØºØ±Ø§Ù…</p>
            <p class="text-[14px] font-black text-slate-700 leading-none">â¬‡ï¸</p>

            <div id="qrBox"
                 class="mt-2 mx-auto"
                 style="width:92px;height:92px;border-radius:16px;overflow:hidden;background:#fff;border:1px solid rgba(15,23,42,.10);"></div>

            <p id="qrFallback" class="text-[9px] font-black text-slate-600 mt-2 hidden">QR ØºÙŠØ± Ù…ØªØ§Ø­</p>
            <p id="receiptIG" class="text-[9px] font-black text-slate-600 mt-1">@l11nl</p>
          </div>

          <div class="flex items-center justify-center gap-2 opacity-70">
            <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
              <path fill="#111827" d="M7 2h10a5 5 0 0 1 5 5v10a5 5 0 0 1-5 5H7a5 5 0 0 1-5-5V7a5 5 0 0 1 5-5zm10 2H7a3 3 0 0 0-3 3v10a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3V7a3 3 0 0 0-3-3zm-5 4a5 5 0 1 1 0 10a5 5 0 0 1 0-10zm0 2a3 3 0 1 0 0 6a3 3 0 0 0 0-6zm5.25-2.1a1.1 1.1 0 1 1 0 2.2a1.1 1.1 0 0 1 0-2.2z"/>
            </svg>
            <span id="receiptIGHandle" class="text-[11px] font-black tracking-wide">L11NL</span>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 gap-2 mt-4">
        <button id="shareReceiptBtn" class="btn-primary text-white p-3 rounded-xl font-black" data-haptic>ğŸ“¤ Ù…Ø´Ø§Ø±ÙƒØ© ÙƒØµÙˆØ±Ø©</button>
        <button id="closeReceiptBtn" class="text-slate-300 text-xs py-2 font-black" data-haptic>Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
  </div>

  <!-- Renew Modal -->
  <div id="renewModal" class="fixed inset-0 bg-black/90 hidden z-[70] flex items-center justify-center p-4">
    <div class="w-full max-w-md glass p-6 rounded-[2.75rem] space-y-4">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-black" style="color: var(--orange)">âš¡ ØªØ¬Ø¯ÙŠØ¯</h3>
        <button id="closeRenewBtn" class="text-slate-300 font-black text-sm" data-haptic>âœ•</button>
      </div>

      <div class="mini">
        <p class="text-[10px] text-slate-400 font-black">Ø§Ù„Ù…Ø´ØªØ±Ùƒ</p>
        <p class="text-sm font-black" id="renewName">-</p>
        <p class="text-[10px] text-blue-300 font-black mt-1" id="renewService">-</p>
      </div>

      <div class="grid grid-cols-2 gap-2">
        <button id="renewMon" class="chip active" data-haptic>ğŸ“… Ø´Ù‡Ø±ÙŠ</button>
        <button id="renewYear" class="chip" data-haptic>ğŸŒŸ Ø³Ù†ÙˆÙŠ</button>
      </div>

      <div class="grid grid-cols-2 gap-2">
        <input id="renewPrice" type="number" class="input-field" placeholder="Ø§Ù„Ø³Ø¹Ø± (Ø¯.Ø¹)">
        <input id="renewEnd" type="date" class="input-field">
      </div>

      <div class="grid grid-cols-2 gap-2">
        <button id="renewPaidBtn" class="chip active border-green-500/60" data-haptic>âœ… Ù…Ø¯ÙÙˆØ¹</button>
        <button id="renewDebtBtn" class="chip border-red-500/60" data-haptic>âŒ ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹</button>
      </div>

      <button id="confirmRenewBtn" class="btn-warn w-full p-4 rounded-2xl font-black shadow-lg" data-haptic>
        âœ… ØªØ«Ø¨ÙŠØª
      </button>
    </div>
  </div>

  <!-- Bottom Sheet -->
  <div id="sheet" class="fixed inset-0 hidden z-[80]">
    <div id="sheetBackdrop" class="absolute inset-0 bg-black/70"></div>
    <div class="absolute bottom-0 left-0 right-0 p-4">
      <div class="glass rounded-[2.75rem] p-5 space-y-3 max-w-3xl mx-auto">
        <div class="flex items-center justify-between">
          <div class="min-w-0">
            <p id="sheetTitle" class="text-sm font-black truncate">-</p>
            <p id="sheetSub" class="text-[10px] text-slate-400 font-bold truncate">-</p>
          </div>
          <button id="closeSheetBtn" class="text-slate-300 font-black" data-haptic>âœ•</button>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <button id="sheetEdit" class="chip" data-haptic>âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
          <button id="sheetRenew" class="chip" data-haptic>âš¡ ØªØ¬Ø¯ÙŠØ¯</button>
          <button id="sheetToggleType" class="chip" data-haptic>ğŸ”„ Ù†Ù‚Ù„ Ù†ÙˆØ¹</button>
          <button id="sheetTrashOrRestore" class="chip border-red-500/40" data-haptic>ğŸ—‘ï¸ Ø­Ø°Ù</button>
        </div>

        <button id="sheetDeleteForever" class="hidden btn-danger w-full text-white p-3 rounded-2xl font-black" data-haptic>
          Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ
        </button>

        <p class="text-[10px] text-slate-500 font-bold">
          Ø§Ù„Ø­Ø°Ù ÙŠØ±ÙˆØ­ Ø³Ù„Ø© Ø§Ù„Ù…Ù‡Ù…Ù„Ø§Øª Ø£ÙˆÙ„Ø§Ù‹. Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ ÙÙ‚Ø· Ù…Ù† Ø§Ù„Ø³Ù„Ø©.
        </p>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toastHost" class="fixed bottom-6 left-1/2 -translate-x-1/2 z-[90] space-y-2 w-[92%] max-w-md"></div>

<script>
/* =========================
   NAS V8.6
   âœ… Ø¥ØµÙ„Ø§Ø­ "Ø´Ù‡Ø±ÙŠ":
   - ØµØ§Ø± ÙŠØ¹ØªÙ…Ø¯ Ø´Ù‡Ø± ØªÙ‚ÙˆÙŠÙ… (addMonths) Ø¨Ø¯Ù„ 30 ÙŠÙˆÙ…
   - Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…ØªÙƒØ±Ø± Ø¹Ù„Ù‰ "Ø´Ù‡Ø±ÙŠ" Ù„Ø§ ÙŠØ±Ø§ÙƒÙ… (ÙŠØ¨Ù‚Ù‰ Ø«Ø§Ø¨Øª)
   âœ… Ø¥Ø¶Ø§ÙØ© ØµÙØ­Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Ø«ÙŠÙ… + Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Øª + CSS + Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ)
   ========================= */

  const DB = "NAS_STABLE_V5_DATA";
  const LEDGER_KEY = "NAS_LEDGER_V1";
  const CONTACT_KEY = "NAS_CONTACTED";
  const SETTINGS_KEY = "NAS_SETTINGS_V1";

  const DEFAULT_SETTINGS = Object.freeze({
    theme: {
      bg: "#0b1120",
      panel: "rgba(30, 41, 59, 0.68)",
      border: "rgba(255,255,255,0.10)",
      text: "#e2e8f0",
      muted: "#94a3b8",
      blue: "#3b82f6",
      green: "#22c55e",
      red: "#ef4444",
      orange: "#f59e0b",
      receipt: "#f6f7fb",
    },
    branding: {
      appName: "NAS",
      versionLabel: "V8.6 â€¢ Ù…Ø¨Ø³Ø·",
      instagramHandle: "l11nl",
      instagramUrl: "https://www.instagram.com/l11nl?igsh=YnF0bTU4MXAyamZ3",
    },
    defaults: {
      durationType: "Ø´Ù‡Ø±ÙŠ",
      monthlyMode: "month",   // month | 30days
      yearlyMode: "year",     // year  | 365days
      openReceiptAfterSave: true,
    },
    customCSS: ""
  });

  const $ = (id) => document.getElementById(id);

  const state = {
    clients: [],
    ledger: [],
    contacted: { date: "", keys: [] },

    settings: null,

    sec: "home",
    editId: null,
    currentPaid: true,
    currentType: "Ø´Ù‡Ø±ÙŠ",
    expAnchorISO: null,

    renewId: null,
    renewType: "Ø´Ù‡Ø±ÙŠ",
    renewAnchorISO: null,
    renewPaid: true,

    sheetId: null,

    qrReady: false,
  };

  function vibrate(ms=12){
    try{ if (navigator.vibrate) navigator.vibrate(ms); }catch(e){}
  }

  function uid(){
    try{ if (crypto && crypto.randomUUID) return crypto.randomUUID(); }catch(e){}
    return "id-" + Date.now().toString(36) + "-" + Math.random().toString(36).slice(2,9);
  }

  function loadJSON(key, fallback){
    try{
      const raw = localStorage.getItem(key);
      if (!raw) return fallback;
      return JSON.parse(raw);
    }catch(e){ return fallback; }
  }

  function saveJSON(key, value){
    localStorage.setItem(key, JSON.stringify(value));
  }

  function safeHex(v, fallback){
    const s = (v ?? "").toString().trim();
    return /^#([0-9a-fA-F]{6})$/.test(s) ? s : fallback;
  }

  function deepMerge(base, extra){
    if (Array.isArray(base)){
      return Array.isArray(extra) ? extra.slice() : base.slice();
    }
    if (typeof base !== "object" || base === null){
      return (extra === undefined) ? base : extra;
    }
    const out = { ...base };
    if (typeof extra !== "object" || extra === null) return out;
    for (const k of Object.keys(extra)){
      const bv = base[k];
      const ev = extra[k];
      out[k] = deepMerge(bv, ev);
    }
    return out;
  }

  function loadSettings(){
    const raw = loadJSON(SETTINGS_KEY, null);
    if (!raw || typeof raw !== "object"){
      return JSON.parse(JSON.stringify(DEFAULT_SETTINGS));
    }
    const merged = deepMerge(DEFAULT_SETTINGS, raw);
    // Ø¶Ù…Ø§Ù† Ù…ÙØ§ØªÙŠØ­ Ø£Ø³Ø§Ø³ÙŠØ©
    merged.theme = merged.theme || JSON.parse(JSON.stringify(DEFAULT_SETTINGS.theme));
    merged.branding = merged.branding || JSON.parse(JSON.stringify(DEFAULT_SETTINGS.branding));
    merged.defaults = merged.defaults || JSON.parse(JSON.stringify(DEFAULT_SETTINGS.defaults));
    merged.customCSS = (merged.customCSS ?? "").toString();
    return merged;
  }

  function applySettings(){
    const s = state.settings || DEFAULT_SETTINGS;
    const t = s.theme || DEFAULT_SETTINGS.theme;

    // CSS vars
    document.documentElement.style.setProperty("--bg", safeHex(t.bg, DEFAULT_SETTINGS.theme.bg));
    document.documentElement.style.setProperty("--text", safeHex(t.text, DEFAULT_SETTINGS.theme.text));
    document.documentElement.style.setProperty("--muted", safeHex(t.muted, DEFAULT_SETTINGS.theme.muted));
    document.documentElement.style.setProperty("--blue", safeHex(t.blue, DEFAULT_SETTINGS.theme.blue));
    document.documentElement.style.setProperty("--green", safeHex(t.green, DEFAULT_SETTINGS.theme.green));
    document.documentElement.style.setProperty("--red", safeHex(t.red, DEFAULT_SETTINGS.theme.red));
    document.documentElement.style.setProperty("--orange", safeHex(t.orange, DEFAULT_SETTINGS.theme.orange));
    document.documentElement.style.setProperty("--receipt", safeHex(t.receipt, DEFAULT_SETTINGS.theme.receipt));

    document.documentElement.style.setProperty("--panel", (t.panel || DEFAULT_SETTINGS.theme.panel));
    document.documentElement.style.setProperty("--border", (t.border || DEFAULT_SETTINGS.theme.border));

    // meta theme-color
    const meta = document.querySelector('meta[name="theme-color"]');
    if (meta) meta.setAttribute("content", safeHex(t.bg, DEFAULT_SETTINGS.theme.bg));

    // Branding
    const appName = (s.branding?.appName || DEFAULT_SETTINGS.branding.appName).toString().trim() || "NAS";
    const versionLabel = (s.branding?.versionLabel || DEFAULT_SETTINGS.branding.versionLabel).toString().trim();
    const igHandle = (s.branding?.instagramHandle || DEFAULT_SETTINGS.branding.instagramHandle).toString().trim().replace(/^@/,"");
    const igShown = igHandle ? ("@" + igHandle) : "@";

    if ($("appTitle")) $("appTitle").innerText = appName;
    if ($("appVersion")) $("appVersion").innerText = versionLabel || DEFAULT_SETTINGS.branding.versionLabel;
    if ($("receiptBrand")) $("receiptBrand").innerText = appName;

    if ($("receiptIG")) $("receiptIG").innerText = igShown;
    if ($("receiptIGHandle")) $("receiptIGHandle").innerText = (igHandle || "-").toUpperCase();

    // Custom CSS
    const cssNode = $("customStyle");
    if (cssNode) cssNode.textContent = (s.customCSS || "").toString();

    // title
    document.title = `${appName} | Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨Ø³Ø·Ø©`;
  }

  function fillSettingsForm(){
    if (!$("set-bg")) return;
    const s = state.settings || DEFAULT_SETTINGS;
    const t = s.theme || DEFAULT_SETTINGS.theme;

    $("set-bg").value = safeHex(t.bg, DEFAULT_SETTINGS.theme.bg);
    $("set-text").value = safeHex(t.text, DEFAULT_SETTINGS.theme.text);
    $("set-muted").value = safeHex(t.muted, DEFAULT_SETTINGS.theme.muted);
    $("set-blue").value = safeHex(t.blue, DEFAULT_SETTINGS.theme.blue);
    $("set-green").value = safeHex(t.green, DEFAULT_SETTINGS.theme.green);
    $("set-red").value = safeHex(t.red, DEFAULT_SETTINGS.theme.red);
    $("set-orange").value = safeHex(t.orange, DEFAULT_SETTINGS.theme.orange);
    $("set-receipt").value = safeHex(t.receipt, DEFAULT_SETTINGS.theme.receipt);

    $("set-panel").value = (t.panel || DEFAULT_SETTINGS.theme.panel);
    $("set-border").value = (t.border || DEFAULT_SETTINGS.theme.border);

    $("set-appName").value = (s.branding?.appName || DEFAULT_SETTINGS.branding.appName);
    $("set-versionLabel").value = (s.branding?.versionLabel || DEFAULT_SETTINGS.branding.versionLabel);
    $("set-igHandle").value = (s.branding?.instagramHandle || DEFAULT_SETTINGS.branding.instagramHandle).toString().replace(/^@/,"");
    $("set-igUrl").value = (s.branding?.instagramUrl || DEFAULT_SETTINGS.branding.instagramUrl);

    $("set-durationDefault").value = (s.defaults?.durationType || DEFAULT_SETTINGS.defaults.durationType);
    $("set-monthlyMode").value = (s.defaults?.monthlyMode || DEFAULT_SETTINGS.defaults.monthlyMode);
    $("set-yearlyMode").value = (s.defaults?.yearlyMode || DEFAULT_SETTINGS.defaults.yearlyMode);
    $("set-openReceiptDefault").checked = !!(s.defaults?.openReceiptAfterSave);

    $("set-customCSS").value = (s.customCSS || "");
  }

  function readSettingsForm(){
    const cur = state.settings || DEFAULT_SETTINGS;
    const out = JSON.parse(JSON.stringify(cur));

    out.theme = out.theme || {};
    out.branding = out.branding || {};
    out.defaults = out.defaults || {};

    out.theme.bg = safeHex($("set-bg").value, DEFAULT_SETTINGS.theme.bg);
    out.theme.text = safeHex($("set-text").value, DEFAULT_SETTINGS.theme.text);
    out.theme.muted = safeHex($("set-muted").value, DEFAULT_SETTINGS.theme.muted);
    out.theme.blue = safeHex($("set-blue").value, DEFAULT_SETTINGS.theme.blue);
    out.theme.green = safeHex($("set-green").value, DEFAULT_SETTINGS.theme.green);
    out.theme.red = safeHex($("set-red").value, DEFAULT_SETTINGS.theme.red);
    out.theme.orange = safeHex($("set-orange").value, DEFAULT_SETTINGS.theme.orange);
    out.theme.receipt = safeHex($("set-receipt").value, DEFAULT_SETTINGS.theme.receipt);

    out.theme.panel = ($("set-panel").value || "").trim() || DEFAULT_SETTINGS.theme.panel;
    out.theme.border = ($("set-border").value || "").trim() || DEFAULT_SETTINGS.theme.border;

    out.branding.appName = ($("set-appName").value || "").trim() || DEFAULT_SETTINGS.branding.appName;
    out.branding.versionLabel = ($("set-versionLabel").value || "").trim() || DEFAULT_SETTINGS.branding.versionLabel;

    out.branding.instagramHandle = ($("set-igHandle").value || "").trim().replace(/^@/,"") || DEFAULT_SETTINGS.branding.instagramHandle;
    out.branding.instagramUrl = ($("set-igUrl").value || "").trim() || DEFAULT_SETTINGS.branding.instagramUrl;

    out.defaults.durationType = ($("set-durationDefault").value || DEFAULT_SETTINGS.defaults.durationType);
    out.defaults.monthlyMode = ($("set-monthlyMode").value || DEFAULT_SETTINGS.defaults.monthlyMode);
    out.defaults.yearlyMode = ($("set-yearlyMode").value || DEFAULT_SETTINGS.defaults.yearlyMode);
    out.defaults.openReceiptAfterSave = !!$("set-openReceiptDefault").checked;

    out.customCSS = ($("set-customCSS").value || "").toString();

    return out;
  }

  function isoDateLocal(d = new Date()){
    const x = new Date(d.getTime() - d.getTimezoneOffset() * 60000);
    return x.toISOString().split("T")[0];
  }

  function parseISODate(iso){
    if (!iso || typeof iso !== "string") return null;
    const [y,m,dd] = iso.split("-").map(Number);
    if (!y || !m || !dd) return null;
    return new Date(y, m-1, dd);
  }

  function startOfDay(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }

  function daysLeft(endIso){
    const end = parseISODate(endIso);
    if (!end) return null;
    const t = startOfDay(new Date());
    const e = startOfDay(end);
    return Math.round((e - t) / (1000*60*60*24));
  }

  function addDaysToISO(baseIso, days){
    const base = parseISODate(baseIso) || new Date();
    base.setDate(base.getDate() + Number(days||0));
    return isoDateLocal(base);
  }

  // âœ… Ø´Ù‡Ø± ØªÙ‚ÙˆÙŠÙ… (ÙŠØ­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙˆÙ… Ù‚Ø¯Ø± Ø§Ù„Ø¥Ù…ÙƒØ§Ù† ÙˆÙŠÙ‚Øµ Ù„Ù„Ù€ Ø¢Ø®Ø± ÙŠÙˆÙ… Ø¥Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± Ù‚ØµÙŠØ±)
  function addMonthsToISO(baseIso, months){
    const base = parseISODate(baseIso) || new Date();
    const day = base.getDate();
    const d = new Date(base.getFullYear(), base.getMonth(), 1);
    d.setMonth(d.getMonth() + Number(months||0));
    const maxDay = new Date(d.getFullYear(), d.getMonth()+1, 0).getDate();
    d.setDate(Math.min(day, maxDay));
    return isoDateLocal(d);
  }

  function addYearsToISO(baseIso, years){
    return addMonthsToISO(baseIso, Number(years||0) * 12);
  }

  // âœ… ÙŠØ­Ø³Ø¨ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ø­Ø³Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯Ø§ØªÙƒ (Ø´Ù‡Ø± ØªÙ‚ÙˆÙŠÙ… Ø£Ùˆ 30 ÙŠÙˆÙ…)
  function calcEndFrom(baseIso, type){
    const base = baseIso || isoDateLocal(new Date());
    if (type === "Ø³Ù†ÙˆÙŠ"){
      const mode = state.settings?.defaults?.yearlyMode || DEFAULT_SETTINGS.defaults.yearlyMode;
      return mode === "365days" ? addDaysToISO(base, 365) : addYearsToISO(base, 1);
    }
    const mode = state.settings?.defaults?.monthlyMode || DEFAULT_SETTINGS.defaults.monthlyMode;
    return mode === "30days" ? addDaysToISO(base, 30) : addMonthsToISO(base, 1);
  }

  function formatMoney(n){ return (Number(n||0)).toLocaleString("en-US"); }

  function esc(s){
    return (s ?? "").toString().replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  function normalizePhone(phone){
    let p = (phone||"").toString().trim().replace(/[^\d]/g,"");
    if (p.startsWith("964")) p = p.slice(3);
    p = p.replace(/^0+/, "");
    return p;
  }

  function normalizeInsta(u){
    let s = (u||"").toString().trim();
    s = s.replace(/^https?:\/\/(www\.)?instagram\.com\//,"");
    s = s.replace(/^@/,"");
    s = s.split(/[/?#]/)[0];
    return s;
  }

  function instaUrl(user){
    const u = normalizeInsta(user);
    if (!u) return "#";
    return `https://instagram.com/${encodeURIComponent(u)}`;
  }

  function waUrl(phone, text){
    const p = normalizePhone(phone);
    if (!p) return "#";
    const base = `https://wa.me/964${p}`;
    return text ? `${base}?text=${encodeURIComponent(text)}` : base;
  }

  function toast(msg, kind="info"){
    const host = $("toastHost");
    const id = uid();
    const bg = kind==="ok" ? "bg-emerald-600"
             : kind==="warn" ? "bg-orange-600"
             : kind==="err" ? "bg-red-600"
             : "bg-slate-800";

    const el = document.createElement("div");
    el.id = id;
    el.className = `${bg} text-white p-4 rounded-2xl shadow-2xl border border-white/10`;
    el.innerHTML = `
      <div class="flex items-start justify-between gap-3">
        <p class="text-sm font-black leading-relaxed">${esc(msg)}</p>
        <button class="text-white/80 font-black" data-close-toast="${id}">âœ•</button>
      </div>
    `;
    host.appendChild(el);
    setTimeout(()=>{ const n=$(id); if(n) n.remove(); }, 2800);
  }

  function loadContactStore(){
    const today = isoDateLocal(new Date());
    const raw = loadJSON(CONTACT_KEY, null);

    if (Array.isArray(raw)){
      const obj = { date: today, keys: raw };
      saveJSON(CONTACT_KEY, obj);
      return obj;
    }

    if (raw && typeof raw === "object"){
      const date = raw.date || today;
      const keys = Array.isArray(raw.keys) ? raw.keys : [];
      return { date, keys };
    }

    const obj = { date: today, keys: [] };
    saveJSON(CONTACT_KEY, obj);
    return obj;
  }

  function saveContactStore(){ saveJSON(CONTACT_KEY, state.contacted); }

  function migrateClients(){
    let clients = loadJSON(DB, []);
    if (!Array.isArray(clients)) clients = [];

    const nowISO = new Date().toISOString();

    state.clients = clients.map((c) => {
      const obj = (c && typeof c==="object") ? c : {};
      const deleted = (typeof obj.deleted === "boolean") ? obj.deleted : !!obj.archived;
      return {
        ...obj,
        id: obj.id || obj.uuid || obj._id || uid(),
        name: (obj.name||"").toString(),
        phone: (obj.phone||"").toString(),
        insta: (obj.insta||"").toString(),
        service: (obj.service||"Canva Pro").toString(),
        price: Number(obj.price)||0,
        end: (obj.end||"").toString(),
        paid: (typeof obj.paid==="boolean") ? obj.paid : true,
        type: (obj.type||"Ø´Ù‡Ø±ÙŠ").toString(),
        created: (obj.created||obj.createdAt||nowISO).toString(),
        deleted,
        deletedAt: obj.deletedAt || obj.archivedAt || (deleted ? nowISO : null),
      };
    });

    saveJSON(DB, state.clients);
  }

  function migrateLedger(){
    let ledger = loadJSON(LEDGER_KEY, []);
    if (!Array.isArray(ledger)) ledger = [];

    if (ledger.length === 0 && state.clients.length){
      ledger = state.clients
        .filter(c => !c.deleted)
        .map(c => ({
          id: uid(),
          clientId: c.id,
          price: Number(c.price)||0,
          paid: !!c.paid,
          at: c.created || new Date().toISOString()
        }));
      saveJSON(LEDGER_KEY, ledger);
    }

    state.ledger = ledger;
  }

  function showSection(sec){
    ["home","add","list","settings"].forEach(s=>{
      $("sec-"+s).classList.add("hidden");
      $("btn-"+s).classList.remove("active");
    });
    $("sec-"+sec).classList.remove("hidden");
    $("btn-"+sec).classList.add("active");

    const box = $("sec-"+sec);
    box.classList.remove("section-enter"); void box.offsetWidth; box.classList.add("section-enter");
    state.sec = sec;

    if (sec==="home") updateHome();
    if (sec==="list") renderList();
    if (sec==="settings") fillSettingsForm();
  }

  function computeStats(){
    const now = new Date();
    const todayStr = isoDateLocal(now);
    const month = now.getMonth();
    const year = now.getFullYear();

    let dP=0,dD=0,mP=0,mD=0;

    state.clients
      .filter(c => !c.deleted)
      .forEach(c=>{
        const created = new Date(c.created || Date.now());
        const createdDay = isoDateLocal(created);

        if (createdDay === todayStr){
          if (c.paid) dP += Number(c.price)||0;
          else dD += Number(c.price)||0;
        }

        if (created.getMonth() === month && created.getFullYear() === year){
          if (c.paid) mP += Number(c.price)||0;
          else mD += Number(c.price)||0;
        }
      });

    const totalDebt = state.clients
      .filter(c => !c.deleted)
      .filter(c => !c.paid)
      .reduce((a,c)=>a+(Number(c.price)||0),0);

    let active=0, due7=0, expired=0;
    state.clients.filter(c=>!c.deleted).forEach(c=>{
      const dl = daysLeft(c.end);
      if (dl===null) return;
      if (dl>=0) active++;
      if (dl>=0 && dl<=7) due7++;
      if (dl<0) expired++;
    });

    return { dP,dD,mP,mD,totalDebt,active,due7,expired };
  }

  function updateHome(){
    $("todayLabel").innerText = new Date().toLocaleDateString("ar-IQ", { weekday:"long", year:"numeric", month:"long", day:"numeric" });

    const s = computeStats();
    $("d-paid").innerText = formatMoney(s.dP);
    $("d-debt").innerText = formatMoney(s.dD);
    $("m-paid").innerText = formatMoney(s.mP);
    $("m-debt").innerText = formatMoney(s.mD);

    $("k-active").innerText = s.active.toLocaleString("en-US");
    $("k-due7").innerText = s.due7.toLocaleString("en-US");
    $("k-expired").innerText = s.expired.toLocaleString("en-US");
    $("k-totalDebt").innerText = formatMoney(s.totalDebt);

    renderReminders();
  }

  function renderReminders(){
    const items = state.clients
      .filter(c => !c.deleted)
      .map(c => ({ c, dl: daysLeft(c.end) }))
      .filter(x => x.dl !== null && x.dl >= -1 && x.dl <= 1);

    function isContacted(c){
      const keyNew = `${c.id}|${c.end}`;
      const keyOld = `${c.name}${c.end}`;
      return state.contacted.keys.includes(keyNew) || state.contacted.keys.includes(keyOld);
    }

    const list = items
      .filter(x => !isContacted(x.c))
      .sort((a,b) => a.dl - b.dl);

    const box = $("reminder-list");
    if (!list.length){
      box.innerHTML = `<p class="text-center text-xs text-slate-500 font-black">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ°ÙƒÙŠØ±Ø§Øª ğŸ‰</p>`;
      return;
    }

    box.innerHTML = list.map(({c, dl})=>{
      const label =
        dl === 1 ? "Ø¨Ø§Ú†Ø± ÙŠÙ†ØªÙ‡ÙŠ" :
        dl === 0 ? "ÙŠÙ†ØªÙ‡ÙŠ Ø§Ù„ÙŠÙˆÙ…" :
        "Ø§Ù†ØªÙ‡Ù‰ Ø£Ù…Ø³";

      const border =
        dl <= 0 ? "border-red-500" : "border-orange-500";

      const msg =
        dl === 1 ? `Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ğŸ˜Š\nØ¨Ø§Ú†Ø± ÙŠØ®Ù„Øµ Ø§Ø´ØªØ±Ø§ÙƒÙƒ ${c.type} (${c.service}).\nØªØ­Ø¨ Ù†Ø¬Ø¯Ø¯ Ù„ÙƒØŸ` :
        dl === 0 ? `Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ğŸ˜Š\nØ§Ù„ÙŠÙˆÙ… ÙŠØ®Ù„Øµ Ø§Ø´ØªØ±Ø§ÙƒÙƒ ${c.type} (${c.service}).\nØªØ­Ø¨ Ù†Ø¬Ø¯Ø¯ Ù„ÙƒØŸ` :
        `Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ğŸ˜Š\nØ§Ù†ØªÙ‡Ù‰ Ø§Ø´ØªØ±Ø§ÙƒÙƒ Ø£Ù…Ø³ ${c.type} (${c.service}).\nØªØ­Ø¨ Ù†Ø¬Ø¯Ø¯ Ù„ÙƒØŸ`;

      return `
        <div class="mini flex items-center justify-between gap-3 border-r-4 ${border}">
          <div class="min-w-0">
            <p class="text-xs font-black truncate">${esc(c.name)}</p>
            <p class="text-[10px] text-slate-400 font-bold truncate">${esc(c.service)} â€¢ ${esc(label)} â€¢ ${esc(c.end)}</p>
          </div>
          <button class="chip" data-action="remind" data-id="${esc(c.id)}" data-msg="${esc(msg)}" data-haptic>ÙˆØ§ØªØ³Ø§Ø¨ ğŸ””</button>
        </div>
      `;
    }).join("");
  }

  function markContacted(c){
    const keyNew = `${c.id}|${c.end}`;
    if (!state.contacted.keys.includes(keyNew)){
      state.contacted.keys.push(keyNew);
      saveContactStore();
    }
  }

  function syncCustomServiceUI(){
    $("customServiceWrap").classList.toggle("hidden", $("service-select").value !== "CUSTOM");
  }

  function getServiceValue(){
    const sel = $("service-select").value;
    if (sel === "CUSTOM"){
      const v = $("service-custom").value.trim();
      return v || "Ø®Ø¯Ù…Ø© Ø£Ø®Ø±Ù‰";
    }
    return sel;
  }

  function setPaidState(paid){
    state.currentPaid = !!paid;
    $("p-true").classList.toggle("active", state.currentPaid);
    $("p-false").classList.toggle("active", !state.currentPaid);
  }

  // âœ… Ø¥ØµÙ„Ø§Ø­ Ø¬Ø°Ø±ÙŠ: Ù„Ø§ Ù†Ø³ØªØ®Ø¯Ù… expDate ÙƒÙ‚Ø§Ø¹Ø¯Ø© Ø­ØªÙ‰ Ù„Ø§ ÙŠØªØ±Ø§ÙƒÙ… Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…ØªÙƒØ±Ø±
  function setDuration(type, opts={}){
    const force = !!opts.force;
    const same = (type === state.currentType);

    state.currentType = type;
    $("durMon").classList.toggle("active", type==="Ø´Ù‡Ø±ÙŠ");
    $("durYear").classList.toggle("active", type==="Ø³Ù†ÙˆÙŠ");

    // Ø¥Ø°Ø§ Ø¶ØºØ· Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ø®ÙŠØ§Ø± Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ©: Ù„Ø§ ØªØºÙŠÙ‘Ø± Ø§Ù„ØªØ§Ø±ÙŠØ® (ÙŠØ¨Ù‚Ù‰ Ø«Ø§Ø¨Øª)
    if (!force && same) return;

    const anchor = state.expAnchorISO || isoDateLocal(new Date());
    $("expDate").value = calcEndFrom(anchor, type);
  }

  function clearForm(){
    state.editId = null;
    $("name").value = "";
    $("phone").value = "";
    $("price").value = "";
    $("insta").value = "";
    $("service-select").value = "Canva Pro";
    $("service-custom").value = "";
    syncCustomServiceUI();

    setPaidState(true);

    // anchor = Ø§Ù„ÙŠÙˆÙ… (Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø­Ø³Ø§Ø¨)
    state.expAnchorISO = isoDateLocal(new Date());

    const defType = state.settings?.defaults?.durationType || "Ø´Ù‡Ø±ÙŠ";
    setDuration(defType, {force:true});

    $("mainBtn").innerText = "ğŸ’¾ Ø­ÙØ¸";
  }

  function addLedgerEntry(price, paid, clientId=null){
    state.ledger.unshift({
      id: uid(),
      clientId,
      price: Number(price)||0,
      paid: !!paid,
      at: new Date().toISOString()
    });
    saveJSON(LEDGER_KEY, state.ledger);
  }

  function saveData(){
    const name = $("name").value.trim();
    const phone = normalizePhone($("phone").value);
    const insta = normalizeInsta($("insta").value);
    const price = Number($("price").value)||0;
    const service = getServiceValue();
    const end = $("expDate").value;

    if (!name || !end){
      toast("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù… ÙˆØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ *", "warn");
      vibrate(25);
      return;
    }

    if (state.editId){
      const idx = state.clients.findIndex(c => c.id === state.editId);
      if (idx === -1) return toast("ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø´ØªØ±Ùƒ.", "err");

      state.clients[idx] = {
        ...state.clients[idx],
        name, phone, insta, price, service, end,
        paid: state.currentPaid,
        type: state.currentType
      };

      saveJSON(DB, state.clients);
      addLedgerEntry(price, state.currentPaid, state.editId);

      toast("ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ âœ…", "ok");
      vibrate(12);

      if ($("openReceiptAfterSave").checked) openReceiptById(state.clients[idx].id);

      showSection("list");
      renderList();
      updateHome();
      return;
    }

    const client = {
      id: uid(),
      name, phone, insta, price, service, end,
      paid: state.currentPaid,
      type: state.currentType,
      created: new Date().toISOString(),
      deleted: false,
      deletedAt: null
    };

    state.clients.unshift(client);
    saveJSON(DB, state.clients);
    addLedgerEntry(client.price, client.paid, client.id);

    toast("ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…", "ok");
    vibrate(12);

    if ($("openReceiptAfterSave").checked) openReceiptById(client.id);

    clearForm();
    updateHome();
    showSection("home");
  }

  function editUser(id){
    const c = state.clients.find(x=>x.id===id);
    if (!c) return toast("Ø§Ù„Ù…Ø´ØªØ±Ùƒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.", "err");

    state.editId = c.id;
    $("name").value = c.name || "";
    $("phone").value = c.phone || "";
    $("price").value = c.price || "";
    $("insta").value = c.insta || "";
    $("expDate").value = c.end || isoDateLocal(new Date());

    const opts = [...$("service-select").options].map(o=>o.value);
    if (opts.includes(c.service)){
      $("service-select").value = c.service;
      $("service-custom").value = "";
    } else {
      $("service-select").value = "CUSTOM";
      $("service-custom").value = c.service || "";
    }
    syncCustomServiceUI();

    state.currentType = c.type || "Ø´Ù‡Ø±ÙŠ";
    $("durMon").classList.toggle("active", state.currentType==="Ø´Ù‡Ø±ÙŠ");
    $("durYear").classList.toggle("active", state.currentType==="Ø³Ù†ÙˆÙŠ");

    // anchor Ù„Ù„ØªØ¨Ø¯ÙŠÙ„ (Ø¥Ø°Ø§ Ø¨Ø¯Ù‘Ù„ Ø´Ù‡Ø±ÙŠ/Ø³Ù†ÙˆÙŠ) ÙŠÙƒÙˆÙ† Ù…Ù† Ø§Ù„ÙŠÙˆÙ…
    state.expAnchorISO = isoDateLocal(new Date());

    setPaidState(!!c.paid);

    $("mainBtn").innerText = "ğŸ”„ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„";
    showSection("add");
    vibrate(10);
  }

  function moveToTrash(id){
    const idx = state.clients.findIndex(c=>c.id===id);
    if (idx===-1) return;
    state.clients[idx].deleted = true;
    state.clients[idx].deletedAt = new Date().toISOString();
    saveJSON(DB, state.clients);
    toast("ØªÙ… Ø§Ù„Ù†Ù‚Ù„ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ù‡Ù…Ù„Ø§Øª âœ…", "ok");
    vibrate(12);
    renderList(); updateHome();
  }

  function restoreFromTrash(id){
    const idx = state.clients.findIndex(c=>c.id===id);
    if (idx===-1) return;
    state.clients[idx].deleted = false;
    state.clients[idx].deletedAt = null;
    saveJSON(DB, state.clients);
    toast("ØªÙ…Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© âœ…", "ok");
    vibrate(12);
    renderList(); updateHome();
  }

  function deleteForever(id){
    const idx = state.clients.findIndex(c=>c.id===id);
    if (idx===-1) return;
    const c = state.clients[idx];
    if (!c.deleted){
      toast("Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ ÙÙ‚Ø· Ù…Ù† Ø§Ù„Ø³Ù„Ø©.", "warn");
      vibrate(20);
      return;
    }
    if (!confirm("âš ï¸ Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹.")) return;
    state.clients.splice(idx,1);
    saveJSON(DB, state.clients);
    toast("ØªÙ… Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ âœ…", "ok");
    vibrate(20);
    renderList(); updateHome();
  }

  function endValue(c){ return c.end ? c.end : "9999-12-31"; }

  function syncTypeTabs(){
    const v = $("typeFilter").value;
    $("tabAll").classList.toggle("active", v === "Ø§Ù„ÙƒÙ„");
    $("tabMon").classList.toggle("active", v === "Ø´Ù‡Ø±ÙŠ");
    $("tabYear").classList.toggle("active", v === "Ø³Ù†ÙˆÙŠ");
  }

  function renderList(){
    const q = ($("search").value||"").toLowerCase().trim();
    const typeFilter = $("typeFilter").value;
    const statusFilter = $("statusFilter").value;
    const sortMode = $("sortMode").value;

    syncTypeTabs();

    let arr = state.clients.slice();

    if (statusFilter === "trash") arr = arr.filter(c=>!!c.deleted);
    else arr = arr.filter(c=>!c.deleted);

    if (typeFilter !== "Ø§Ù„ÙƒÙ„") arr = arr.filter(c => (c.type||"Ø´Ù‡Ø±ÙŠ") === typeFilter);

    if (statusFilter !== "all" && statusFilter !== "trash"){
      arr = arr.filter(c=>{
        const dl = daysLeft(c.end);
        if (dl === null) return false;
        if (statusFilter==="paid") return !!c.paid;
        if (statusFilter==="debt") return !c.paid;
        if (statusFilter==="due7") return dl>=0 && dl<=7;
        if (statusFilter==="expired") return dl<0;
        return true;
      });
    }

    if (q){
      arr = arr.filter(c=>{
        const hay = `${c.name||""} ${c.phone||""} ${c.service||""} ${c.insta||""}`.toLowerCase();
        return hay.includes(q);
      });
    }

    if (sortMode==="endAsc") arr.sort((a,b)=>endValue(a).localeCompare(endValue(b)));
    if (sortMode==="endDesc") arr.sort((a,b)=>endValue(b).localeCompare(endValue(a)));
    if (sortMode==="name") arr.sort((a,b)=>(a.name||"").localeCompare((b.name||""),"ar"));

    $("listCount").innerText = arr.length.toLocaleString("en-US");

    const box = $("main-list");
    if (!arr.length){
      box.innerHTML = `<div class="glass p-6 rounded-[2.5rem] text-center">
        <p class="text-sm font-black text-slate-200">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</p>
      </div>`;
      return;
    }

    box.innerHTML = arr.map(c=>{
      const dl = daysLeft(c.end);
      const border = dl===null ? "border-slate-600"
                  : dl<0 ? "border-red-600"
                  : (!c.paid ? "border-red-400" : (dl<=7 ? "border-orange-500" : "border-green-500"));

      const statusText = c.deleted ? "ğŸ—‘ï¸ Ø³Ù„Ø©" : (dl<0 ? "âš ï¸ Ù…Ù†ØªÙ‡ÙŠ" : (dl<=7 ? "â³ Ù‚Ø±ÙŠØ¨" : "âœ… ÙØ¹Ù‘Ø§Ù„"));
      const statusClass = dl<0 ? "text-red-200" : (dl<=7 ? "text-orange-200" : "text-emerald-200");

      const paidText = c.paid ? "âœ… Ù…Ø¯ÙÙˆØ¹" : "âŒ ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹";
      const paidClass = c.paid ? "text-emerald-200" : "text-red-200";

      const typeText = (c.type||"Ø´Ù‡Ø±ÙŠ") === "Ø³Ù†ÙˆÙŠ" ? "ğŸŒŸ Ø³Ù†ÙˆÙŠ" : "ğŸ“… Ø´Ù‡Ø±ÙŠ";
      const typeClass = (c.type||"Ø´Ù‡Ø±ÙŠ") === "Ø³Ù†ÙˆÙŠ" ? "text-blue-200" : "text-slate-200";

      const phoneOk = !!normalizePhone(c.phone);
      const instaOk = !!normalizeInsta(c.insta);

      const wa = phoneOk ? waUrl(c.phone) : "#";
      const ig = instaOk ? instaUrl(c.insta) : "#";

      return `
        <div class="glass p-4 rounded-[2.5rem] border-r-4 ${border}">
          <div class="flex items-start justify-between gap-3">
            <div class="min-w-0">
              <p class="text-sm font-black truncate">${esc(c.name)}</p>
              <p class="text-[10px] text-blue-300 font-black truncate">${esc(c.service)} â€¢ ${formatMoney(c.price)} Ø¯.Ø¹</p>
              <p class="text-[10px] text-slate-400 font-bold mt-1">ÙŠÙ†ØªÙ‡ÙŠ: ${esc(c.end||"-")}</p>

              <div class="flex flex-wrap gap-2 mt-2">
                <span class="badge ${paidClass}">${paidText}</span>
                <span class="badge ${typeClass}">${typeText}</span>
                <span class="badge ${statusClass}">${statusText}</span>
              </div>
            </div>

            <div class="flex flex-col gap-2 items-end">
              <div class="flex gap-2">
                <a href="${wa}" target="_blank" rel="noopener"
                   class="icon-btn bg-emerald-600/90"
                   title="${phoneOk ? "ÙˆØ§ØªØ³Ø§Ø¨" : "Ø£Ø¶Ù Ø±Ù‚Ù… Ù‡Ø§ØªÙ"}"
                   ${phoneOk ? "" : 'onclick="return false;" style="opacity:.40; cursor:not-allowed;"'}
                   data-haptic>
                  <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
                    <path fill="#fff" d="M12 2a10 10 0 0 0-8.6 15.1L2 22l5-1.3A10 10 0 1 0 12 2zm0 18a8 8 0 0 1-4.1-1.1l-.3-.2-2.9.7.8-2.8-.2-.3A8 8 0 1 1 12 20zm4.4-5.6c-.2-.1-1.2-.6-1.4-.7-.2-.1-.3-.1-.5.1l-.6.7c-.1.2-.2.2-.4.1-1.2-.6-2-1.1-2.8-2.5-.2-.2 0-.4.1-.5l.4-.5c.1-.1.1-.2.2-.4.1-.1 0-.3 0-.4l-.7-1.6c-.2-.4-.4-.3-.5-.3h-.4c-.1 0-.4.1-.6.3-.2.2-.8.7-.8 1.8s.8 2.1.9 2.2c.1.1 1.6 2.5 3.9 3.5.5.2.9.4 1.2.5.5.1.9.1 1.2.1.4-.1 1.2-.5 1.4-1 .2-.5.2-.9.1-1z"/>
                  </svg>
                </a>

                <a href="${ig}" target="_blank" rel="noopener"
                   class="icon-btn bg-pink-600/90"
                   title="${instaOk ? "Ø§Ù†Ø³ØªØºØ±Ø§Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†" : "Ø£Ø¶Ù ÙŠÙˆØ²Ø± Ø§Ù†Ø³ØªØºØ±Ø§Ù…"}"
                   ${instaOk ? "" : 'onclick="return false;" style="opacity:.40; cursor:not-allowed;"'}
                   data-haptic>
                  <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
                    <path fill="#fff" d="M7 2h10a5 5 0 0 1 5 5v10a5 5 0 0 1-5 5H7a5 5 0 0 1-5-5V7a5 5 0 0 1 5-5zm10 2H7a3 3 0 0 0-3 3v10a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3V7a3 3 0 0 0-3-3zm-5 4a5 5 0 1 1 0 10a5 5 0 0 1 0-10zm0 2a3 3 0 1 0 0 6a3 3 0 0 0 0-6zm5.25-2.1a1.1 1.1 0 1 1 0 2.2a1.1 1.1 0 0 1 0-2.2z"/>
                  </svg>
                </a>
              </div>

              <button class="chip !px-3 !py-2" data-action="receipt" data-id="${esc(c.id)}" data-haptic>ÙˆØµÙ„</button>
              <button class="chip !px-3 !py-2" data-action="more" data-id="${esc(c.id)}" data-haptic>â‹¯</button>
            </div>
          </div>
        </div>
      `;
    }).join("");
  }

  function openSheet(id){
    state.sheetId = id;
    const c = state.clients.find(x=>x.id===id);
    if (!c) return;

    $("sheetTitle").innerText = c.name || "-";
    $("sheetSub").innerText = `${c.service||"-"} â€¢ ${formatMoney(c.price)} Ø¯.Ø¹ â€¢ ÙŠÙ†ØªÙ‡ÙŠ: ${c.end||"-"}`;

    $("sheetTrashOrRestore").innerText = c.deleted ? "Ø§Ø³ØªØ¹Ø§Ø¯Ø© âœ…" : "ğŸ—‘ï¸ Ø­Ø°Ù";
    $("sheetDeleteForever").classList.toggle("hidden", !c.deleted);

    $("sheet").classList.remove("hidden");
    vibrate(10);
  }

  function closeSheet(){
    $("sheet").classList.add("hidden");
    state.sheetId = null;
  }

  function toggleType(id){
    const idx = state.clients.findIndex(c=>c.id===id);
    if (idx===-1) return;
    const cur = state.clients[idx].type || "Ø´Ù‡Ø±ÙŠ";
    state.clients[idx].type = (cur==="Ø³Ù†ÙˆÙŠ") ? "Ø´Ù‡Ø±ÙŠ" : "Ø³Ù†ÙˆÙŠ";
    saveJSON(DB, state.clients);
    toast(`ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ù†ÙˆØ¹ Ø¥Ù„Ù‰: ${state.clients[idx].type}`, "ok");
    vibrate(12);
    renderList(); updateHome();
  }

  function renderOurQR(){
    state.qrReady = false;

    const qrBox = $("qrBox");
    const fallback = $("qrFallback");
    qrBox.innerHTML = "";
    fallback.classList.add("hidden");

    const qrUrl = (state.settings?.branding?.instagramUrl || DEFAULT_SETTINGS.branding.instagramUrl).toString().trim();

    let tries = 0;
    function tryMake(){
      tries++;
      qrBox.innerHTML = "";
      try{
        if (typeof QRCode === "undefined") throw new Error("QRCode lib missing");
        new QRCode(qrBox, {
          text: qrUrl,
          width: 92,
          height: 92,
          correctLevel: QRCode.CorrectLevel.M
        });
        state.qrReady = true;
      }catch(e){
        if (tries < 4){
          setTimeout(tryMake, 80);
        }else{
          fallback.classList.remove("hidden");
          state.qrReady = false;
        }
      }
    }
    tryMake();
  }

  function openReceiptById(id){
    const c = state.clients.find(x=>x.id===id);
    if (!c) return toast("Ø§Ù„Ù…Ø´ØªØ±Ùƒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.", "err");

    $("rName").innerText = c.name || "-";
    $("rService").innerText = c.service || "-";
    $("rPrice").innerText = formatMoney(c.price) + " Ø¯.Ø¹";
    $("rPaid").innerText = c.paid ? "Ù…Ø¯ÙÙˆØ¹ âœ…" : "ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹ âŒ";
    $("rEnd").innerText = c.end || "-";

    $("receiptModal").classList.remove("hidden");
    vibrate(10);

    requestAnimationFrame(() => {
      renderOurQR();
      setTimeout(renderOurQR, 120);
    });
  }

  async function shareReceipt(){
    try{
      if (!state.qrReady){
        await new Promise(r=>setTimeout(r, 180));
      }

      const bg = getComputedStyle(document.documentElement).getPropertyValue("--receipt").trim() || "#f6f7fb";
      const canvas = await html2canvas($("printableReceipt"), { scale: 3, backgroundColor: bg });

      canvas.toBlob(blob=>{
        const file = new File([blob], "NAS_Receipt.png", {type:"image/png"});
        if (navigator.canShare && navigator.canShare({files:[file]})){
          navigator.share({files:[file], title:"NAS Receipt"});
        }else{
          const a=document.createElement("a");
          a.download="NAS_Receipt.png";
          a.href=canvas.toDataURL("image/png");
          a.click();
        }
      });
      vibrate(10);
    }catch(e){
      toast("ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ ØµÙˆØ±Ø© Ø§Ù„ÙˆØµÙ„.", "err");
      vibrate(20);
    }
  }

  function updateRenewHeader(){
    const c = state.clients.find(x=>x.id===state.renewId);
    if (!c) return;
    $("renewService").innerText = `${c.service||"-"} â€¢ (Ø§Ù„ØªØ¬Ø¯ÙŠØ¯: ${state.renewType})`;
  }

  function setRenewDuration(type, opts={}){
    const force = !!opts.force;
    const same = (type === state.renewType);

    state.renewType = type;
    $("renewMon").classList.toggle("active", type==="Ø´Ù‡Ø±ÙŠ");
    $("renewYear").classList.toggle("active", type==="Ø³Ù†ÙˆÙŠ");

    if (!force && same) return;

    const anchor = state.renewAnchorISO || isoDateLocal(new Date());
    $("renewEnd").value = calcEndFrom(anchor, type);
    updateRenewHeader();
  }

  function openRenewModal(id){
    const c = state.clients.find(x=>x.id===id);
    if (!c) return;

    state.renewId = id;
    $("renewName").innerText = c.name || "-";

    const today = isoDateLocal(new Date());
    // Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„ØªØ¬Ø¯ÙŠØ¯: Ø¥Ø°Ø§ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø¨Ø¹Ø¯Ù‡ ÙØ¹Ù‘Ø§Ù„ Ù†Ø¬Ø¯Ø¯ Ù…Ù† ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ØŒ Ø¥Ø°Ø§ Ù…Ù†ØªÙ‡ÙŠ Ù†Ø¬Ø¯Ø¯ Ù…Ù† Ø§Ù„ÙŠÙˆÙ…
    state.renewAnchorISO = (c.end && c.end >= today) ? c.end : today;

    // Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø§Ù„ØªØ¬Ø¯ÙŠØ¯ Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø´ØªØ±Ùƒ
    const type = (c.type === "Ø³Ù†ÙˆÙŠ") ? "Ø³Ù†ÙˆÙŠ" : "Ø´Ù‡Ø±ÙŠ";
    setRenewDuration(type, {force:true});

    // Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹
    state.renewPaid = true;
    $("renewPaidBtn").classList.add("active");
    $("renewDebtBtn").classList.remove("active");

    $("renewPrice").value = Number(c.price)||0;

    $("renewModal").classList.remove("hidden");
    vibrate(10);
  }

  function confirmRenew(){
    const c = state.clients.find(x=>x.id===state.renewId);
    if (!c) return;

    const newEnd = $("renewEnd").value;
    const price = Number($("renewPrice").value)||0;
    if (!newEnd){
      toast("Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ® ØµØ­ÙŠØ­.", "warn");
      vibrate(20);
      return;
    }

    c.end = newEnd;
    c.price = price;
    c.paid = state.renewPaid;

    saveJSON(DB, state.clients);
    addLedgerEntry(price, c.paid, c.id);

    toast("ØªÙ… Ø§Ù„ØªØ¬Ø¯ÙŠØ¯ âœ…", "ok");
    vibrate(12);

    $("renewModal").classList.add("hidden");
    renderList(); updateHome();
  }

  // ===== Settings helpers =====
  function applySettingsFromUI(persist){
    state.settings = readSettingsForm();
    applySettings();

    // ØªØ­Ø¯ÙŠØ« Ø§ÙØªØ±Ø§Ø¶ÙŠ ÙØªØ­ Ø§Ù„ÙˆØµÙ„
    $("openReceiptAfterSave").checked = !!(state.settings?.defaults?.openReceiptAfterSave);

    if (persist){
      saveJSON(SETTINGS_KEY, state.settings);
      toast("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª âœ…", "ok");
    } else {
      toast("ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ø¯ÙˆÙ† Ø­ÙØ¸ âœ…", "ok");
    }
  }

  function resetSettings(){
    state.settings = JSON.parse(JSON.stringify(DEFAULT_SETTINGS));
    saveJSON(SETTINGS_KEY, state.settings);
    applySettings();
    fillSettingsForm();
    $("openReceiptAfterSave").checked = !!(state.settings.defaults.openReceiptAfterSave);
    toast("ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ âœ…", "ok");
  }

  function exportBackup(){
    const backup = {
      app: "NAS",
      schema: 1,
      exportedAt: new Date().toISOString(),
      settings: state.settings,
      clients: state.clients,
      ledger: state.ledger,
      contacted: state.contacted,
    };
    const txt = JSON.stringify(backup, null, 2);
    $("backupBox").value = txt;

    if (navigator.clipboard && navigator.clipboard.writeText){
      navigator.clipboard.writeText(txt)
        .then(()=>toast("ØªÙ… ØªØµØ¯ÙŠØ± ÙˆÙ†Ø³Ø® Ø§Ù„Ù†Ø³Ø®Ø© âœ…", "ok"))
        .catch(()=>toast("ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ±ØŒ Ø§Ù†Ø³Ø®Ù‡Ø§ ÙŠØ¯ÙˆÙŠÙ‹Ø§.", "warn"));
    } else {
      toast("ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ±ØŒ Ø§Ù†Ø³Ø®Ù‡Ø§ ÙŠØ¯ÙˆÙŠÙ‹Ø§.", "warn");
    }
  }

  function importBackup(){
    const txt = ($("backupBox").value || "").trim();
    if (!txt){
      toast("Ø§Ù„ØµÙ‚ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹.", "warn");
      return;
    }
    let obj = null;
    try{ obj = JSON.parse(txt); }catch(e){
      toast("JSON ØºÙŠØ± ØµØ§Ù„Ø­.", "err");
      return;
    }
    if (!obj || typeof obj !== "object"){
      toast("Ù†Ø³Ø®Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø©.", "err");
      return;
    }

    // settings
    if (obj.settings && typeof obj.settings === "object"){
      state.settings = deepMerge(DEFAULT_SETTINGS, obj.settings);
      saveJSON(SETTINGS_KEY, state.settings);
      applySettings();
      fillSettingsForm();
      $("openReceiptAfterSave").checked = !!(state.settings.defaults.openReceiptAfterSave);
    }

    // data
    if (Array.isArray(obj.clients)) saveJSON(DB, obj.clients);
    if (Array.isArray(obj.ledger)) saveJSON(LEDGER_KEY, obj.ledger);
    if (obj.contacted && typeof obj.contacted === "object") saveJSON(CONTACT_KEY, obj.contacted);

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù„Ù„Ù‡ÙŠÙƒÙ„Ø©
    migrateClients();
    migrateLedger();
    state.contacted = loadContactStore();

    toast("ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ âœ…", "ok");
    renderList(); updateHome();
  }

  function clearAllData(){
    if (!confirm("âš ï¸ Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† + Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª + Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª) Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²ØŸ")) return;
    localStorage.removeItem(DB);
    localStorage.removeItem(LEDGER_KEY);
    localStorage.removeItem(CONTACT_KEY);
    localStorage.removeItem(SETTINGS_KEY);
    toast("ØªÙ… Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„ âœ… (Ø³ÙŠØ¹Ø§Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©)", "warn");
    setTimeout(()=>location.reload(), 600);
  }

  function bindEvents(){
    $("topNav").addEventListener("click", (e)=>{
      const b = e.target.closest("[data-sec]");
      if (!b) return;
      showSection(b.dataset.sec);
      vibrate(8);
    });

    $("goListFromHome").addEventListener("click", ()=> { showSection("list"); vibrate(8); });

    $("service-select").addEventListener("change", ()=> { syncCustomServiceUI(); vibrate(6); });

    // âœ… Ø´Ù‡Ø±ÙŠ/Ø³Ù†ÙˆÙŠ (Ø«Ø§Ø¨Øª + Ø´Ù‡Ø± ØªÙ‚ÙˆÙŠÙ…)
    $("durMon").addEventListener("click", ()=> setDuration("Ø´Ù‡Ø±ÙŠ"));
    $("durYear").addEventListener("click", ()=> setDuration("Ø³Ù†ÙˆÙŠ"));

    $("p-true").addEventListener("click", ()=> setPaidState(true));
    $("p-false").addEventListener("click", ()=> setPaidState(false));

    $("resetFormBtn").addEventListener("click", ()=> { clearForm(); toast("ØªÙ… Ø§Ù„ØªÙØ±ÙŠØº âœ…","ok"); vibrate(10); });
    $("mainBtn").addEventListener("click", saveData);

    $("search").addEventListener("input", renderList);
    $("typeFilter").addEventListener("change", ()=>{ renderList(); vibrate(6); });
    $("statusFilter").addEventListener("change", ()=>{ renderList(); vibrate(6); });
    $("sortMode").addEventListener("change", ()=>{ renderList(); vibrate(6); });

    $("typeTabs").addEventListener("click", (e)=>{
      const btn = e.target.closest("[data-type-tab]");
      if (!btn) return;
      const v = btn.dataset.typeTab;
      $("typeFilter").value = v;
      syncTypeTabs();
      renderList();
      vibrate(10);
    });

    $("reminder-list").addEventListener("click", (e)=>{
      const b = e.target.closest("[data-action='remind']");
      if (!b) return;

      const c = state.clients.find(x=>x.id===b.dataset.id);
      if (!c) return;

      const msg = b.dataset.msg || "Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ğŸ˜Š";
      const link = waUrl(c.phone, msg);
      if (link==="#"){
        toast("Ø£Ø¶Ù Ø±Ù‚Ù… ØµØ­ÙŠØ­ Ø£ÙˆÙ„Ø§Ù‹.", "warn");
        vibrate(20);
        return;
      }

      vibrate(10);
      const w = window.open(link, "_blank");
      if (!w) window.location.href = link;

      markContacted(c);
      toast("ØªÙ… ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ âœ…", "ok");
      renderReminders();
    });

    $("main-list").addEventListener("click", (e)=>{
      const a = e.target.closest("[data-action]");
      if (!a) return;
      const id = a.dataset.id;

      if (a.dataset.action === "receipt") return openReceiptById(id);
      if (a.dataset.action === "more") return openSheet(id);
    });

    $("closeReceiptBtn").addEventListener("click", ()=> { $("receiptModal").classList.add("hidden"); vibrate(8); });
    $("shareReceiptBtn").addEventListener("click", shareReceipt);
    $("receiptModal").addEventListener("click", (e)=> { if (e.target === $("receiptModal")) { $("receiptModal").classList.add("hidden"); vibrate(8); } });

    $("closeRenewBtn").addEventListener("click", ()=> { $("renewModal").classList.add("hidden"); vibrate(8); });
    $("renewModal").addEventListener("click", (e)=> { if (e.target === $("renewModal")) { $("renewModal").classList.add("hidden"); vibrate(8); } });

    // âœ… ØªØ¬Ø¯ÙŠØ¯ Ø´Ù‡Ø±ÙŠ/Ø³Ù†ÙˆÙŠ (Ø«Ø§Ø¨Øª + ÙŠØ¹ØªÙ…Ø¯ Ø´Ù‡Ø± ØªÙ‚ÙˆÙŠÙ… Ø­Ø³Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª)
    $("renewMon").addEventListener("click", ()=>{ setRenewDuration("Ø´Ù‡Ø±ÙŠ"); vibrate(8); });
    $("renewYear").addEventListener("click", ()=>{ setRenewDuration("Ø³Ù†ÙˆÙŠ"); vibrate(8); });

    $("renewPaidBtn").addEventListener("click", ()=>{
      state.renewPaid = true;
      $("renewPaidBtn").classList.add("active");
      $("renewDebtBtn").classList.remove("active");
      vibrate(8);
    });

    $("renewDebtBtn").addEventListener("click", ()=>{
      state.renewPaid = false;
      $("renewDebtBtn").classList.add("active");
      $("renewPaidBtn").classList.remove("active");
      vibrate(8);
    });

    $("confirmRenewBtn").addEventListener("click", confirmRenew);

    $("sheetBackdrop").addEventListener("click", closeSheet);
    $("closeSheetBtn").addEventListener("click", closeSheet);

    $("sheetEdit").addEventListener("click", ()=>{ const id = state.sheetId; closeSheet(); editUser(id); });
    $("sheetRenew").addEventListener("click", ()=>{ const id = state.sheetId; closeSheet(); openRenewModal(id); });
    $("sheetToggleType").addEventListener("click", ()=>{ const id = state.sheetId; closeSheet(); toggleType(id); });

    $("sheetTrashOrRestore").addEventListener("click", ()=>{
      const id = state.sheetId;
      const c = state.clients.find(x=>x.id===id);
      if (!c) return;
      closeSheet();
      if (c.deleted) restoreFromTrash(id);
      else moveToTrash(id);
    });

    $("sheetDeleteForever").addEventListener("click", ()=>{
      const id = state.sheetId;
      closeSheet();
      deleteForever(id);
    });

    $("toastHost").addEventListener("click", (e)=>{
      const b = e.target.closest("[data-close-toast]");
      if (!b) return;
      const node = $(b.dataset.closeToast);
      if (node) node.remove();
    });

    // âœ… Settings events
    $("saveSettingsBtn").addEventListener("click", ()=>{ applySettingsFromUI(true); vibrate(10); });
    $("applySettingsBtn").addEventListener("click", ()=>{ applySettingsFromUI(false); vibrate(10); });
    $("resetSettingsBtn").addEventListener("click", ()=>{ resetSettings(); vibrate(10); });

    $("exportBackupBtn").addEventListener("click", ()=>{ exportBackup(); vibrate(10); });
    $("importBackupBtn").addEventListener("click", ()=>{ importBackup(); vibrate(10); });
    $("clearAllBtn").addEventListener("click", ()=>{ clearAllData(); vibrate(12); });

    document.addEventListener("click", (e)=>{
      if (e.target.closest("[data-haptic]")) vibrate(8);
    }, { capture: true });

    document.addEventListener("keydown", (e)=>{
      if (e.key !== "Escape") return;
      $("receiptModal").classList.add("hidden");
      $("renewModal").classList.add("hidden");
      closeSheet();
      vibrate(8);
    });
  }

  function init(){
    // settings
    state.settings = loadSettings();
    applySettings();

    // data
    migrateClients();
    migrateLedger();
    state.contacted = loadContactStore();

    // defaults
    $("openReceiptAfterSave").checked = !!(state.settings?.defaults?.openReceiptAfterSave);

    // form
    clearForm();

    bindEvents();
    updateHome();
    showSection("home");
  }

  init();
</script>

</body>
</html>
